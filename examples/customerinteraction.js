import OptaveJavaScriptSDK from '../src/main.js';

const optaveClient = new OptaveJavaScriptSDK({
    websocketUrl: process.env.OPTAVE__WEBSOCKET_URL,

    // These parameters are only required when using the authenticate() function.
    // In some cases, the authentication token can be obtained manually or through
    // another process, which makes the authenticate() call unnecessary. In this
    // case, only the openConnection function has to be called, passing the existing token value
    authenticationUrl: process.env.OPTAVE__AUTHENTICATION_URL,
    clientId: process.env.OPTAVE__CLIENT_ID,
    clientSecret: process.env.OPTAVE__CLIENT_SECRET,
});

async function run() {
    // Listen for messages from the WebSocket
    optaveClient.on('message', payload => {
        const message = JSON.parse(payload);
        const { actionType, state, action } = message;
    
        console.log(`Action: ${action} / State: ${state} / Action Type: ${actionType}`);
    });
    
    // Handle errors
    optaveClient.on('error', error => {
        if (typeof error === 'string') {
            console.error(error);
        } else {
            console.error('Error', error);
        }
    })
    
    // After the connection is opened, send a customerinteraction message
    optaveClient.once('open', () => {
        optaveClient.customerInteraction({
            session: {
                session_id: "a1b2c3e6-e5f6-7890-1234-56789abcdef0",
                channel: {
                    medium: "chat", // options: "chat", "voice", "email"
                    section: "support_page",
                    language: "en-US",
                    location: "40.7128,-74.0060", // GPS coordinates
                    device_info: "iOS/18.2, iPhone15,3",
                    device_type: "mobile",
                    browser: "Safari 17.0"
                },
                interface: {
                    app_version: "2.1.0",
                    type: "custom_components",
                    category: "crm",
                    name: "my_support_app",
                    language: "en-US"
                },
                network: {
                    latency_ms: 120
                }
            },
            request: {
                request_id: "a1b2c3d4-e5f6-7890-1234-56789ab2345",
                context: { // generated by optave
                    tenant_id: "a1b2c3d4-e5f6-7890-1234-56789abcdef0", // REQUIRED
                    organization_id: "f7e8d9c0-b1a2-3456-7890-123456789abc", // REQUIRED
                },
                connections: {
                    thread_id: "9e8d7c6b-5a49-3827-1605-948372615abc" // REQUIRED
                },
                attributes: {
                    variant: "A"
                },
                scope: {
                    conversations: [ // REQUIRED
                        {
                            timestamp: "2024-01-15T10:30:00.000Z",
                            participant_id: "2c4f8a9b-1d3e-5f70-8293-456789012def", //sent by the client - optional
                            role: "EndUser",
                            display_name: "John Doe",
                            content: "Hi, can you help me?",
                        },
                        {
                            timestamp: "2024-01-15T10:30:15.000Z",
                            participant_id: "5b8c9d0e-2f4a-6b1c-9d8e-123456789xyz",
                            role: "Agent",
                            display_name: "Sarah Smith",
                            content: "Hello! I'd be happy to assist you today. What can I help you with?",
                        }
                    ],
                    interactions: [
                        {
                            timestamp: "2024-01-15T10:29:45.000Z",
                            id: "1",
                            role: "System",
                            name: "ticket_created",
                            content: "Support ticket T12345 has been created for user John Doe"
                        }
                    ]
                },
                settings: {
                    disable_search: false,
                    disable_stream: false,
                    disable_sources: false,
                    disable_tools: false,
                    disable_browsing: false,
                    max_response_length: 2000,
                    output_language: "en-US"
                }
            }
        });
    });

    const token = await optaveClient.authenticate();
    optaveClient.openConnection(token);
}

run();