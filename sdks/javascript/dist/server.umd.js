!function webpackUniversalModuleDefinition(root,factory){"object"==typeof exports&&"object"==typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("OptaveJavaScriptSDK",[],factory):"object"==typeof exports?exports.OptaveJavaScriptSDK=factory():root.OptaveJavaScriptSDK=factory()}(function(){return"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:this}(),()=>(()=>{var e={31:(e,t,s)=>{s.d(t,{I:()=>n});class r{constructor(e){if(this.params=new Map,"string"==typeof e){const t=undefined;e.replace(/^\?/,"").split("&").forEach(e=>{if(e){const[t,s]=e.split("=");t&&this.params.set(decodeURIComponent(t),decodeURIComponent(s||""))}})}else e&&"object"==typeof e&&(e instanceof Map?e.forEach((e,t)=>{this.params.set(t,String(e))}):Array.isArray(e)?e.forEach(([e,t])=>{this.params.set(e,String(t))}):Object.entries(e).forEach(([e,t])=>{this.params.set(e,String(t))}))}append(e,t){const s=this.params.get(e);void 0!==s?this.params.set(e,s+","+String(t)):this.params.set(e,String(t))}delete(e){this.params.delete(e)}get(e){return this.params.get(e)||null}getAll(e){const t=this.params.get(e);return t?t.split(","):[]}has(e){return this.params.has(e)}set(e,t){this.params.set(e,String(t))}toString(){const e=[];return this.params.forEach((t,s)=>{const r=undefined;t.split(",").forEach(t=>{e.push(`${encodeURIComponent(s)}=${encodeURIComponent(t)}`)})}),e.join("&")}*[Symbol.iterator](){for(const[e,t]of this.params){const s=t.split(",");for(const t of s)yield[e,t]}}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*entries(){yield*this}forEach(e,t){for(const[s,r]of this)e.call(t,r,s,this)}}const n="undefined"!=typeof globalThis&&globalThis.URLSearchParams||"undefined"!=typeof window&&window.URLSearchParams||r},46:e=>{var t="object"==typeof Reflect?Reflect:null,s=t&&"function"==typeof t.apply?t.apply:function e(t,s,r){return Function.prototype.apply.call(t,s,r)},r;function n(e){console&&console.warn&&console.warn(e)}r=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function e(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function e(t){return Object.getOwnPropertyNames(t)};var o=Number.isNaN||function e(t){return t!=t};function i(){i.init.call(this)}e.exports=i,e.exports.once=v,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var a=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function d(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function u(e,t,s,r){var o,i,a;if(c(s),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),i=e._events),a=i[t]),void 0===a)a=i[t]=s,++e._eventsCount;else if("function"==typeof a?a=i[t]=r?[s,a]:[a,s]:r?a.unshift(s):a.push(s),(o=d(e))>0&&a.length>o&&!a.warned){a.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=a.length,n(u)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,s){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:s},n=l.bind(r);return n.listener=s,r.wrapFn=n,n}function h(e,t,s){var r=e._events;if(void 0===r)return[];var n=r[t];return void 0===n?[]:"function"==typeof n?s?[n.listener||n]:[n]:s?y(n):m(n,n.length)}function f(e){var t=this._events;if(void 0!==t){var s=t[e];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function m(e,t){for(var s=new Array(t),r=0;r<t;++r)s[r]=e[r];return s}function g(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function y(e){for(var t=new Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}function v(e,t){return new Promise(function(s,r){function n(s){e.removeListener(t,o),r(s)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",n),s([].slice.call(arguments))}E(e,t,o,{once:!0}),"error"!==t&&b(e,n,{once:!0})})}function b(e,t,s){"function"==typeof e.on&&E(e,"error",t,s)}function E(e,t,s,r){if("function"==typeof e.on)r.once?e.once(t,s):e.on(t,s);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function n(o){r.once&&e.removeEventListener(t,n),s(o)})}}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function e(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},i.prototype.getMaxListeners=function e(){return d(this)},i.prototype.emit=function e(t){for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);var o="error"===t,i=this._events;if(void 0!==i)o=o&&void 0===i.error;else if(!o)return!1;if(o){var a;if(r.length>0&&(a=r[0]),a instanceof Error)throw a;var c=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw c.context=a,c}var d=i[t];if(void 0===d)return!1;if("function"==typeof d)s(d,this,r);else for(var u=d.length,l=m(d,u),n=0;n<u;++n)s(l[n],this,r);return!0},i.prototype.addListener=function e(t,s){return u(this,t,s,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function e(t,s){return u(this,t,s,!0)},i.prototype.once=function e(t,s){return c(s),this.on(t,p(this,t,s)),this},i.prototype.prependOnceListener=function e(t,s){return c(s),this.prependListener(t,p(this,t,s)),this},i.prototype.removeListener=function e(t,s){var r,n,o,i,a;if(c(s),void 0===(n=this._events))return this;if(void 0===(r=n[t]))return this;if(r===s||r.listener===s)0===--this._eventsCount?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||s));else if("function"!=typeof r){for(o=-1,i=r.length-1;i>=0;i--)if(r[i]===s||r[i].listener===s){a=r[i].listener,o=i;break}if(o<0)return this;0===o?r.shift():g(r,o),1===r.length&&(n[t]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",t,a||s)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function e(t){var s,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[t]&&(0===--this._eventsCount?this._events=Object.create(null):delete r[t]),this;if(0===arguments.length){var o=Object.keys(r),i;for(n=0;n<o.length;++n)"removeListener"!==(i=o[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(s=r[t]))this.removeListener(t,s);else if(void 0!==s)for(n=s.length-1;n>=0;n--)this.removeListener(t,s[n]);return this},i.prototype.listeners=function e(t){return h(this,t,!0)},i.prototype.rawListeners=function e(t){return h(this,t,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},i.prototype.listenerCount=f,i.prototype.eventNames=function e(){return this._eventsCount>0?r(this._events):[]}}},t={};function s(r){var n=t[r];if(void 0!==n)return n.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,s),o.exports}void(s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var r={};s.d(r,{default:()=>pe});var n=s(46);let o;const i=new Uint8Array(16);function a(){if(!o){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");o=crypto.getRandomValues.bind(crypto)}return o(i)}const c=[];for(let e=0;e<256;++e)c.push((e+256).toString(16).slice(1));function d(e,t=0){return(c[e[t+0]]+c[e[t+1]]+c[e[t+2]]+c[e[t+3]]+"-"+c[e[t+4]]+c[e[t+5]]+"-"+c[e[t+6]]+c[e[t+7]]+"-"+c[e[t+8]]+c[e[t+9]]+"-"+c[e[t+10]]+c[e[t+11]]+c[e[t+12]]+c[e[t+13]]+c[e[t+14]]+c[e[t+15]]).toLowerCase()}function u(e,t=0){const s=d(e,t);if(!validate(s))throw TypeError("Stringified UUID is invalid");return s}const l=null,p={};function h(e,t,s){let r;if(e)r=m(e.random??e.rng?.()??a(),e.msecs,e.seq,t,s);else{const e=Date.now(),n=a();f(p,e,n),r=m(n,p.msecs,p.seq,t,s)}return t??d(r)}function f(e,t,s){return e.msecs??=-1/0,e.seq??=0,t>e.msecs?(e.seq=s[6]<<23|s[7]<<16|s[8]<<8|s[9],e.msecs=t):(e.seq=e.seq+1|0,0===e.seq&&e.msecs++),e}function m(e,t,s,r,n=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(r){if(n<0||n+16>r.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`)}else r=new Uint8Array(16),n=0;return t??=Date.now(),s??=127*e[6]<<24|e[7]<<16|e[8]<<8|e[9],r[n++]=t/1099511627776&255,r[n++]=t/4294967296&255,r[n++]=t/16777216&255,r[n++]=t/65536&255,r[n++]=t/256&255,r[n++]=255&t,r[n++]=112|s>>>28&15,r[n++]=s>>>20&255,r[n++]=128|s>>>14&63,r[n++]=s>>>6&255,r[n++]=s<<2&255|3&e[10],r[n++]=e[11],r[n++]=e[12],r[n++]=e[13],r[n++]=e[14],r[n++]=e[15],r}const g=h;
/**
 * Browser-compatible validator implementation
 * Provides comprehensive validation without AJV dependency
 * This implementation must match the server-side validation logic for security
 */
function y(e,t,s="validation",r={}){return{instancePath:e,message:t,keyword:s,params:r}}function v(e){if(!e||"object"!=typeof e)return{valid:!1,errors:[y("","must be object","type",{type:"object"})]};const t=[];return e.session?"object"!=typeof e.session?t.push(y("/session","must be object","type",{type:"object"})):void 0!==e.session.sessionId&&"string"!=typeof e.session.sessionId&&t.push(y("/session/sessionId","must be string","type",{type:"string"})):t.push(y("/session","is required","required",{missingProperty:"session"})),e.request?"object"!=typeof e.request?t.push(y("/request","must be object","type",{type:"object"})):(e.request.connections?"object"!=typeof e.request.connections?t.push(y("/request/connections","must be object","type",{type:"object"})):(e.request.connections.threadId?"string"!=typeof e.request.connections.threadId&&t.push(y("/request/connections/threadId","must be string","type",{type:"string"})):t.push(y("/request/connections/threadId","is required","required",{missingProperty:"threadId"})),void 0!==e.request.connections.parentId&&"string"!=typeof e.request.connections.parentId&&t.push(y("/request/connections/parentId","must be string","type",{type:"string"}))):t.push(y("/request/connections","is required","required",{missingProperty:"connections"})),void 0!==e.request.context&&"object"!=typeof e.request.context&&t.push(y("/request/context","must be object","type",{type:"object"})),void 0!==e.request.attributes&&"object"!=typeof e.request.attributes&&t.push(y("/request/attributes","must be object","type",{type:"object"})),void 0!==e.request.scope&&("object"!=typeof e.request.scope?t.push(y("/request/scope","must be object","type",{type:"object"})):void 0!==e.request.scope.conversations&&(Array.isArray(e.request.scope.conversations)||t.push(y("/request/scope/conversations","must be array","type",{type:"array"})))),void 0!==e.request.resources&&("object"!=typeof e.request.resources?t.push(y("/request/resources","must be object","type",{type:"object"})):void 0!==e.request.resources.offers&&(Array.isArray(e.request.resources.offers)||t.push(y("/request/resources/offers","must be array","type",{type:"array"}))))):t.push(y("/request","is required","required",{missingProperty:"request"})),t.length>0?{valid:!1,errors:t}:{valid:!0,errors:null}}function b(e){if(!e||"object"!=typeof e)return{valid:!1,errors:[y("","must be object","type",{type:"object"})]};const t=[];if(e.headers)if("object"!=typeof e.headers)t.push(y("/headers","must be object","type",{type:"object"}));else{if(e.headers.correlationId?"string"!=typeof e.headers.correlationId&&t.push(y("/headers/correlationId","must be string","type",{type:"string"})):t.push(y("/headers/correlationId","is required","required",{missingProperty:"correlationId"})),e.headers.action)if("string"!=typeof e.headers.action)t.push(y("/headers/action","must be string","type",{type:"string"}));else{const s=["adjust","elevate","interaction","customerinteraction","reception","summarize","translate","recommend","insights"];s.includes(e.headers.action)||t.push(y("/headers/action","must be equal to one of the allowed values","enum",{allowedValues:s}))}else t.push(y("/headers/action","is required","required",{missingProperty:"action"}));void 0!==e.headers.identifier&&"string"!=typeof e.headers.identifier&&t.push(y("/headers/identifier","must be string","type",{type:"string"})),void 0!==e.headers.schemaRef&&"string"!=typeof e.headers.schemaRef&&t.push(y("/headers/schemaRef","must be string","type",{type:"string"})),void 0!==e.headers.timestamp&&"string"!=typeof e.headers.timestamp&&t.push(y("/headers/timestamp","must be string","type",{type:"string"}))}else t.push(y("/headers","is required","required",{missingProperty:"headers"}));if(e.payload){if("object"!=typeof e.payload)t.push(y("/payload","must be object","type",{type:"object"}));else if(e.headers&&e.headers.action&&e.payload){const s=e.headers.action,r=undefined;["adjust","elevate","interaction","customerinteraction","customerInteraction","summarize","translate","insights","recommend"].includes(s)&&(e.payload.request?e.payload.request.scope?e.payload.request.scope.conversations?Array.isArray(e.payload.request.scope.conversations)?0===e.payload.request.scope.conversations.length&&t.push(y("/payload/request/scope/conversations",`must be non-empty array for ${s}`,"minItems",{limit:1})):t.push(y("/payload/request/scope/conversations","must be array","type",{type:"array"})):t.push(y("/payload/request/scope/conversations",`is required for ${s}`,"required",{missingProperty:"conversations"})):t.push(y("/payload/request/scope","is required","required",{missingProperty:"scope"})):t.push(y("/payload/request","is required","required",{missingProperty:"request"})))}}else t.push(y("/payload","is required","required",{missingProperty:"payload"}));return t.length>0?{valid:!1,errors:t}:{valid:!0,errors:null}}const E=null,S="3.2.3",w=undefined,_=`optave.message.v${S.split(".")[0]}`,I={AUTHENTICATION:"AUTHENTICATION",ORCHESTRATOR:"ORCHESTRATOR",VALIDATION:"VALIDATION",WEBSOCKET:"WEBSOCKET"},O=Object.freeze({MESSAGE:"message",ERROR:"error"}),T=Object.freeze({CONNECTION_OPEN:"connection:open",CONNECTION_CLOSE:"connection:close",CONNECTION_ERROR:"connection:error",MESSAGE_RECEIVED:"message:received",MESSAGE_SENT:"message:sent",ERROR:"error",RESPONSE:"response",LEGACY_ERROR:"error",LEGACY_MESSAGE:"message"}),A=Object.freeze({SUPERPOWER_RESPONSE:"superpower.response",SUPERPOWER_ERROR:"superpower.error"}),R=new Set(["adjust","elevate","interaction","reception","customerInteraction","summarize","translate","recommend","insights"]),k=undefined,q=undefined,C=undefined,N=undefined,U={SPEC_VERSION:S,SCHEMA_REF:_,MAX_PAYLOAD_SIZE:131072,MAX_PAYLOAD_SIZE_KB:128,DEFAULT_REQUEST_TIMEOUT_MS:3e4,ErrorCategory:I,LegacyEvents:O,EVENTS:T,InboundEvents:A,ALLOWED_ACTIONS:R},L=()=>{if("undefined"!=typeof process&&process.versions&&process.versions.node){const e=undefined;if(!1,"true"===process.env.VITEST||void 0!==process.env.JEST_WORKER_ID||process.argv.some(e=>e.includes("vitest")||e.includes("jest")||e.includes("test")))return!(!("undefined"!=typeof global&&"window"in global&&global.window&&"document"in global&&global.document)||process.env.OPTAVE_SDK_FORCE_SERVER_ENV)}if("undefined"!=typeof global){if(!("window"in global)&&!("document"in global)&&"undefined"!=typeof process&&process.versions&&process.versions.node)return!1;if((!("window"in global)||!("document"in global))&&"undefined"!=typeof process&&process.versions&&process.versions.node)return!1;if("window"in global&&global.window)return!0;if("document"in global&&global.document)return!0}try{if("undefined"!=typeof window&&null!==window)return("undefined"==typeof global||"window"in global)&&("undefined"==typeof global||"undefined"==typeof process||!process.versions||!process.versions.node||"window"in global);if("undefined"!=typeof document&&null!==document)return("undefined"==typeof global||"document"in global)&&("undefined"==typeof global||"undefined"==typeof process||!process.versions||!process.versions.node||"document"in global)}catch(e){}return"undefined"!=typeof navigator&&"ReactNative"===navigator.product||(!("undefined"==typeof global||!global.__expo)||("undefined"!=typeof location&&null!==location||("undefined"!=typeof process&&process.versions&&process.versions.node,!1)))};function P(e){const t=[];return!e.authenticationUrl||e.clientId&&e.clientSecret||t.push({type:"warning",code:"INCOMPLETE_AUTH_CONFIG",message:"authenticationUrl provided but clientId/clientSecret incomplete; authenticate() may fail.",field:"authentication"}),t}
/**
 * Validates client-specific configuration and enforces security rules
 * @param {Object} options - SDK options
 * @returns {Array} Array of validation errors (empty if valid)
 */function D(e){const t=[];if(L()&&e.clientSecret){let e=!1,s=!1;try{e=!0}catch(e){}try{s=!1}catch(e){}const r=undefined;e||s||t.push({type:"error",code:"CLIENT_SECRET_IN_CLIENT_ENV",message:"clientSecret must not be supplied in a client environment (browser, mobile, Electron renderer). Use options.tokenProvider() to obtain a short-lived token.",field:"clientSecret"})}return t}function W(e){const t=[];return e.websocketUrl&&"string"==typeof e.websocketUrl||t.push({type:"warning",code:"MISSING_WEBSOCKET_URL",message:"websocketUrl not provided; openConnection() will emit an error.",field:"websocketUrl"}),t}function M(e){if(void 0===e.strictValidation){const t="undefined"!=typeof process&&process.env?"production":"development";e.strictValidation="production"!==t}if("number"!=typeof e.requestTimeoutMs&&(e.requestTimeoutMs=3e4),"number"!=typeof e.connectionTimeoutMs&&(e.connectionTimeoutMs=3e4),e.logger||(e.logger={debug(){},info(){},warn(){},error(){}}),e.authTransport||(e.authTransport="subprotocol"),void 0===e.authRequired&&(e.authRequired=!0),!e.tokenProvider){let t=e.tokenUrl;if(!t&&"undefined"!=typeof document){const e=document.querySelector('meta[name="optave-token-url"]');e&&e.content&&(t=e.content)}t||(t="/api/optave/ws-ticket"),e.tokenProvider=async()=>{const s={};e.publishableKey&&(s["X-Optave-Publishable-Key"]=e.publishableKey);const r=await fetch(t,{method:"POST",credentials:"include",headers:s});if(!r.ok)throw new Error("Failed to obtain WS token");const n=await r.json();return n.token||n.access_token}}return e}function j(e){const t={isValid:!0,errors:[],warnings:[]},s=undefined,r=undefined,n=undefined,o=[...W(e),...P(e),...D(e)];for(const e of o)"error"===e.type?(t.errors.push(e),t.isValid=!1):"warning"===e.type&&t.warnings.push(e);return t}const V={BROWSER_ESM:"browser-esm",SERVER_ESM:"server-esm",BROWSER_UMD:"browser-umd",SERVER_UMD:"server-umd"},K={browser:V.BROWSER_ESM,server:V.SERVER_ESM},$={BROWSER:[V.BROWSER_ESM,V.BROWSER_UMD,V.SERVER_UMD],SERVER:[V.SERVER_ESM],UMD:[V.BROWSER_UMD,V.SERVER_UMD],ESM:[V.BROWSER_ESM,V.SERVER_ESM]},B={isValid:e=>Object.values(V).includes(e)||Object.keys(K).includes(e),normalize:e=>K[e]?K[e]:Object.values(V).includes(e)?e:"unknown",isBrowser(e){const t=this.normalize(e);return $.BROWSER.includes(t)},isServer(e){const t=this.normalize(e);return $.SERVER.includes(t)},isUMD(e){const t=this.normalize(e);return $.UMD.includes(t)},isESM(e){const t=this.normalize(e);return $.ESM.includes(t)},getInfo(e){const t=undefined;return{original:e,normalized:this.normalize(e),valid:this.isValid(e),isBrowser:this.isBrowser(e),isServer:this.isServer(e),isUMD:this.isUMD(e),isESM:this.isESM(e)}}};class x extends Error{constructor({category:e,code:t,message:s,details:r}){super(s),this.name="OptaveError",this.category=e||"UNKNOWN",this.code=t||"UNKNOWN",void 0!==r&&(this.details=r)}}function z(e){return e&&e.category&&e.code&&e.message?new x(e):"string"==typeof e?new x({category:"UNKNOWN",code:"STRING_ERROR",message:e}):e&&"AjvValidationError"===e.name?new x({category:"VALIDATION",code:"SCHEMA_VALIDATION",message:e.message,details:e.errors}):e&&e.isAuthError?new x({category:"AUTHENTICATION",code:e.code||"AUTH_ERROR",message:e.message||"Authentication error",details:e}):e&&e.isWsError?new x({category:"WEBSOCKET",code:e.code||"WS_ERROR",message:e.message||"WebSocket error",details:e}):new x({category:"UNKNOWN",code:"UNCLASSIFIED",message:e&&e.message||String(null!=e?e:"Unknown error"),details:e})}async function F(){return null}// ./runtime/core/security-guards.js
/**
 * Critical Security Guards for Optave SDK
 *
 * This file contains mandatory security validations that MUST be preserved
 * in all build outputs. Tree-shaking and dead code elimination tools
 * must NOT remove these security checks.
 *
 * SECURITY WARNING: Modifications to this file may introduce security vulnerabilities
 * in Salesforce Lightning environments and other constrained platforms.
 */
/**
 * Runtime WebSocket scheme enforcement for UMD builds
 *
 * This guard prevents insecure WebSocket connections (ws://) in UMD builds,
 * which are specifically deployed in Salesforce Lightning environments where
 * the Locker Service blocks all insecure WebSocket connections.
 *
 * SECURITY: This function has intentional side effects (throws errors) and
 * must be preserved in all build outputs. Removing this validation creates
 * a security vulnerability in production environments.
 *
 * @param {string} websocketUrl - The WebSocket URL to validate
 * @param {string} buildTarget - The webpack build target identifier
 * @param {object} options - SDK configuration options
 * @throws {Error} When ws:// protocol is used in UMD builds
 * @throws {Error} When tokenProvider is missing for secure connections in UMD builds
 */
function H(e,t,s={}){if(
// SECURITY: Explicitly mark as having side effects - do not optimize away
1,!e||"string"!=typeof e)return;const r=B.normalize(t),n=B.isUMD(r),o=B.isBrowser(r);
// CRITICAL: Validate WebSocket scheme for UMD and browser builds
// This guard prevents insecure connections in Salesforce Lightning
if((n||o)&&e.startsWith("ws://")){
// SECURITY: This error message must remain intact to guide developers
const t=undefined;
// CRITICAL: This throw statement is a security boundary - must not be removed
throw new Error(`[Optave SDK] Insecure WebSocket protocol (ws://) is not allowed in UMD builds. Salesforce Lightning Locker Service blocks all ws:// connections for security reasons. Please use secure WebSocket protocol (wss://) instead. Current URL: ${e}`)}
// CRITICAL: For UMD builds with secure WebSocket URLs, validate token provider availability
if(n&&e.startsWith("wss://")){const t="function"==typeof s.tokenProvider,r=!1===s.authRequired;if(!t&&!r){
// SECURITY: This error message must remain intact to guide developers
const t=undefined;
// CRITICAL: This throw statement is a security boundary - must not be removed
throw new Error(`[Optave SDK] UMD builds require a tokenProvider function for secure WebSocket connections. In constrained environments like Salesforce Lightning, authentication tokens must be obtained from your backend server. Please provide options.tokenProvider() that returns a valid token, or set options.authRequired = false to disable authentication. Current URL: ${e}`)}}}
/**
 * Initialize security guards on module load
 * This ensures the security validation code is evaluated and cannot be tree-shaken
 */function G(){
// SECURITY: Module-level side effect to prevent tree-shaking
if("undefined"!=typeof globalThis){
// Mark security guards as active - this creates a side effect
globalThis.__OPTAVE_SECURITY_GUARDS_ACTIVE__=!0;const e=undefined;if(!globalThis.__OPTAVE_SECURITY_GUARDS_ACTIVE__)throw new Error("Security guard initialization failed")}"undefined"!=typeof process&&process.env,0}G(),"undefined"!=typeof window?
// Browser environment - ensure security guards are active
window.__OPTAVE_SECURITY_GUARDS_BROWSER__=!0:"undefined"!=typeof global&&(
// Node.js environment - ensure security guards are active
global.__OPTAVE_SECURITY_GUARDS_NODE__=!0);var Y=s(31).I;const J="3.2.3",Q=()=>{const e="server-umd";return{isBrowser:B.isBrowser(e),isServer:B.isServer(e),buildTarget:e}},X=()=>{const e=Q();return"unknown"!==e.buildTarget?e.isBrowser:"undefined"!=typeof window&&void 0!==window.WebSocket};let Z=!1,ee=!1;class OptaveJavaScriptSDK extends n{options={};wss=null;static defaultPayload={session:{sessionId:"",channel:{browser:"",deviceInfo:"",deviceType:"",language:"",location:"",medium:"chat",metadata:[],section:""},interface:{appVersion:"",category:"",language:"",name:"",type:""}},request:{requestId:"",attributes:{content:"",instruction:"",variant:"A"},connections:{journeyId:"",parentId:"",threadId:""},context:{caseId:"",departmentId:"",operatorId:"",organizationId:"",userId:""},reference:{ids:[{name:"",value:""}],labels:[],tags:[]},resources:{codes:[{id:"",label:"",type:"",value:""}],links:[{expires_at:"",html:!1,id:"",label:"",type:"",url:""}],offers:[]},scope:{accounts:[],appointments:[],assets:[],bookings:[],cases:[],conversations:[],documents:[],events:[],interactions:[],items:[],locations:[],operators:[],orders:[],organizations:[],persons:[],policies:[],products:[{id:""}],properties:[],services:[],subscriptions:[],tickets:[],transactions:[],users:[]},settings:{disableBrowsing:!1,disableSearch:!1,disableSources:!1,disableStream:!0,disableTools:!1,maxResponseLength:0,overrideInterfaceLanguage:"",overrideOutputLanguage:""},a2a:[{id:"",name:"",type:""}],cursor:{since:"",until:""}}};static cleanup(){Z=!1,ee=!1}constructor(e){if(super(),this.options={...e},M(this.options),void 0===this.options.cspSafe){const e=Q();"server-esm"===e.buildTarget||"server"===e.buildTarget?this.options.cspSafe=!1:("server-umd"===e.buildTarget||"browser-esm"===e.buildTarget||"browser-umd"===e.buildTarget||e.isBrowser||X())&&(this.options.cspSafe=!0)}const t=j(this.options);if(!t.isValid){const e=t.errors.map(e=>e.message).join("; ");throw new Error(`[Optave SDK] Configuration errors: ${e}`)}t.warnings.forEach(e=>{(this.options?.logger?.warn||console.warn)(`[Optave SDK] ${e.message}`)});
// SECURITY: This validation is critical for Salesforce Lightning security - must not be removed by tree-shaking
const s="server-umd";try{
// Use canonical security guard - single source of truth for WebSocket validation
H(this.options.websocketUrl,s,this.options)}catch(e){
// Re-throw security errors immediately - this prevents minification from removing the try/catch
throw e}const r=Q();this.WebSocketImpl=this.options.WebSocketImpl,!this.WebSocketImpl&&r.isBrowser?this.WebSocketImpl=("undefined"!=typeof WebSocket?WebSocket:void 0)||("undefined"!=typeof window&&window.WebSocket?window.WebSocket:void 0):!this.WebSocketImpl&&r.isServer&&(this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:void 0),this._pending=new Map,this._deprecatedKeys=new Set,this._silenceDeprecations="undefined"!=typeof process&&"1"===process?.env?.OPTAVE_SDK_SILENCE_DEPRECATIONS,this.options.cspSafe,this._validatePayload=v,this._validateMessageEnvelope=b}async _ensureWebSocketImpl(){if(this.WebSocketImpl)return this.WebSocketImpl;const e=Q();return this.WebSocketImpl=this.options.WebSocketImpl,!this.WebSocketImpl&&e.isBrowser?this.WebSocketImpl=("undefined"!=typeof WebSocket?WebSocket:void 0)||("undefined"!=typeof window&&window.WebSocket?window.WebSocket:void 0):!this.WebSocketImpl&&e.isServer&&(this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:void 0),this.WebSocketImpl||(e.isBrowser?this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:null:e.isServer&&(this.WebSocketImpl=await this.loadNodeWebSocket())),this.WebSocketImpl}async loadNodeWebSocket(){const e=Q();return e.isBrowser?null:("unknown"!==e.buildTarget||"undefined"==typeof window&&"undefined"==typeof document&&"undefined"==typeof navigator&&"undefined"==typeof location)&&"undefined"!=typeof process&&process.versions&&process.versions.node?await F():null}static getSdkVersion(){return J}static getSpecVersion(){return S}static getSchemaRef(){return _}static get CONSTANTS(){return U}static get LegacyEvents(){return O}static get InboundEvents(){return A}setSessionId(e){return this.sessionId=e,this}getSessionId(){return this.sessionId||""}validate(e){const t=undefined;return this._validatePayload(e).valid}validateEnvelope(e){const t=undefined;return this._validateMessageEnvelope(e).valid}validateRequiredFields(e,t){const s=[];switch(e.request?.connections?.threadId||s.push("request.connections.threadId is required"),t){case"adjust":e.request?.attributes?.content||s.push("request.attributes.content is required for adjust"),e.request?.attributes?.instruction||s.push("request.attributes.instruction is required for adjust"),e.request?.connections?.parentId||s.push("request.connections.parentId is required for adjust"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for adjust and must be a non-empty array");break;case"elevate":e.request?.attributes?.content||s.push("request.attributes.content is required for elevate"),e.request?.connections?.parentId||s.push("request.connections.parentId is required for elevate"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for elevate and must be a non-empty array");break;case"translate":case"summarize":case"insights":case"customerinteraction":case"customerInteraction":case"interaction":e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push(`request.scope.conversations is required for ${t} and must be a non-empty array`);break;case"recommend":e.request?.resources?.offers&&Array.isArray(e.request.resources.offers)&&0!==e.request.resources.offers.length||s.push("request.resources.offers is required for recommend and must be a non-empty array"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for recommend and must be a non-empty array")}return{isValid:0===s.length,errors:s}}async authenticate(){
// Browser-targeted builds should not use client credentials for security
const e="server-umd",t=undefined;if(B.isBrowser(e))return this.handleError(I.AUTHENTICATION,"UNSUPPORTED_IN_BROWSER","authenticate() is not available in browsers. Use options.tokenProvider() to obtain a short-lived WebSocket token from your backend."),null;let s={grant_type:"client_credentials"};if(!this.options.authenticationUrl)return this.handleError(I.AUTHENTICATION,"INVALID_AUTHENTICATION_URL","Empty or invalid authentication URL"),null;if(!this.options.clientId)return this.handleError(I.AUTHENTICATION,"INVALID_CLIENT_ID","Empty or invalid client ID"),null;s.client_id=this.options.clientId,s.client_secret=this.options.clientSecret;const r=new Y(s).toString();let n=this.options.authenticationUrl;n.endsWith("/token")||(n=n.endsWith("/")?n+"token":n+"/token");const o=`${n}?${r}`,i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"}}),a=await i.json();return i.ok?a.access_token:(this.handleError(I.AUTHENTICATION,"INVALID_AUTHENTICATION_RESPONSE",this.formatAuthenticationError(i,a.error,"token endpoint").message,a.error),null)}async openConnection(e){if(!this.options.websocketUrl)return(this.options?.logger?.error||console.error)("[Optave SDK] openConnection aborted: missing websocketUrl"),this.handleError(I.WEBSOCKET,"INVALID_WEBSOCKET_URL",this.formatWebSocketError(new Error("Invalid WebSocket URL configuration"),{url:this.options.websocketUrl}).message,this.options.websocketUrl),void 0;const t=async()=>{if("string"==typeof e&&e.length>0)return e;if("function"==typeof this.options.tokenProvider)try{return await this.options.tokenProvider()}catch(e){return this.handleError(I.AUTHENTICATION,"TOKEN_PROVIDER_FAILED",this.formatTokenProviderError(e).message,e),null}return null},s=await t();if(await this._ensureWebSocketImpl(),!this.WebSocketImpl)return this.handleError(I.WEBSOCKET,"NO_WEBSOCKET_IMPL",this.formatWebSocketError(new Error("No WebSocket implementation available"),{environment:"undefined"!=typeof window?"browser":"node"}).message),void 0;if(!s&&!1!==this.options.authRequired)return this.handleError(I.AUTHENTICATION,"MISSING_TOKEN","No WebSocket token available. Provide options.tokenProvider() or set options.tokenUrl."),void 0;const r=new Y;this.sessionId&&r.set("OptaveTraceChatSessionId",this.sessionId);try{if("subprotocol"===this.options.authTransport){const e=s?["optave-v1",s]:["optave-v1"];this.wss=new this.WebSocketImpl(r.toString()?`${this.options.websocketUrl}?${r.toString()}`:this.options.websocketUrl,e)}else{if(s){const e=s.replace(/^Bearer\s+/i,"");r.set("Authorization",e)}this.wss=new this.WebSocketImpl(r.toString()?`${this.options.websocketUrl}?${r.toString()}`:this.options.websocketUrl),s&&this._warnOnce("_warnedQueryToken",'[Optave SDK] Passing auth token in WebSocket URL query is discouraged. Prefer authTransport="subprotocol".')}}catch(e){return(this.options?.logger?.error||console.error)("[Optave SDK] WebSocket constructor threw",e),this.handleError(I.WEBSOCKET,"WEBSOCKET_ERROR",this.formatWebSocketError(e,{url:this.options.websocketUrl}).message,e),void 0}return new Promise((e,t)=>{const s=setTimeout(()=>{const e=this.options.connectionTimeoutMs||3e4,s=this.formatWebSocketError(new Error("Connection timeout"),{timeout:e,url:this.options.websocketUrl}).message;
// CRITICAL: Close the WebSocket to prevent zombie connections
if(this.wss){this.wss.onopen=null,this.wss.onmessage=null,this.wss.onclose=null,this.wss.onerror=null;try{this.wss.close()}catch(e){}this.wss=null}this.handleError(I.WEBSOCKET,"CONNECTION_TIMEOUT",s),t({category:I.WEBSOCKET,code:"CONNECTION_TIMEOUT",message:s,details:null})},this.options.connectionTimeoutMs||3e4);this.wss.onopen=t=>{clearTimeout(s),this.emit("open",t),e(t)},this.wss.onmessage=e=>{this._handleInbound(e.data)},this.wss.onclose=e=>{clearTimeout(s),this.emit("close",e);
// CRITICAL: Race condition prevention for promise handling
for(const[t,s]of this._pending.entries())s.timer&&clearTimeout(s.timer),s._handled=!0,s.reject({category:I.WEBSOCKET,code:"CONNECTION_CLOSED",message:`WebSocket connection closed: ${e.reason||"Connection lost"}`,details:{code:e.code,reason:e.reason,correlationId:t},correlationId:t});this._pending.clear(),this.wss=null},this.wss.onerror=e=>{clearTimeout(s);
// CRITICAL: Enhanced error message handling and race condition prevention
const r=e.message||(e instanceof Error?e.message:null)||"object"==typeof e&&e.error&&e.error.message||"WebSocket connection failed",n={category:I.WEBSOCKET,code:"CONNECTION_ERROR",message:r,details:{originalError:e}};for(const[e,t]of this._pending.entries())t.timer&&clearTimeout(t.timer),t._handled=!0,t.reject({...n,details:{...n.details,correlationId:e},correlationId:e});this._pending.clear(),this.emit("error",n),t(n)}})}_warnOnce(e,t){this[e]||(this[e]=!0,(this.options?.logger?.warn||console.warn)(t))}deprecate(e,t){this._silenceDeprecations||this._deprecatedKeys.has(e)||(this._deprecatedKeys.add(e),(this.options?.logger?.warn||console.warn)(t))}_handleInbound(e){let t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){const t={category:I.WEBSOCKET,code:"INVALID_JSON",message:"Invalid JSON received from server",details:e,timestamp:(new Date).toISOString()};return this._emitError(t),void 0}const s=t&&t.headers&&t.payload,r="error"===t?.state||"error"===t?.actionType||!!t?.error;if(this.options.strictValidation&&s){const e=this._validateMessageEnvelope(t);e.valid||this.handleError(I.VALIDATION,"INBOUND_ENVELOPE_SCHEMA_MISMATCH",this.formatValidationErrorMessage(e.errors,"Inbound envelope validation failed"),e.errors)}if(r){const e=t?.headers&&t.headers.correlationId||t?.correlationId||null,s={category:I.ORCHESTRATOR,code:t?.error?.code||"REMOTE_ERROR",message:t?.error?.message||t?.message||"Remote error",details:t?.error||t,correlationId:e};if(e&&this._pending.has(e)){const t=this._pending.get(e);t.timer&&clearTimeout(t.timer),t._handled=!0,this._pending.delete(e),t.reject(s)}return this._emitError(s,t?.action),void 0}const n=t?.headers?.correlationId||t?.correlationId;if(n&&this._pending.has(n)){const e=this._pending.get(n);e.timer&&clearTimeout(e.timer),e._handled=!0,this._pending.delete(n),e.resolve(t)}this.emit(O.MESSAGE,t),Z||(Z=!0,(this.options?.logger?.warn||console.warn)('[optave-sdk][deprecation] The "message" event will be deprecated. Please also listen to "superpower.response".')),this.emit(A.SUPERPOWER_RESPONSE,t),this.emit(T.RESPONSE,t),t?.action&&this.emit(`message.${t.action}`.toLowerCase(),t),s&&t.headers.schemaRef&&this.emit(t.headers.schemaRef,t)}_emitError(e,t=null){e.timestamp||(e.timestamp=(new Date).toISOString()),this.emit(O.ERROR,e),ee||(ee=!0,(this.options?.logger?.warn||console.warn)('[optave-sdk][deprecation] The "error" (string payload) is deprecated. Please also listen to "superpower.error" for a structured error object.'));const s=z(e);this.emit(A.SUPERPOWER_ERROR,s),this.emit(T.ERROR,e)}closeConnection(){this.wss&&(this.wss.onopen=null,this.wss.onmessage=null,this.wss.onclose=null,this.wss.onerror=null,this.wss.close(),this.wss=null)}selectiveDeepMerge(e,t){if(Array.isArray(e)&&Array.isArray(t))return[...t];const s=e=>null!==e&&"object"==typeof e&&!Array.isArray(e);if(s(e)&&s(t)){const s={...e};for(let r in t)s[r]=r in e?this.selectiveDeepMerge(e[r],t[r]):t[r];return s}return void 0!==t?t:e}isPayloadSizeValid(e){return!!e&&e.length/1024<=U.MAX_PAYLOAD_SIZE_KB}openConnectionAsync(e){return new Promise((t,s)=>{const r=e=>{this.off("error",n),t(e)},n=e=>{this.off("open",r),s(e)};this.once("open",r),this.once("error",n),this.openConnection(e)})}buildPayload(e,t,s){let r=this.selectiveDeepMerge(OptaveJavaScriptSDK.defaultPayload,s);return s?.request?.variation&&(this.deprecate("payload.request.variation","[Deprecation] 'request.variation' is deprecated; use 'request.attributes.variant'."),r.request.attributes.variant=s.request.variation),s?.request?.content&&!r.request?.attributes?.content&&(r.request.attributes.content=s.request.content,this.deprecate("payload.request.content","[Deprecation] 'request.content' is deprecated; use 'request.attributes.content'.")),r.request.attributes.variant&&(r.request.attributes.variant=r.request.attributes.variant.toUpperCase()),r}resolveMessageId(e,t){return`${t}.${e}.v3`.toLowerCase()}buildMessageEnvelope(e,t,s,r={}){const n=(new Date).toISOString(),o=r.correlationId||e?.request?.requestId||g(),i=r.traceId||g(),a=r.idempotencyKey||g(),c=r.timestamp,d=undefined,u={correlationId:o,action:s,schemaRef:_,sdkVersion:J,identifier:t,traceId:i,idempotencyKey:a,timestamp:c,issuedAt:n};return this.options.tenantId&&(u.tenantId=this.options.tenantId),void 0!==r.networkLatencyMs&&(u.networkLatencyMs=r.networkLatencyMs),Object.freeze(u),{action:"message",headers:u,payload:e}}formatValidationErrorMessage(e,t="Validation failed"){if(!e||!Array.isArray(e)||0===e.length)return t;if(1===e.length){const s=e[0],r=s.instancePath||"/",n="/"===r?"root object":r.replace(/^\//,"").replace(/\//g,".");if("required"===s.keyword){const e=s.params?.missingProperty||"unknown field",r="root object"===n?e:n.endsWith(e)?n:n+"."+e;return`${t}: ${"root object"===n?"Required field":"Field"} '${r}' is missing`}if("type"===s.keyword){const e=undefined;return`${t}: Field '${n}' must be of type '${s.params?.type||"unknown"}'`}if("additionalProperties"===s.keyword){const e=undefined;return`${t}: Field '${n}.${s.params?.additionalProperty||"unknown"}' is not allowed`}if("enum"===s.keyword){const e=s.params?.allowedValues||[],r=undefined;return`${t}: Field '${n}' must be one of: ${Array.isArray(e)?e.join(", "):"unknown values"}`}return`${t}: ${s.message} at '${n}'`}
// If there are multiple errors, provide a summary with the most critical ones
const s=e.filter(e=>"required"===e.keyword),r=e.filter(e=>"type"===e.keyword),n=e.filter(e=>"required"!==e.keyword&&"type"!==e.keyword);let o=t+":";if(s.length>0){const e=undefined;o+=` Missing required fields: ${s.map(e=>{const t=(e.instancePath||"/").replace(/^\//,"").replace(/\//g,"."),s=e.params?.missingProperty||"unknown";return""===t?s:`${t}.${s}`}).join(", ")}.`}if(r.length>0){const e=undefined;o+=` Type errors in: ${r.slice(0,3).map(e=>{const t=undefined,s=undefined;return`${(e.instancePath||"/").replace(/^\//,"").replace(/\//g,".")||"root"} (expected ${e.params?.type||"unknown"})`}).join(", ")}.`,r.length>3&&(o+=` And ${r.length-3} more type errors.`)}return n.length>0&&(o+=` Additional validation errors: ${n.length}.`),o}formatAuthenticationError(e,t,s){let r="Authentication failed";const n=[];return e&&e.status&&(r+=` (HTTP ${e.status})`),t&&("string"==typeof t?r+=`: ${t}`:t.error_description?r+=`: ${t.error_description}`:t.message?r+=`: ${t.message}`:t.error&&(r+=`: ${t.error}`)),e&&401===e.status?(n.push("Verify clientId and clientSecret are correct"),n.push("Ensure credentials match the target environment (dev/staging/production)")):e&&403===e.status?(n.push("Check if your client has the necessary permissions"),n.push("Verify the authentication endpoint URL is correct")):e&&e.status>=500?(n.push("Authentication server error - try again later"),n.push("Contact support if the problem persists")):n.push("Check network connectivity and authentication endpoint configuration"),s&&s.authUrl&&(r+=` (endpoint: ${s.authUrl})`),{message:r,suggestions:n}}formatWebSocketError(e,t){let s="WebSocket connection failed";const r=[],n=e?.message||(e instanceof Error?e.message:null)||"object"==typeof e&&e.error&&e.error.message||null;return n&&(s+=`: ${n}`),t&&(t.url&&(s+=` (URL: ${t.url})`),t.timeout&&(s+=` (timeout: ${t.timeout}ms)`)),r.push("Check network connectivity and firewall settings"),r.push("Verify WebSocket URL is correct and accessible"),t&&t.url&&(t.url.startsWith("ws://")&&r.push("Consider using secure WebSocket (wss://) for production"),(t.url.includes("localhost")||t.url.includes("127.0.0.1"))&&r.push("Ensure local server is running if connecting to localhost")),t&&t.timeout&&r.push("Try increasing connection timeout if network is slow"),{message:s,suggestions:r}}formatPayloadSizeError(e,t,s){const r=Math.ceil(e/1024),n=t,o=undefined;let i=`Payload too large: ${r}KB exceeds maximum ${t}KB (${r-t}KB over limit)`;const a=[];if(s&&"object"==typeof s){const e=JSON.stringify(s);if(s.request?.scope?.conversations&&Array.isArray(s.request.scope.conversations)){const e=JSON.stringify(s.request.scope.conversations).length,t=Math.ceil(e/1024);t>10&&(a.push(`Consider reducing conversation history - current size: ~${t}KB`),a.push("Remove older messages or summarize conversation context"))}if(s.request?.resources?.offers&&Array.isArray(s.request.resources.offers)){const e=JSON.stringify(s.request.resources.offers).length,t=Math.ceil(e/1024);t>5&&a.push(`Consider reducing product offers data - current size: ~${t}KB`)}if(s.session?.channel?.metadata&&Array.isArray(s.session.channel.metadata)){const e=JSON.stringify(s.session.channel.metadata).length,t=Math.ceil(e/1024);t>2&&a.push(`Consider reducing metadata array - current size: ~${t}KB`)}}return 0===a.length&&(a.push("Remove unused fields from request payload"),a.push("Consider paginating large datasets"),a.push("Use shorter field values where possible")),{message:i,suggestions:a}}formatTokenProviderError(e,t){let s="Failed to obtain WebSocket token from tokenProvider()";const r=[];return e&&(e.message?s+=`: ${e.message}`:"string"==typeof e&&(s+=`: ${e}`),"TypeError"===e.name&&e.message?.includes("fetch")?(r.push("Check if tokenProvider endpoint is accessible"),r.push("Verify CORS settings allow requests to token endpoint")):e.message?.includes("404")||e.message?.includes("Not Found")?(r.push("Verify tokenProvider endpoint URL is correct"),r.push("Ensure backend token endpoint is implemented")):e.message?.includes("401")||e.message?.includes("403")?(r.push("Check authentication/authorization for token endpoint"),r.push("Verify user session or credentials are valid")):e.message?.includes("timeout")&&r.push("Token provider request timed out - check network or server response time")),t&&t.tokenUrl&&(s+=` (endpoint: ${t.tokenUrl})`),0===r.length&&(r.push("Verify tokenProvider function implementation"),r.push("Check backend token endpoint is running and accessible"),r.push("Review browser console for network errors")),{message:s,suggestions:r}}handleError(e,t,s,r=null,n=[],o=null){const i=new x({category:e,code:t,message:s,details:r});n&&(i.suggestions=n),o&&(i.correlationId=o),0===this.listenerCount(O.ERROR)&&0===this.listenerCount(T.ERROR)&&(this.options?.logger?.error||console.error)(`[Optave SDK] ${t}: ${s}`),this._emitError(i)}send(e,t,s){const r=null!=(this.WebSocketImpl&&this.WebSocketImpl.OPEN)?this.WebSocketImpl.OPEN:1;if(!this.wss||this.wss.readyState!==r){const e=this.wss?this.wss.readyState:"no connection";return this.handleError(I.WEBSOCKET,"WEBSOCKET_NOT_IN_OPEN_STATE",this.formatWebSocketError(new Error("WebSocket not ready for sending"),{readyState:e,action:t}).message),void 0}if(!R.has(t))return this.handleError(I.VALIDATION,"INVALID_ACTION",`Unsupported action '${t}'. Allowed: ${[...R].join(", ")}`),void 0;const n=new Set(["session","request","headers"]);for(const e of Object.keys(s||{}))if(!n.has(e)){const t=[{instancePath:"",keyword:"additionalProperties",params:{additionalProperty:e},message:`must NOT have additional property '${e}'`}];return this.handleError(I.VALIDATION,"PAYLOAD_SCHEMA_MISMATCH",this.formatValidationErrorMessage(t),t),void 0}const o=this.buildPayload(e,t,s||{}),i=this.validateRequiredFields(o||{},t);if(!i.isValid)return this.handleError(I.VALIDATION,"REQUIRED_FIELDS_MISSING",`Missing required fields for action '${t}': ${i.errors.join(", ")}`,i.errors),void 0;if(this.options.strictValidation){const e=this._validatePayload(o);if(!e.valid)return this.handleError(I.VALIDATION,"PAYLOAD_SCHEMA_MISMATCH",this.formatValidationErrorMessage(e.errors,"Schema validation failed"),e.errors),void 0}const a=this.buildMessageEnvelope(o,e,t,s?.headers||{}),c=JSON.stringify(a);if(!this.isPayloadSizeValid(c)){const e=c.length;return this.handleError(I.VALIDATION,"PAYLOAD_TOO_LARGE",this.formatPayloadSizeError(e,U.MAX_PAYLOAD_SIZE_KB,a).message,U.MAX_PAYLOAD_SIZE_KB),void 0}this.wss.send(c)}adjust(e){return this.send("message","adjust",e)}elevate(e){return this.send("message","elevate",e)}interaction(e){return this.send("message","interaction",e)}reception(e){return this.send("message","reception",e)}customerInteraction(e){return this.deprecate("method.customerInteraction","[Deprecation] 'customerInteraction' is deprecated; use 'interaction' instead."),this.send("message","customerInteraction",e)}summarize(e){return this.send("message","summarize",e)}translate(e){return this.send("message","translate",e)}recommend(e){return this.send("message","recommend",e)}insights(e){return this.send("message","insights",e)}_registerPending(e,t,s,r,n){let o=null;s>0&&(o=setTimeout(()=>{if(this._pending.has(e)){const r=this._pending.get(e);r&&!r._handled&&(this._pending.delete(e),r._handled=!0,n({category:I.WEBSOCKET,code:"REQUEST_TIMEOUT",message:`Request timed out after ${s}ms`,details:{correlationId:e,action:t},correlationId:e}))}},s)),this._pending.set(e,{resolve:r,reject:n,timer:o,action:t,_handled:!1})}_promiseSend(e,t,s={},r={}){let n,o,i;const a=new Promise((a,c)=>{o=a,i=c;const d="number"==typeof r.timeoutMs?r.timeoutMs:"number"==typeof r.timeout?r.timeout:this.options.requestTimeoutMs;if(!this.wss||this.wss.readyState!==WebSocket.OPEN){if(d<=0)return c({category:I.WEBSOCKET,code:"WEBSOCKET_NOT_IN_OPEN_STATE",message:"WebSocket not open",details:null}),void 0;const r=this.buildPayload(e,t,s),o=this.buildMessageEnvelope(r,e,t,s?.headers||{});return n=o.headers.correlationId,this._registerPending(n,t,d,a,c),void 0}if(!R.has(t))return c({category:I.VALIDATION,code:"INVALID_ACTION",message:`Unsupported action '${t}'.`,details:{allowed:[...R]}}),void 0;const u=new Set(["session","request","headers"]);for(const e of Object.keys(s||{}))if(!u.has(e)){const t=[{instancePath:"",keyword:"additionalProperties",params:{additionalProperty:e},message:`must NOT have additional property '${e}'`}];return c({category:I.VALIDATION,code:"PAYLOAD_SCHEMA_MISMATCH",message:this.formatValidationErrorMessage(t),details:t}),void 0}const l=this.buildPayload(e,t,s),p=this.validateRequiredFields(l,t);if(!p.isValid)return c({category:I.VALIDATION,code:"REQUIRED_FIELDS_MISSING",message:`Missing required fields for action '${t}'`,details:p.errors}),void 0;if(this.options.strictValidation){const e=v(l);if(!e.valid)return c({category:I.VALIDATION,code:"PAYLOAD_SCHEMA_MISMATCH",message:this.formatValidationErrorMessage(e.errors,"Schema validation failed"),details:e.errors}),void 0}const h=this.buildMessageEnvelope(l,e,t,s?.headers||{});n=h.headers.correlationId,this._registerPending(n,t,d,a,c);const f=JSON.stringify(h);if(!this.isPayloadSizeValid(f)){const e=f.length,t=this.formatPayloadSizeError(e,U.MAX_PAYLOAD_SIZE_KB,h).message;return c({category:I.VALIDATION,code:"PAYLOAD_TOO_LARGE",message:t,details:{maxKb:U.MAX_PAYLOAD_SIZE_KB}}),void 0}try{this.wss.send(f)}catch(e){if(this._pending.has(n)){const e=this._pending.get(n);e.timer&&clearTimeout(e.timer),e._handled=!0,this._pending.delete(n)}c({category:I.WEBSOCKET,code:"SEND_FAILED",message:"Failed to send over WebSocket",details:e,correlationId:n})}});return a.correlationId=n,a}adjustAsync(e,t){return this._promiseSend("message","adjust",e,t)}elevateAsync(e,t){return this._promiseSend("message","elevate",e,t)}interactionAsync(e,t){return this._promiseSend("message","interaction",e,t)}receptionAsync(e,t){return this._promiseSend("message","reception",e,t)}customerInteractionAsync(e,t){return this.deprecate("method.customerInteractionAsync","[Deprecation] 'customerInteractionAsync' is deprecated; use 'interactionAsync' instead."),this._promiseSend("message","customerInteraction",e,t)}summarizeAsync(e,t){return this._promiseSend("message","summarize",e,t)}translateAsync(e,t){return this._promiseSend("message","translate",e,t)}recommendAsync(e,t){return this._promiseSend("message","recommend",e,t)}insightsAsync(e,t){return this._promiseSend("message","insights",e,t)}cancelRequest(e){if(this._pending.has(e)){const t=this._pending.get(e);return t.timer&&clearTimeout(t.timer),t._handled=!0,this._pending.delete(e),setTimeout(()=>{t.reject({category:I.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled",details:{correlationId:e},correlationId:e})},0),!0}return!1}cancelPendingRequests(e=!1){if(!this._pending)return 0;const t=this._pending.size,s=[...this._pending.entries()];for(const[t,r]of s)r.timer&&clearTimeout(r.timer),r._handled=!0,e?r.reject({category:I.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled during cleanup",details:{correlationId:t},correlationId:t}):queueMicrotask(()=>{r.reject({category:I.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled",details:{correlationId:t},correlationId:t})});return this._pending.clear(),t}cleanup(){
// CRITICAL: Clear EventEmitter state BEFORE calling removeAllListeners
if(this.closeConnection(),this.cancelPendingRequests(!0),this._deprecatedKeys&&this._deprecatedKeys.clear(),void 0!==this._warnedQueryToken&&delete this._warnedQueryToken,this._events)for(const e in this._events)delete this._events[e];this.removeAllListeners(),
// CRITICAL: Set EventEmitter properties to null AFTER removeAllListeners
this._events=null,this._eventsCount=null,this._maxListeners=null;
// CRITICAL: Clean up JSDOM contexts created by SDK loader
const e="server-umd";1,0,this._validatePayload=null,this._validateMessageEnvelope=null,this._emitError=null,this._ensureWebSocketImpl=null,this._handleInbound=null,this._promiseSend=null,this._registerPending=null,this._warnOnce=null,this.options=null,this.WebSocketImpl=null,this.wss=null,this.sessionId=null,this._pending=null,this._deprecatedKeys=null,this._silenceDeprecations=null,this._events=null,this._eventsCount=null,this._maxListeners=null}removeAllListeners(e){try{n.prototype.removeAllListeners.call(this,e)}catch(t){e?this._events&&this._events[e]&&(delete this._events[e],this._eventsCount=Math.max(0,this._eventsCount-1)):(this._events=Object.create(null),this._eventsCount=0)}return this}static get buildFlags(){const e="server-umd";return{SALESFORCE_BUILD:!0,INCLUDE_WS_REQUIRE:!1,SDK_VERSION:"3.2.3",WEBPACK_BUILD_TARGET:e,WEBPACK_BUILD_TARGET_NORMALIZED:B.normalize(e),BUILD_TARGET_INFO:B.getInfo(e)}}}const te=null;let se;se="undefined"!=typeof globalThis&&globalThis.crypto&&globalThis.crypto.getRandomValues?globalThis.crypto:"undefined"!=typeof window&&window.crypto&&window.crypto.getRandomValues?window.crypto:"undefined"!=typeof self&&self.crypto&&self.crypto.getRandomValues?self.crypto:{getRandomValues:function(e){for(let t=0;t<e.length;t++)e[t]=Math.floor(256*Math.random());return e}};class re{constructor(){this.timestamp=0,this.counter=0,this.random=this._getRandomNumberGenerator()}_getRandomNumberGenerator(){return void 0!==se&&void 0!==se.getRandomValues?new ne:{nextUint32:()=>65536*Math.trunc(65536*Math.random())+Math.trunc(65536*Math.random())}}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrResetCore(e,t){let s=this.generateOrAbortCore(e,t);return void 0===s&&(this.timestamp=0,s=this.generateOrAbortCore(e,t)),s}generateOrAbortCore(e,t){const s=4398046511103;if(!Number.isInteger(e)||e<1||e>0xffffffffffff)throw new RangeError("unixTsMs must be a 48-bit positive integer");if(e>this.timestamp)this.timestamp=e,this.resetCounter();else{if(!(e+t>=this.timestamp))return;this.counter++,this.counter>s&&(this.timestamp++,this.resetCounter())}return this.fromFieldsV7(this.timestamp,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=1024*this.random.nextUint32()+(1023&this.random.nextUint32())}fromFieldsV7(e,t,s,r){const n=new Uint8Array(16);return n[0]=e/2**40,n[1]=e/2**32,n[2]=e/2**24,n[3]=e/65536,n[4]=e/256,n[5]=e,n[6]=112|t>>>8,n[7]=t,n[8]=128|s>>>24,n[9]=s>>>16,n[10]=s>>>8,n[11]=s,n[12]=r>>>24,n[13]=r>>>16,n[14]=r>>>8,n[15]=r,this.bytesToString(n)}bytesToString(e){const t=Array.from(e,e=>e.toString(16).padStart(2,"0")).join("");return[t.substring(0,8),t.substring(8,12),t.substring(12,16),t.substring(16,20),t.substring(20,32)].join("-")}}class ne{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(se.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let oe=null;function ie(e,t){if(e&&!e.crypto)try{const s=Object.getOwnPropertyDescriptor(e,t);s&&!1===s.configurable||(e.crypto=se)}catch(t){console.debug("Cannot set crypto property on",e.constructor.name,":",t.message)}}se.randomUUID=function(){return oe||(oe=new re),oe.generate()},se.generateUUID=function(){return oe||(oe=new re),oe.generate()},
// Generate short ID using UUID v7 for cryptographic security
se.generateShortId=function(){return oe.generate().replace(/-/g,"").substring(0,9)},"undefined"!=typeof globalThis&&ie(globalThis,"crypto"),"undefined"!=typeof window&&ie(window,"crypto"),"undefined"!=typeof self&&ie(self,"crypto");try{"undefined"!=typeof module&&"object"==typeof module.exports&&"undefined"!=typeof require&&(module.exports=se,module.exports.default=se,module.exports.getRandomValues=se.getRandomValues.bind(se),module.exports.randomUUID=se.randomUUID?se.randomUUID.bind(se):se.randomUUID,module.exports.generateUUID=se.generateUUID.bind(se),module.exports.generateShortId=se.generateShortId.bind(se))}catch(e){}const ae=se.getRandomValues.bind(se),ce=se.randomUUID?se.randomUUID.bind(se):se.randomUUID,de=se.generateUUID.bind(se),ue=se.generateShortId.bind(se),le=null;if("undefined"!=typeof globalThis&&!globalThis.OptaveJavaScriptSDK)try{globalThis.OptaveJavaScriptSDK=OptaveJavaScriptSDK}catch{}const pe=OptaveJavaScriptSDK;return r=r.default})());