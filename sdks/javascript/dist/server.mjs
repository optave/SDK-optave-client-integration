import{default as e}from"events";import{createHash as t,randomFillSync as s,randomUUID as r}from"crypto";import{default as a}from"ws";const p=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;const i=function(e){return"string"==typeof e&&p.test(e)};const o=function(e){if(!i(e))throw TypeError("Invalid UUID");let t;return Uint8Array.of((t=parseInt(e.slice(0,8),16))>>>24,t>>>16&255,t>>>8&255,255&t,(t=parseInt(e.slice(9,13),16))>>>8,255&t,(t=parseInt(e.slice(14,18),16))>>>8,255&t,(t=parseInt(e.slice(19,23),16))>>>8,255&t,(t=parseInt(e.slice(24,36),16))/1099511627776&255,t/4294967296&255,t>>>24&255,t>>>16&255,t>>>8&255,255&t)},n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));function c(e,t=0){return(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase()}const u=new Uint8Array(256);let d=u.length;function m(){return d>u.length-16&&(s(u),d=0),u.slice(d,d+=16)}const y=function(e){return Array.isArray(e)?e=Buffer.from(e):"string"==typeof e&&(e=Buffer.from(e,"utf8")),t("md5").update(e).digest()};const h="6ba7b810-9dad-11d1-80b4-00c04fd430c8",l="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function g(e,t,s,r,a,p){const i="string"==typeof s?function(e){e=unescape(encodeURIComponent(e));const t=new Uint8Array(e.length);for(let s=0;s<e.length;++s)t[s]=e.charCodeAt(s);return t}(s):s,n="string"==typeof r?o(r):r;if("string"==typeof r&&(r=o(r)),16!==r?.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let u=new Uint8Array(16+i.length);if(u.set(n),u.set(i,n.length),u=t(u),u[6]=15&u[6]|e,u[8]=63&u[8]|128,a){p=p||0;for(let e=0;e<16;++e)a[p+e]=u[e];return a}return c(u)}function f(e,t,s,r){return g(48,y,e,t,s,r)}f.DNS=h,f.URL=l;const b=function(e){return Array.isArray(e)?e=Buffer.from(e):"string"==typeof e&&(e=Buffer.from(e,"utf8")),t("sha1").update(e).digest()};function v(e,t,s,r){return g(80,b,e,t,s,r)}v.DNS=h,v.URL=l;const q={};function P(e,t,s,r,a=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(r){if(a<0||a+16>r.length)throw new RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`)}else r=new Uint8Array(16),a=0;return t??=Date.now(),s??=127*e[6]<<24|e[7]<<16|e[8]<<8|e[9],r[a++]=t/1099511627776&255,r[a++]=t/4294967296&255,r[a++]=t/16777216&255,r[a++]=t/65536&255,r[a++]=t/256&255,r[a++]=255&t,r[a++]=112|s>>>28&15,r[a++]=s>>>20&255,r[a++]=128|s>>>14&63,r[a++]=s>>>6&255,r[a++]=s<<2&255|3&e[10],r[a++]=e[11],r[a++]=e[12],r[a++]=e[13],r[a++]=e[14],r[a++]=e[15],r}const S=function(e,t,s){let r;if(e)r=P(e.random??e.rng?.()??m(),e.msecs,e.seq,t,s);else{const e=Date.now(),a=m();!function(e,t,s){e.msecs??=-1/0,e.seq??=0,t>e.msecs?(e.seq=s[6]<<23|s[7]<<16|s[8]<<8|s[9],e.msecs=t):(e.seq=e.seq+1|0,0===e.seq&&e.msecs++)}(q,e,a),r=P(a,q.msecs,q.seq,t,s)}return t??c(r)};const I={type:"object",required:["action","headers","payload"],properties:{action:{type:"string",enum:["message"],description:"Action type for the envelope"},headers:{type:"object",required:["correlationId","action","schemaRef"],properties:{correlationId:{type:"string",format:"uuidv7",description:"UUID for correlating request-response pairs (always generated client-side unless overridden)"},tenantId:{type:"string",description:"Tenant identifier provided by Optave"},traceId:{type:"string",format:"uuidv7",description:"Optional cross-system tracing ID (forwarded if provided)"},idempotencyKey:{type:"string",format:"uuidv7",description:"Optional idempotency key; forwarded unchanged if provided"},identifier:{type:"string",enum:["message"],description:"Message identifier"},action:{type:"string",enum:["adjust","elevate","customerinteraction","interaction","reception","summarize","translate","recommend","insights"],description:"Specific action being performed"},schemaRef:{type:"string",enum:["optave.message.v3"],description:"Schema reference for the envelope (major version only; minor/patch changes are non-breaking)"},sdkVersion:{type:"string",description:"SDK package version (independent of schemaRef major)"},networkLatencyMs:{type:"number",description:"Optional client-measured round-trip latency (not sent unless explicitly supplied)"},timestamp:{type:"string",format:"date-time",description:"ISO 8601 client timestamp when the message was built"},issuedAt:{type:"string",format:"date-time",description:"Message issued timestamp"}}},payload:{$ref:"Payload"}},allOf:[{type:"object",required:["action","headers","payload"],properties:{action:{type:"string",enum:["message"]},headers:{type:"object"},payload:{type:"object"}}},{if:{properties:{headers:{properties:{action:{enum:["adjust","elevate","interaction","customerInteraction"]}}}}},then:{properties:{payload:{$ref:"PayloadWithRequiredConversations"}}}},{if:{properties:{headers:{properties:{action:{enum:["summarize","translate","insights","recommend"]}}}}},then:{properties:{payload:{$ref:"PayloadWithRequiredConversations"}}}}]},w={allOf:[{$ref:"Payload"},{type:"object",required:["request"],properties:{request:{type:"object",required:["scope"],properties:{scope:{type:"object",required:["conversations"],properties:{conversations:{type:"array",minItems:1,items:{$ref:"Conversation"}}}}}}}}]},k={type:"object",required:["session","request"],properties:{session:{$ref:"Session"},request:{type:"object",required:["requestId"],properties:{requestId:{type:"string",description:"Unique request identifier"},attributes:{$ref:"RequestAttributes"},connections:{$ref:"Connections"},context:{$ref:"Context"},reference:{type:"object",properties:{ids:{type:"array",items:{$ref:"ReferenceId"}},labels:{type:"array",description:"Reference labels"},tags:{type:"array",description:"Reference tags"}}},resources:{type:"object",properties:{codes:{type:"array",items:{$ref:"CodesItem"}},links:{type:"array",items:{$ref:"LinkItem"}},offers:{type:"array",description:"Offering details (previously offering_details in v2)"}}},scope:{type:"object",properties:{accounts:{type:"array"},appointments:{type:"array"},assets:{type:"array"},bookings:{type:"array"},cases:{type:"array"},conversations:{type:"array",items:{$ref:"Conversation"}},documents:{type:"array"},events:{type:"array"},interactions:{type:"array",items:{$ref:"Interaction"}},items:{type:"array"},locations:{type:"array"},offers:{type:"array"},operators:{type:"array"},orders:{type:"array"},organizations:{type:"array"},persons:{type:"array"},policies:{type:"array"},products:{type:"array",items:{$ref:"Product"}},properties:{type:"array"},services:{type:"array"},subscriptions:{type:"array"},tickets:{type:"array"},transactions:{type:"array"},users:{type:"array"}}},settings:{type:"object",properties:{disableBrowsing:{type:"boolean",default:!1},disableSearch:{type:"boolean",default:!1},disableSources:{type:"boolean",default:!1},disableStream:{type:"boolean",default:!0},disableTools:{type:"boolean",default:!1},maxResponseLength:{type:"number",default:0},overrideInterfaceLanguage:{type:"string",description:"Override interface language"},overrideOutputLanguage:{type:"string",description:"Override output language (replaces channel language)"}}},a2a:{type:"array",items:{$ref:"A2AConfiguration"},description:"Advanced mode agent-to-agent configuration"},cursor:{$ref:"Cursor"}}}}},A={type:"object",properties:{content:{type:"string",description:"Content to be processed"},instruction:{type:"string",description:"Specific instruction for the action"},variant:{type:"string",description:'Variant identifier (e.g., "A", "B")'}}},E={type:"object",properties:{journeyId:{type:"string",description:"Journey identifier"},parentId:{type:"string",description:"Parent request ID (previously trace_parent_ID in v2)"},threadId:{type:"string",description:"Thread ID that remains unique across all requests related to same ticket/case/conversation"}}},_={type:"object",properties:{caseId:{type:"string",description:"Case identifier (advanced mode)"},departmentId:{type:"string",description:"Department identifier (advanced mode)"},operatorId:{type:"string",description:"Operator identifier (advanced mode)"},organizationId:{type:"string",description:"Organization identifier"},userId:{type:"string",description:"User identifier (advanced mode)"}}},j={type:"object",properties:{name:{type:"string"},value:{type:"string"}}},O={type:"object",properties:{id:{type:"string",description:"Optional for tracking/mapping"},label:{type:"string",description:'Optional, helps for display/templating (e.g., "Order Number")'},type:{type:"string",description:'Code type (e.g., "order_number", "booking_reference", "ticket_code")'},value:{type:"string",description:'Code value (e.g., "ORD-56789")'}}},R={type:"object",properties:{expires_at:{type:"string",description:"Optional expiration timestamp"},html:{type:"boolean",description:"Optional HTML flag"},id:{type:"string",description:"Optional link identifier"},label:{type:"string",description:'Optional label (e.g., "Click here to pay")'},type:{type:"string",description:'Link type (e.g., "payment_link")'},url:{type:"string",description:'URL (e.g., "https://checkout.stripe.com/pay/cs_test...")'}}},T={type:"object",properties:{content:{type:"string"},id:{type:"string"},name:{type:"string"},role:{type:"string"},timestamp:{type:"string"}}},C={type:"object",properties:{id:{type:"string"}}},L={type:"object",properties:{id:{type:"string"},name:{type:"string"},type:{type:"string"}},description:"Advanced mode agent-to-agent configuration"},D={type:"object",properties:{since:{type:"string",description:'Start timestamp (e.g., "2024-01-15T10:30:00.000Z")'},until:{type:"string",description:'End timestamp (e.g., "2024-01-15T11:00:00.000Z")'}}},N={type:"object",properties:{sessionId:{type:"string",description:"Unique session identifier lasting for duration of chat session or call"},channel:{$ref:"Channel"},interface:{$ref:"Interface"}}},U={type:"object",properties:{browser:{type:"string",description:"Browser information"},deviceInfo:{type:"string",description:'Device information (e.g., "iOS/18.2, iPhone15,3")'},deviceType:{type:"string",description:"Type of device"},language:{type:"string",description:"Interface language"},location:{type:"string",description:'Geographic location (e.g., "45.42,-75.69")'},medium:{type:"string",enum:["chat","voice","email"],description:"Communication medium (allowed: chat, voice, email; default is chat if omitted)"},metadata:{type:"array",description:"Custom metadata array"},section:{type:"string",description:'Section of the application (e.g., "cart", "product_page")'}}},M={type:"object",properties:{appVersion:{type:"string",description:"Custom application version"},category:{type:"string",description:'Interface category (e.g., "crm", "app", "auto", "widget")'},language:{type:"string",description:"Language from the CRM agent"},name:{type:"string",description:'Interface name (e.g., "salesforce", "zendesk")'},type:{type:"string",description:'Interface type (e.g., "custom_components", "marketplace", "channel")'}}};function W(e,{instancePath:t="",parentData:s,parentDataProperty:r,rootData:a=e}={}){let p=null,i=0;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.sessionId){let s=e.sessionId;if("string"!=typeof s){const e={instancePath:t+"/sessionId",schemaPath:"#/properties/sessionId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:N.properties.sessionId.type,parentSchema:N.properties.sessionId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.channel){let s=e.channel;if(s&&"object"==typeof s&&!Array.isArray(s)){if(void 0!==s.browser){let e=s.browser;if("string"!=typeof e){const s={instancePath:t+"/channel/browser",schemaPath:"Channel/properties/browser/type",keyword:"type",params:{type:"string"},message:"must be string",schema:U.properties.browser.type,parentSchema:U.properties.browser,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.deviceInfo){let e=s.deviceInfo;if("string"!=typeof e){const s={instancePath:t+"/channel/deviceInfo",schemaPath:"Channel/properties/deviceInfo/type",keyword:"type",params:{type:"string"},message:"must be string",schema:U.properties.deviceInfo.type,parentSchema:U.properties.deviceInfo,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.deviceType){let e=s.deviceType;if("string"!=typeof e){const s={instancePath:t+"/channel/deviceType",schemaPath:"Channel/properties/deviceType/type",keyword:"type",params:{type:"string"},message:"must be string",schema:U.properties.deviceType.type,parentSchema:U.properties.deviceType,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.language){let e=s.language;if("string"!=typeof e){const s={instancePath:t+"/channel/language",schemaPath:"Channel/properties/language/type",keyword:"type",params:{type:"string"},message:"must be string",schema:U.properties.language.type,parentSchema:U.properties.language,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.location){let e=s.location;if("string"!=typeof e){const s={instancePath:t+"/channel/location",schemaPath:"Channel/properties/location/type",keyword:"type",params:{type:"string"},message:"must be string",schema:U.properties.location.type,parentSchema:U.properties.location,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.medium){let e=s.medium;if("string"!=typeof e){const s={instancePath:t+"/channel/medium",schemaPath:"Channel/properties/medium/type",keyword:"type",params:{type:"string"},message:"must be string",schema:U.properties.medium.type,parentSchema:U.properties.medium,data:e};null===p?p=[s]:p.push(s),i++}if("chat"!==e&&"voice"!==e&&"email"!==e){const s={instancePath:t+"/channel/medium",schemaPath:"Channel/properties/medium/enum",keyword:"enum",params:{allowedValues:U.properties.medium.enum},message:"must be equal to one of the allowed values",schema:U.properties.medium.enum,parentSchema:U.properties.medium,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.metadata){let e=s.metadata;if(!Array.isArray(e)){const s={instancePath:t+"/channel/metadata",schemaPath:"Channel/properties/metadata/type",keyword:"type",params:{type:"array"},message:"must be array",schema:U.properties.metadata.type,parentSchema:U.properties.metadata,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.section){let e=s.section;if("string"!=typeof e){const s={instancePath:t+"/channel/section",schemaPath:"Channel/properties/section/type",keyword:"type",params:{type:"string"},message:"must be string",schema:U.properties.section.type,parentSchema:U.properties.section,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/channel",schemaPath:"Channel/type",keyword:"type",params:{type:"object"},message:"must be object",schema:U.type,parentSchema:U,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.interface){let s=e.interface;if(s&&"object"==typeof s&&!Array.isArray(s)){if(void 0!==s.appVersion){let e=s.appVersion;if("string"!=typeof e){const s={instancePath:t+"/interface/appVersion",schemaPath:"Interface/properties/appVersion/type",keyword:"type",params:{type:"string"},message:"must be string",schema:M.properties.appVersion.type,parentSchema:M.properties.appVersion,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.category){let e=s.category;if("string"!=typeof e){const s={instancePath:t+"/interface/category",schemaPath:"Interface/properties/category/type",keyword:"type",params:{type:"string"},message:"must be string",schema:M.properties.category.type,parentSchema:M.properties.category,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.language){let e=s.language;if("string"!=typeof e){const s={instancePath:t+"/interface/language",schemaPath:"Interface/properties/language/type",keyword:"type",params:{type:"string"},message:"must be string",schema:M.properties.language.type,parentSchema:M.properties.language,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.name){let e=s.name;if("string"!=typeof e){const s={instancePath:t+"/interface/name",schemaPath:"Interface/properties/name/type",keyword:"type",params:{type:"string"},message:"must be string",schema:M.properties.name.type,parentSchema:M.properties.name,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.type){let e=s.type;if("string"!=typeof e){const s={instancePath:t+"/interface/type",schemaPath:"Interface/properties/type/type",keyword:"type",params:{type:"string"},message:"must be string",schema:M.properties.type.type,parentSchema:M.properties.type,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/interface",schemaPath:"Interface/type",keyword:"type",params:{type:"object"},message:"must be object",schema:M.type,parentSchema:M,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t,schemaPath:"#/type",keyword:"type",params:{type:"object"},message:"must be object",schema:N.type,parentSchema:N,data:e};null===p?p=[s]:p.push(s),i++}return W.errors=p,0===i}const V={type:"object",properties:{conversationId:{type:"string"},participants:{type:"array",items:{$ref:"Participant"}},messages:{type:"array",items:{$ref:"Message"}},metadata:{type:"object"}}},$={type:"object",properties:{participantId:{type:"string"},displayName:{type:"string"},role:{type:"string",enum:["operator","user","bot"]}}},B={type:"object",properties:{content:{type:"string"},participantId:{type:"string"},timestamp:{type:"string"}}};function x(e,{instancePath:t="",parentData:s,parentDataProperty:r,rootData:a=e}={}){let p=null,i=0;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.conversationId){let s=e.conversationId;if("string"!=typeof s){const e={instancePath:t+"/conversationId",schemaPath:"#/properties/conversationId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:V.properties.conversationId.type,parentSchema:V.properties.conversationId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.participants){let s=e.participants;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.participantId){let s=e.participantId;if("string"!=typeof s){const e={instancePath:t+"/participants/"+r+"/participantId",schemaPath:"Participant/properties/participantId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:$.properties.participantId.type,parentSchema:$.properties.participantId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.displayName){let s=e.displayName;if("string"!=typeof s){const e={instancePath:t+"/participants/"+r+"/displayName",schemaPath:"Participant/properties/displayName/type",keyword:"type",params:{type:"string"},message:"must be string",schema:$.properties.displayName.type,parentSchema:$.properties.displayName,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.role){let s=e.role;if("string"!=typeof s){const e={instancePath:t+"/participants/"+r+"/role",schemaPath:"Participant/properties/role/type",keyword:"type",params:{type:"string"},message:"must be string",schema:$.properties.role.type,parentSchema:$.properties.role,data:s};null===p?p=[e]:p.push(e),i++}if("operator"!==s&&"user"!==s&&"bot"!==s){const e={instancePath:t+"/participants/"+r+"/role",schemaPath:"Participant/properties/role/enum",keyword:"enum",params:{allowedValues:$.properties.role.enum},message:"must be equal to one of the allowed values",schema:$.properties.role.enum,parentSchema:$.properties.role,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/participants/"+r,schemaPath:"Participant/type",keyword:"type",params:{type:"object"},message:"must be object",schema:$.type,parentSchema:$,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/participants",schemaPath:"#/properties/participants/type",keyword:"type",params:{type:"array"},message:"must be array",schema:V.properties.participants.type,parentSchema:V.properties.participants,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.messages){let s=e.messages;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.content){let s=e.content;if("string"!=typeof s){const e={instancePath:t+"/messages/"+r+"/content",schemaPath:"Message/properties/content/type",keyword:"type",params:{type:"string"},message:"must be string",schema:B.properties.content.type,parentSchema:B.properties.content,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.participantId){let s=e.participantId;if("string"!=typeof s){const e={instancePath:t+"/messages/"+r+"/participantId",schemaPath:"Message/properties/participantId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:B.properties.participantId.type,parentSchema:B.properties.participantId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.timestamp){let s=e.timestamp;if("string"!=typeof s){const e={instancePath:t+"/messages/"+r+"/timestamp",schemaPath:"Message/properties/timestamp/type",keyword:"type",params:{type:"string"},message:"must be string",schema:B.properties.timestamp.type,parentSchema:B.properties.timestamp,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/messages/"+r,schemaPath:"Message/type",keyword:"type",params:{type:"object"},message:"must be object",schema:B.type,parentSchema:B,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/messages",schemaPath:"#/properties/messages/type",keyword:"type",params:{type:"array"},message:"must be array",schema:V.properties.messages.type,parentSchema:V.properties.messages,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.metadata){let s=e.metadata;if(!s||"object"!=typeof s||Array.isArray(s)){const e={instancePath:t+"/metadata",schemaPath:"#/properties/metadata/type",keyword:"type",params:{type:"object"},message:"must be object",schema:V.properties.metadata.type,parentSchema:V.properties.metadata,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t,schemaPath:"#/type",keyword:"type",params:{type:"object"},message:"must be object",schema:V.type,parentSchema:V,data:e};null===p?p=[s]:p.push(s),i++}return x.errors=p,0===i}function K(e,{instancePath:t="",parentData:s,parentDataProperty:r,rootData:a=e}={}){let p=null,i=0;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0===e.session){const s={instancePath:t,schemaPath:"#/required",keyword:"required",params:{missingProperty:"session"},message:"must have required property 'session'",schema:k.required,parentSchema:k,data:e};null===p?p=[s]:p.push(s),i++}if(void 0===e.request){const s={instancePath:t,schemaPath:"#/required",keyword:"required",params:{missingProperty:"request"},message:"must have required property 'request'",schema:k.required,parentSchema:k,data:e};null===p?p=[s]:p.push(s),i++}if(void 0!==e.session&&(W(e.session,{instancePath:t+"/session",parentData:e,parentDataProperty:"session",rootData:a})||(p=null===p?W.errors:p.concat(W.errors),i=p.length)),void 0!==e.request){let s=e.request;if(s&&"object"==typeof s&&!Array.isArray(s)){if(void 0===s.requestId){const e={instancePath:t+"/request",schemaPath:"#/properties/request/required",keyword:"required",params:{missingProperty:"requestId"},message:"must have required property 'requestId'",schema:k.properties.request.required,parentSchema:k.properties.request,data:s};null===p?p=[e]:p.push(e),i++}if(void 0!==s.requestId){let e=s.requestId;if("string"!=typeof e){const s={instancePath:t+"/request/requestId",schemaPath:"#/properties/request/properties/requestId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:k.properties.request.properties.requestId.type,parentSchema:k.properties.request.properties.requestId,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.attributes){let e=s.attributes;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.content){let s=e.content;if("string"!=typeof s){const e={instancePath:t+"/request/attributes/content",schemaPath:"RequestAttributes/properties/content/type",keyword:"type",params:{type:"string"},message:"must be string",schema:A.properties.content.type,parentSchema:A.properties.content,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.instruction){let s=e.instruction;if("string"!=typeof s){const e={instancePath:t+"/request/attributes/instruction",schemaPath:"RequestAttributes/properties/instruction/type",keyword:"type",params:{type:"string"},message:"must be string",schema:A.properties.instruction.type,parentSchema:A.properties.instruction,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.variant){let s=e.variant;if("string"!=typeof s){const e={instancePath:t+"/request/attributes/variant",schemaPath:"RequestAttributes/properties/variant/type",keyword:"type",params:{type:"string"},message:"must be string",schema:A.properties.variant.type,parentSchema:A.properties.variant,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/attributes",schemaPath:"RequestAttributes/type",keyword:"type",params:{type:"object"},message:"must be object",schema:A.type,parentSchema:A,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.connections){let e=s.connections;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.journeyId){let s=e.journeyId;if("string"!=typeof s){const e={instancePath:t+"/request/connections/journeyId",schemaPath:"Connections/properties/journeyId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:E.properties.journeyId.type,parentSchema:E.properties.journeyId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.parentId){let s=e.parentId;if("string"!=typeof s){const e={instancePath:t+"/request/connections/parentId",schemaPath:"Connections/properties/parentId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:E.properties.parentId.type,parentSchema:E.properties.parentId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.threadId){let s=e.threadId;if("string"!=typeof s){const e={instancePath:t+"/request/connections/threadId",schemaPath:"Connections/properties/threadId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:E.properties.threadId.type,parentSchema:E.properties.threadId,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/connections",schemaPath:"Connections/type",keyword:"type",params:{type:"object"},message:"must be object",schema:E.type,parentSchema:E,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.context){let e=s.context;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.caseId){let s=e.caseId;if("string"!=typeof s){const e={instancePath:t+"/request/context/caseId",schemaPath:"Context/properties/caseId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:_.properties.caseId.type,parentSchema:_.properties.caseId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.departmentId){let s=e.departmentId;if("string"!=typeof s){const e={instancePath:t+"/request/context/departmentId",schemaPath:"Context/properties/departmentId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:_.properties.departmentId.type,parentSchema:_.properties.departmentId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.operatorId){let s=e.operatorId;if("string"!=typeof s){const e={instancePath:t+"/request/context/operatorId",schemaPath:"Context/properties/operatorId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:_.properties.operatorId.type,parentSchema:_.properties.operatorId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.organizationId){let s=e.organizationId;if("string"!=typeof s){const e={instancePath:t+"/request/context/organizationId",schemaPath:"Context/properties/organizationId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:_.properties.organizationId.type,parentSchema:_.properties.organizationId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.userId){let s=e.userId;if("string"!=typeof s){const e={instancePath:t+"/request/context/userId",schemaPath:"Context/properties/userId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:_.properties.userId.type,parentSchema:_.properties.userId,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/context",schemaPath:"Context/type",keyword:"type",params:{type:"object"},message:"must be object",schema:_.type,parentSchema:_,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.reference){let e=s.reference;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.ids){let s=e.ids;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.name){let s=e.name;if("string"!=typeof s){const e={instancePath:t+"/request/reference/ids/"+r+"/name",schemaPath:"ReferenceId/properties/name/type",keyword:"type",params:{type:"string"},message:"must be string",schema:j.properties.name.type,parentSchema:j.properties.name,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.value){let s=e.value;if("string"!=typeof s){const e={instancePath:t+"/request/reference/ids/"+r+"/value",schemaPath:"ReferenceId/properties/value/type",keyword:"type",params:{type:"string"},message:"must be string",schema:j.properties.value.type,parentSchema:j.properties.value,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/reference/ids/"+r,schemaPath:"ReferenceId/type",keyword:"type",params:{type:"object"},message:"must be object",schema:j.type,parentSchema:j,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/request/reference/ids",schemaPath:"#/properties/request/properties/reference/properties/ids/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.reference.properties.ids.type,parentSchema:k.properties.request.properties.reference.properties.ids,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.labels){let s=e.labels;if(!Array.isArray(s)){const e={instancePath:t+"/request/reference/labels",schemaPath:"#/properties/request/properties/reference/properties/labels/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.reference.properties.labels.type,parentSchema:k.properties.request.properties.reference.properties.labels,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.tags){let s=e.tags;if(!Array.isArray(s)){const e={instancePath:t+"/request/reference/tags",schemaPath:"#/properties/request/properties/reference/properties/tags/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.reference.properties.tags.type,parentSchema:k.properties.request.properties.reference.properties.tags,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/reference",schemaPath:"#/properties/request/properties/reference/type",keyword:"type",params:{type:"object"},message:"must be object",schema:k.properties.request.properties.reference.type,parentSchema:k.properties.request.properties.reference,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.resources){let e=s.resources;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.codes){let s=e.codes;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.id){let s=e.id;if("string"!=typeof s){const e={instancePath:t+"/request/resources/codes/"+r+"/id",schemaPath:"CodesItem/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:O.properties.id.type,parentSchema:O.properties.id,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.label){let s=e.label;if("string"!=typeof s){const e={instancePath:t+"/request/resources/codes/"+r+"/label",schemaPath:"CodesItem/properties/label/type",keyword:"type",params:{type:"string"},message:"must be string",schema:O.properties.label.type,parentSchema:O.properties.label,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.type){let s=e.type;if("string"!=typeof s){const e={instancePath:t+"/request/resources/codes/"+r+"/type",schemaPath:"CodesItem/properties/type/type",keyword:"type",params:{type:"string"},message:"must be string",schema:O.properties.type.type,parentSchema:O.properties.type,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.value){let s=e.value;if("string"!=typeof s){const e={instancePath:t+"/request/resources/codes/"+r+"/value",schemaPath:"CodesItem/properties/value/type",keyword:"type",params:{type:"string"},message:"must be string",schema:O.properties.value.type,parentSchema:O.properties.value,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/resources/codes/"+r,schemaPath:"CodesItem/type",keyword:"type",params:{type:"object"},message:"must be object",schema:O.type,parentSchema:O,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/request/resources/codes",schemaPath:"#/properties/request/properties/resources/properties/codes/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.resources.properties.codes.type,parentSchema:k.properties.request.properties.resources.properties.codes,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.links){let s=e.links;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.expires_at){let s=e.expires_at;if("string"!=typeof s){const e={instancePath:t+"/request/resources/links/"+r+"/expires_at",schemaPath:"LinkItem/properties/expires_at/type",keyword:"type",params:{type:"string"},message:"must be string",schema:R.properties.expires_at.type,parentSchema:R.properties.expires_at,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.html){let s=e.html;if("boolean"!=typeof s){const e={instancePath:t+"/request/resources/links/"+r+"/html",schemaPath:"LinkItem/properties/html/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:R.properties.html.type,parentSchema:R.properties.html,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.id){let s=e.id;if("string"!=typeof s){const e={instancePath:t+"/request/resources/links/"+r+"/id",schemaPath:"LinkItem/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:R.properties.id.type,parentSchema:R.properties.id,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.label){let s=e.label;if("string"!=typeof s){const e={instancePath:t+"/request/resources/links/"+r+"/label",schemaPath:"LinkItem/properties/label/type",keyword:"type",params:{type:"string"},message:"must be string",schema:R.properties.label.type,parentSchema:R.properties.label,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.type){let s=e.type;if("string"!=typeof s){const e={instancePath:t+"/request/resources/links/"+r+"/type",schemaPath:"LinkItem/properties/type/type",keyword:"type",params:{type:"string"},message:"must be string",schema:R.properties.type.type,parentSchema:R.properties.type,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.url){let s=e.url;if("string"!=typeof s){const e={instancePath:t+"/request/resources/links/"+r+"/url",schemaPath:"LinkItem/properties/url/type",keyword:"type",params:{type:"string"},message:"must be string",schema:R.properties.url.type,parentSchema:R.properties.url,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/resources/links/"+r,schemaPath:"LinkItem/type",keyword:"type",params:{type:"object"},message:"must be object",schema:R.type,parentSchema:R,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/request/resources/links",schemaPath:"#/properties/request/properties/resources/properties/links/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.resources.properties.links.type,parentSchema:k.properties.request.properties.resources.properties.links,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.offers){let s=e.offers;if(!Array.isArray(s)){const e={instancePath:t+"/request/resources/offers",schemaPath:"#/properties/request/properties/resources/properties/offers/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.resources.properties.offers.type,parentSchema:k.properties.request.properties.resources.properties.offers,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/resources",schemaPath:"#/properties/request/properties/resources/type",keyword:"type",params:{type:"object"},message:"must be object",schema:k.properties.request.properties.resources.type,parentSchema:k.properties.request.properties.resources,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.scope){let e=s.scope;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.accounts){let s=e.accounts;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/accounts",schemaPath:"#/properties/request/properties/scope/properties/accounts/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.accounts.type,parentSchema:k.properties.request.properties.scope.properties.accounts,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.appointments){let s=e.appointments;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/appointments",schemaPath:"#/properties/request/properties/scope/properties/appointments/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.appointments.type,parentSchema:k.properties.request.properties.scope.properties.appointments,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.assets){let s=e.assets;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/assets",schemaPath:"#/properties/request/properties/scope/properties/assets/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.assets.type,parentSchema:k.properties.request.properties.scope.properties.assets,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.bookings){let s=e.bookings;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/bookings",schemaPath:"#/properties/request/properties/scope/properties/bookings/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.bookings.type,parentSchema:k.properties.request.properties.scope.properties.bookings,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.cases){let s=e.cases;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/cases",schemaPath:"#/properties/request/properties/scope/properties/cases/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.cases.type,parentSchema:k.properties.request.properties.scope.properties.cases,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.conversations){let s=e.conversations;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++)x(s[r],{instancePath:t+"/request/scope/conversations/"+r,parentData:s,parentDataProperty:r,rootData:a})||(p=null===p?x.errors:p.concat(x.errors),i=p.length)}else{const e={instancePath:t+"/request/scope/conversations",schemaPath:"#/properties/request/properties/scope/properties/conversations/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.conversations.type,parentSchema:k.properties.request.properties.scope.properties.conversations,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.documents){let s=e.documents;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/documents",schemaPath:"#/properties/request/properties/scope/properties/documents/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.documents.type,parentSchema:k.properties.request.properties.scope.properties.documents,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.events){let s=e.events;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/events",schemaPath:"#/properties/request/properties/scope/properties/events/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.events.type,parentSchema:k.properties.request.properties.scope.properties.events,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.interactions){let s=e.interactions;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.content){let s=e.content;if("string"!=typeof s){const e={instancePath:t+"/request/scope/interactions/"+r+"/content",schemaPath:"Interaction/properties/content/type",keyword:"type",params:{type:"string"},message:"must be string",schema:T.properties.content.type,parentSchema:T.properties.content,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.id){let s=e.id;if("string"!=typeof s){const e={instancePath:t+"/request/scope/interactions/"+r+"/id",schemaPath:"Interaction/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:T.properties.id.type,parentSchema:T.properties.id,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.name){let s=e.name;if("string"!=typeof s){const e={instancePath:t+"/request/scope/interactions/"+r+"/name",schemaPath:"Interaction/properties/name/type",keyword:"type",params:{type:"string"},message:"must be string",schema:T.properties.name.type,parentSchema:T.properties.name,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.role){let s=e.role;if("string"!=typeof s){const e={instancePath:t+"/request/scope/interactions/"+r+"/role",schemaPath:"Interaction/properties/role/type",keyword:"type",params:{type:"string"},message:"must be string",schema:T.properties.role.type,parentSchema:T.properties.role,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.timestamp){let s=e.timestamp;if("string"!=typeof s){const e={instancePath:t+"/request/scope/interactions/"+r+"/timestamp",schemaPath:"Interaction/properties/timestamp/type",keyword:"type",params:{type:"string"},message:"must be string",schema:T.properties.timestamp.type,parentSchema:T.properties.timestamp,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/scope/interactions/"+r,schemaPath:"Interaction/type",keyword:"type",params:{type:"object"},message:"must be object",schema:T.type,parentSchema:T,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/request/scope/interactions",schemaPath:"#/properties/request/properties/scope/properties/interactions/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.interactions.type,parentSchema:k.properties.request.properties.scope.properties.interactions,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.items){let s=e.items;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/items",schemaPath:"#/properties/request/properties/scope/properties/items/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.items.type,parentSchema:k.properties.request.properties.scope.properties.items,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.locations){let s=e.locations;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/locations",schemaPath:"#/properties/request/properties/scope/properties/locations/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.locations.type,parentSchema:k.properties.request.properties.scope.properties.locations,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.offers){let s=e.offers;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/offers",schemaPath:"#/properties/request/properties/scope/properties/offers/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.offers.type,parentSchema:k.properties.request.properties.scope.properties.offers,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.operators){let s=e.operators;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/operators",schemaPath:"#/properties/request/properties/scope/properties/operators/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.operators.type,parentSchema:k.properties.request.properties.scope.properties.operators,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.orders){let s=e.orders;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/orders",schemaPath:"#/properties/request/properties/scope/properties/orders/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.orders.type,parentSchema:k.properties.request.properties.scope.properties.orders,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.organizations){let s=e.organizations;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/organizations",schemaPath:"#/properties/request/properties/scope/properties/organizations/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.organizations.type,parentSchema:k.properties.request.properties.scope.properties.organizations,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.persons){let s=e.persons;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/persons",schemaPath:"#/properties/request/properties/scope/properties/persons/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.persons.type,parentSchema:k.properties.request.properties.scope.properties.persons,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.policies){let s=e.policies;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/policies",schemaPath:"#/properties/request/properties/scope/properties/policies/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.policies.type,parentSchema:k.properties.request.properties.scope.properties.policies,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.products){let s=e.products;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.id){let s=e.id;if("string"!=typeof s){const e={instancePath:t+"/request/scope/products/"+r+"/id",schemaPath:"Product/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:C.properties.id.type,parentSchema:C.properties.id,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/scope/products/"+r,schemaPath:"Product/type",keyword:"type",params:{type:"object"},message:"must be object",schema:C.type,parentSchema:C,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/request/scope/products",schemaPath:"#/properties/request/properties/scope/properties/products/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.products.type,parentSchema:k.properties.request.properties.scope.properties.products,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.properties){let s=e.properties;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/properties",schemaPath:"#/properties/request/properties/scope/properties/properties/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.properties.type,parentSchema:k.properties.request.properties.scope.properties.properties,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.services){let s=e.services;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/services",schemaPath:"#/properties/request/properties/scope/properties/services/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.services.type,parentSchema:k.properties.request.properties.scope.properties.services,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.subscriptions){let s=e.subscriptions;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/subscriptions",schemaPath:"#/properties/request/properties/scope/properties/subscriptions/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.subscriptions.type,parentSchema:k.properties.request.properties.scope.properties.subscriptions,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.tickets){let s=e.tickets;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/tickets",schemaPath:"#/properties/request/properties/scope/properties/tickets/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.tickets.type,parentSchema:k.properties.request.properties.scope.properties.tickets,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.transactions){let s=e.transactions;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/transactions",schemaPath:"#/properties/request/properties/scope/properties/transactions/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.transactions.type,parentSchema:k.properties.request.properties.scope.properties.transactions,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.users){let s=e.users;if(!Array.isArray(s)){const e={instancePath:t+"/request/scope/users",schemaPath:"#/properties/request/properties/scope/properties/users/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.scope.properties.users.type,parentSchema:k.properties.request.properties.scope.properties.users,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/scope",schemaPath:"#/properties/request/properties/scope/type",keyword:"type",params:{type:"object"},message:"must be object",schema:k.properties.request.properties.scope.type,parentSchema:k.properties.request.properties.scope,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.settings){let e=s.settings;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.disableBrowsing){let s=e.disableBrowsing;if("boolean"!=typeof s){const e={instancePath:t+"/request/settings/disableBrowsing",schemaPath:"#/properties/request/properties/settings/properties/disableBrowsing/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:k.properties.request.properties.settings.properties.disableBrowsing.type,parentSchema:k.properties.request.properties.settings.properties.disableBrowsing,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.disableSearch){let s=e.disableSearch;if("boolean"!=typeof s){const e={instancePath:t+"/request/settings/disableSearch",schemaPath:"#/properties/request/properties/settings/properties/disableSearch/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:k.properties.request.properties.settings.properties.disableSearch.type,parentSchema:k.properties.request.properties.settings.properties.disableSearch,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.disableSources){let s=e.disableSources;if("boolean"!=typeof s){const e={instancePath:t+"/request/settings/disableSources",schemaPath:"#/properties/request/properties/settings/properties/disableSources/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:k.properties.request.properties.settings.properties.disableSources.type,parentSchema:k.properties.request.properties.settings.properties.disableSources,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.disableStream){let s=e.disableStream;if("boolean"!=typeof s){const e={instancePath:t+"/request/settings/disableStream",schemaPath:"#/properties/request/properties/settings/properties/disableStream/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:k.properties.request.properties.settings.properties.disableStream.type,parentSchema:k.properties.request.properties.settings.properties.disableStream,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.disableTools){let s=e.disableTools;if("boolean"!=typeof s){const e={instancePath:t+"/request/settings/disableTools",schemaPath:"#/properties/request/properties/settings/properties/disableTools/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:k.properties.request.properties.settings.properties.disableTools.type,parentSchema:k.properties.request.properties.settings.properties.disableTools,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.maxResponseLength){let s=e.maxResponseLength;if("number"!=typeof s){const e={instancePath:t+"/request/settings/maxResponseLength",schemaPath:"#/properties/request/properties/settings/properties/maxResponseLength/type",keyword:"type",params:{type:"number"},message:"must be number",schema:k.properties.request.properties.settings.properties.maxResponseLength.type,parentSchema:k.properties.request.properties.settings.properties.maxResponseLength,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.overrideInterfaceLanguage){let s=e.overrideInterfaceLanguage;if("string"!=typeof s){const e={instancePath:t+"/request/settings/overrideInterfaceLanguage",schemaPath:"#/properties/request/properties/settings/properties/overrideInterfaceLanguage/type",keyword:"type",params:{type:"string"},message:"must be string",schema:k.properties.request.properties.settings.properties.overrideInterfaceLanguage.type,parentSchema:k.properties.request.properties.settings.properties.overrideInterfaceLanguage,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.overrideOutputLanguage){let s=e.overrideOutputLanguage;if("string"!=typeof s){const e={instancePath:t+"/request/settings/overrideOutputLanguage",schemaPath:"#/properties/request/properties/settings/properties/overrideOutputLanguage/type",keyword:"type",params:{type:"string"},message:"must be string",schema:k.properties.request.properties.settings.properties.overrideOutputLanguage.type,parentSchema:k.properties.request.properties.settings.properties.overrideOutputLanguage,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/settings",schemaPath:"#/properties/request/properties/settings/type",keyword:"type",params:{type:"object"},message:"must be object",schema:k.properties.request.properties.settings.type,parentSchema:k.properties.request.properties.settings,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.a2a){let e=s.a2a;if(Array.isArray(e)){const s=e.length;for(let r=0;r<s;r++){let s=e[r];if(s&&"object"==typeof s&&!Array.isArray(s)){if(void 0!==s.id){let e=s.id;if("string"!=typeof e){const s={instancePath:t+"/request/a2a/"+r+"/id",schemaPath:"A2AConfiguration/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:L.properties.id.type,parentSchema:L.properties.id,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.name){let e=s.name;if("string"!=typeof e){const s={instancePath:t+"/request/a2a/"+r+"/name",schemaPath:"A2AConfiguration/properties/name/type",keyword:"type",params:{type:"string"},message:"must be string",schema:L.properties.name.type,parentSchema:L.properties.name,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.type){let e=s.type;if("string"!=typeof e){const s={instancePath:t+"/request/a2a/"+r+"/type",schemaPath:"A2AConfiguration/properties/type/type",keyword:"type",params:{type:"string"},message:"must be string",schema:L.properties.type.type,parentSchema:L.properties.type,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/request/a2a/"+r,schemaPath:"A2AConfiguration/type",keyword:"type",params:{type:"object"},message:"must be object",schema:L.type,parentSchema:L,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/a2a",schemaPath:"#/properties/request/properties/a2a/type",keyword:"type",params:{type:"array"},message:"must be array",schema:k.properties.request.properties.a2a.type,parentSchema:k.properties.request.properties.a2a,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.cursor){let e=s.cursor;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.since){let s=e.since;if("string"!=typeof s){const e={instancePath:t+"/request/cursor/since",schemaPath:"Cursor/properties/since/type",keyword:"type",params:{type:"string"},message:"must be string",schema:D.properties.since.type,parentSchema:D.properties.since,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.until){let s=e.until;if("string"!=typeof s){const e={instancePath:t+"/request/cursor/until",schemaPath:"Cursor/properties/until/type",keyword:"type",params:{type:"string"},message:"must be string",schema:D.properties.until.type,parentSchema:D.properties.until,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/cursor",schemaPath:"Cursor/type",keyword:"type",params:{type:"object"},message:"must be object",schema:D.type,parentSchema:D,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/request",schemaPath:"#/properties/request/type",keyword:"type",params:{type:"object"},message:"must be object",schema:k.properties.request.type,parentSchema:k.properties.request,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t,schemaPath:"#/type",keyword:"type",params:{type:"object"},message:"must be object",schema:k.type,parentSchema:k,data:e};null===p?p=[s]:p.push(s),i++}return K.errors=p,0===i}function z(e,{instancePath:t="",parentData:s,parentDataProperty:r,rootData:a=e}={}){let p=null,i=0;if(K(e,{instancePath:t,parentData:s,parentDataProperty:r,rootData:a})||(p=null===p?K.errors:p.concat(K.errors),i=p.length),e&&"object"==typeof e&&!Array.isArray(e)){if(void 0===e.request){const s={instancePath:t,schemaPath:"#/allOf/1/required",keyword:"required",params:{missingProperty:"request"},message:"must have required property 'request'",schema:w.allOf[1].required,parentSchema:w.allOf[1],data:e};null===p?p=[s]:p.push(s),i++}if(void 0!==e.request){let s=e.request;if(s&&"object"==typeof s&&!Array.isArray(s)){if(void 0===s.scope){const e={instancePath:t+"/request",schemaPath:"#/allOf/1/properties/request/required",keyword:"required",params:{missingProperty:"scope"},message:"must have required property 'scope'",schema:w.allOf[1].properties.request.required,parentSchema:w.allOf[1].properties.request,data:s};null===p?p=[e]:p.push(e),i++}if(void 0!==s.scope){let e=s.scope;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0===e.conversations){const s={instancePath:t+"/request/scope",schemaPath:"#/allOf/1/properties/request/properties/scope/required",keyword:"required",params:{missingProperty:"conversations"},message:"must have required property 'conversations'",schema:w.allOf[1].properties.request.properties.scope.required,parentSchema:w.allOf[1].properties.request.properties.scope,data:e};null===p?p=[s]:p.push(s),i++}if(void 0!==e.conversations){let s=e.conversations;if(Array.isArray(s)){if(s.length<1){const e={instancePath:t+"/request/scope/conversations",schemaPath:"#/allOf/1/properties/request/properties/scope/properties/conversations/minItems",keyword:"minItems",params:{limit:1},message:"must NOT have fewer than 1 items",schema:1,parentSchema:w.allOf[1].properties.request.properties.scope.properties.conversations,data:s};null===p?p=[e]:p.push(e),i++}const e=s.length;for(let r=0;r<e;r++)x(s[r],{instancePath:t+"/request/scope/conversations/"+r,parentData:s,parentDataProperty:r,rootData:a})||(p=null===p?x.errors:p.concat(x.errors),i=p.length)}else{const e={instancePath:t+"/request/scope/conversations",schemaPath:"#/allOf/1/properties/request/properties/scope/properties/conversations/type",keyword:"type",params:{type:"array"},message:"must be array",schema:w.allOf[1].properties.request.properties.scope.properties.conversations.type,parentSchema:w.allOf[1].properties.request.properties.scope.properties.conversations,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/request/scope",schemaPath:"#/allOf/1/properties/request/properties/scope/type",keyword:"type",params:{type:"object"},message:"must be object",schema:w.allOf[1].properties.request.properties.scope.type,parentSchema:w.allOf[1].properties.request.properties.scope,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/request",schemaPath:"#/allOf/1/properties/request/type",keyword:"type",params:{type:"object"},message:"must be object",schema:w.allOf[1].properties.request.type,parentSchema:w.allOf[1].properties.request,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t,schemaPath:"#/allOf/1/type",keyword:"type",params:{type:"object"},message:"must be object",schema:w.allOf[1].type,parentSchema:w.allOf[1],data:e};null===p?p=[s]:p.push(s),i++}return z.errors=p,0===i}const H=/^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,F=function(e){return/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d{3})?(?:Z|[+-]\d{2}:\d{2})$/.test(e)};const G=function e(t,{instancePath:s="",parentData:r,parentDataProperty:a,rootData:p=t}={}){let i=null,o=0;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0===t.action){const e={instancePath:s,schemaPath:"#/allOf/0/required",keyword:"required",params:{missingProperty:"action"},message:"must have required property 'action'",schema:I.allOf[0].required,parentSchema:I.allOf[0],data:t};null===i?i=[e]:i.push(e),o++}if(void 0===t.headers){const e={instancePath:s,schemaPath:"#/allOf/0/required",keyword:"required",params:{missingProperty:"headers"},message:"must have required property 'headers'",schema:I.allOf[0].required,parentSchema:I.allOf[0],data:t};null===i?i=[e]:i.push(e),o++}if(void 0===t.payload){const e={instancePath:s,schemaPath:"#/allOf/0/required",keyword:"required",params:{missingProperty:"payload"},message:"must have required property 'payload'",schema:I.allOf[0].required,parentSchema:I.allOf[0],data:t};null===i?i=[e]:i.push(e),o++}if(void 0!==t.action){let e=t.action;if("string"!=typeof e){const t={instancePath:s+"/action",schemaPath:"#/allOf/0/properties/action/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.allOf[0].properties.action.type,parentSchema:I.allOf[0].properties.action,data:e};null===i?i=[t]:i.push(t),o++}if("message"!==e){const t={instancePath:s+"/action",schemaPath:"#/allOf/0/properties/action/enum",keyword:"enum",params:{allowedValues:I.allOf[0].properties.action.enum},message:"must be equal to one of the allowed values",schema:I.allOf[0].properties.action.enum,parentSchema:I.allOf[0].properties.action,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.headers){let e=t.headers;if(!e||"object"!=typeof e||Array.isArray(e)){const t={instancePath:s+"/headers",schemaPath:"#/allOf/0/properties/headers/type",keyword:"type",params:{type:"object"},message:"must be object",schema:I.allOf[0].properties.headers.type,parentSchema:I.allOf[0].properties.headers,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.payload){let e=t.payload;if(!e||"object"!=typeof e||Array.isArray(e)){const t={instancePath:s+"/payload",schemaPath:"#/allOf/0/properties/payload/type",keyword:"type",params:{type:"object"},message:"must be object",schema:I.allOf[0].properties.payload.type,parentSchema:I.allOf[0].properties.payload,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s,schemaPath:"#/allOf/0/type",keyword:"type",params:{type:"object"},message:"must be object",schema:I.allOf[0].type,parentSchema:I.allOf[0],data:t};null===i?i=[e]:i.push(e),o++}const n=o;let c=!0;const u=o;if(t&&"object"==typeof t&&!Array.isArray(t)&&void 0!==t.headers){let e=t.headers;if(e&&"object"==typeof e&&!Array.isArray(e)&&void 0!==e.action){let t=e.action;if("adjust"!==t&&"elevate"!==t&&"interaction"!==t&&"customerInteraction"!==t){const e={};null===i?i=[e]:i.push(e),o++}}}var d=u===o;if(o=n,null!==i&&(n?i.length=n:i=null),d){const e=o;t&&"object"==typeof t&&!Array.isArray(t)&&void 0!==t.payload&&(z(t.payload,{instancePath:s+"/payload",parentData:t,parentDataProperty:"payload",rootData:p})||(i=null===i?z.errors:i.concat(z.errors),o=i.length)),c=d=e===o}if(!c){const e={instancePath:s,schemaPath:"#/allOf/1/if",keyword:"if",params:{failingKeyword:"then"},message:'must match "then" schema',schema:I.allOf[1].if,parentSchema:I.allOf[1],data:t};null===i?i=[e]:i.push(e),o++}const m=o;let y=!0;const h=o;if(t&&"object"==typeof t&&!Array.isArray(t)&&void 0!==t.headers){let e=t.headers;if(e&&"object"==typeof e&&!Array.isArray(e)&&void 0!==e.action){let t=e.action;if("summarize"!==t&&"translate"!==t&&"insights"!==t&&"recommend"!==t){const e={};null===i?i=[e]:i.push(e),o++}}}var l=h===o;if(o=m,null!==i&&(m?i.length=m:i=null),l){const e=o;t&&"object"==typeof t&&!Array.isArray(t)&&void 0!==t.payload&&(z(t.payload,{instancePath:s+"/payload",parentData:t,parentDataProperty:"payload",rootData:p})||(i=null===i?z.errors:i.concat(z.errors),o=i.length)),y=l=e===o}if(!y){const e={instancePath:s,schemaPath:"#/allOf/2/if",keyword:"if",params:{failingKeyword:"then"},message:'must match "then" schema',schema:I.allOf[2].if,parentSchema:I.allOf[2],data:t};null===i?i=[e]:i.push(e),o++}if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0===t.action){const e={instancePath:s,schemaPath:"#/required",keyword:"required",params:{missingProperty:"action"},message:"must have required property 'action'",schema:I.required,parentSchema:I,data:t};null===i?i=[e]:i.push(e),o++}if(void 0===t.headers){const e={instancePath:s,schemaPath:"#/required",keyword:"required",params:{missingProperty:"headers"},message:"must have required property 'headers'",schema:I.required,parentSchema:I,data:t};null===i?i=[e]:i.push(e),o++}if(void 0===t.payload){const e={instancePath:s,schemaPath:"#/required",keyword:"required",params:{missingProperty:"payload"},message:"must have required property 'payload'",schema:I.required,parentSchema:I,data:t};null===i?i=[e]:i.push(e),o++}if(void 0!==t.action){let e=t.action;if("string"!=typeof e){const t={instancePath:s+"/action",schemaPath:"#/properties/action/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.action.type,parentSchema:I.properties.action,data:e};null===i?i=[t]:i.push(t),o++}if("message"!==e){const t={instancePath:s+"/action",schemaPath:"#/properties/action/enum",keyword:"enum",params:{allowedValues:I.properties.action.enum},message:"must be equal to one of the allowed values",schema:I.properties.action.enum,parentSchema:I.properties.action,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.headers){let e=t.headers;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0===e.correlationId){const t={instancePath:s+"/headers",schemaPath:"#/properties/headers/required",keyword:"required",params:{missingProperty:"correlationId"},message:"must have required property 'correlationId'",schema:I.properties.headers.required,parentSchema:I.properties.headers,data:e};null===i?i=[t]:i.push(t),o++}if(void 0===e.action){const t={instancePath:s+"/headers",schemaPath:"#/properties/headers/required",keyword:"required",params:{missingProperty:"action"},message:"must have required property 'action'",schema:I.properties.headers.required,parentSchema:I.properties.headers,data:e};null===i?i=[t]:i.push(t),o++}if(void 0===e.schemaRef){const t={instancePath:s+"/headers",schemaPath:"#/properties/headers/required",keyword:"required",params:{missingProperty:"schemaRef"},message:"must have required property 'schemaRef'",schema:I.properties.headers.required,parentSchema:I.properties.headers,data:e};null===i?i=[t]:i.push(t),o++}if(void 0!==e.correlationId){let t=e.correlationId;if("string"==typeof t){if(!H.test(t)){const e={instancePath:s+"/headers/correlationId",schemaPath:"#/properties/headers/properties/correlationId/format",keyword:"format",params:{format:"uuidv7"},message:'must match format "uuidv7"',schema:"uuidv7",parentSchema:I.properties.headers.properties.correlationId,data:t};null===i?i=[e]:i.push(e),o++}}else{const e={instancePath:s+"/headers/correlationId",schemaPath:"#/properties/headers/properties/correlationId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.correlationId.type,parentSchema:I.properties.headers.properties.correlationId,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.tenantId){let t=e.tenantId;if("string"!=typeof t){const e={instancePath:s+"/headers/tenantId",schemaPath:"#/properties/headers/properties/tenantId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.tenantId.type,parentSchema:I.properties.headers.properties.tenantId,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.traceId){let t=e.traceId;if("string"==typeof t){if(!H.test(t)){const e={instancePath:s+"/headers/traceId",schemaPath:"#/properties/headers/properties/traceId/format",keyword:"format",params:{format:"uuidv7"},message:'must match format "uuidv7"',schema:"uuidv7",parentSchema:I.properties.headers.properties.traceId,data:t};null===i?i=[e]:i.push(e),o++}}else{const e={instancePath:s+"/headers/traceId",schemaPath:"#/properties/headers/properties/traceId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.traceId.type,parentSchema:I.properties.headers.properties.traceId,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.idempotencyKey){let t=e.idempotencyKey;if("string"==typeof t){if(!H.test(t)){const e={instancePath:s+"/headers/idempotencyKey",schemaPath:"#/properties/headers/properties/idempotencyKey/format",keyword:"format",params:{format:"uuidv7"},message:'must match format "uuidv7"',schema:"uuidv7",parentSchema:I.properties.headers.properties.idempotencyKey,data:t};null===i?i=[e]:i.push(e),o++}}else{const e={instancePath:s+"/headers/idempotencyKey",schemaPath:"#/properties/headers/properties/idempotencyKey/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.idempotencyKey.type,parentSchema:I.properties.headers.properties.idempotencyKey,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.identifier){let t=e.identifier;if("string"!=typeof t){const e={instancePath:s+"/headers/identifier",schemaPath:"#/properties/headers/properties/identifier/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.identifier.type,parentSchema:I.properties.headers.properties.identifier,data:t};null===i?i=[e]:i.push(e),o++}if("message"!==t){const e={instancePath:s+"/headers/identifier",schemaPath:"#/properties/headers/properties/identifier/enum",keyword:"enum",params:{allowedValues:I.properties.headers.properties.identifier.enum},message:"must be equal to one of the allowed values",schema:I.properties.headers.properties.identifier.enum,parentSchema:I.properties.headers.properties.identifier,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.action){let t=e.action;if("string"!=typeof t){const e={instancePath:s+"/headers/action",schemaPath:"#/properties/headers/properties/action/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.action.type,parentSchema:I.properties.headers.properties.action,data:t};null===i?i=[e]:i.push(e),o++}if("adjust"!==t&&"elevate"!==t&&"customerinteraction"!==t&&"interaction"!==t&&"reception"!==t&&"summarize"!==t&&"translate"!==t&&"recommend"!==t&&"insights"!==t){const e={instancePath:s+"/headers/action",schemaPath:"#/properties/headers/properties/action/enum",keyword:"enum",params:{allowedValues:I.properties.headers.properties.action.enum},message:"must be equal to one of the allowed values",schema:I.properties.headers.properties.action.enum,parentSchema:I.properties.headers.properties.action,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.schemaRef){let t=e.schemaRef;if("string"!=typeof t){const e={instancePath:s+"/headers/schemaRef",schemaPath:"#/properties/headers/properties/schemaRef/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.schemaRef.type,parentSchema:I.properties.headers.properties.schemaRef,data:t};null===i?i=[e]:i.push(e),o++}if("optave.message.v3"!==t){const e={instancePath:s+"/headers/schemaRef",schemaPath:"#/properties/headers/properties/schemaRef/enum",keyword:"enum",params:{allowedValues:I.properties.headers.properties.schemaRef.enum},message:"must be equal to one of the allowed values",schema:I.properties.headers.properties.schemaRef.enum,parentSchema:I.properties.headers.properties.schemaRef,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.sdkVersion){let t=e.sdkVersion;if("string"!=typeof t){const e={instancePath:s+"/headers/sdkVersion",schemaPath:"#/properties/headers/properties/sdkVersion/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.sdkVersion.type,parentSchema:I.properties.headers.properties.sdkVersion,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.networkLatencyMs){let t=e.networkLatencyMs;if("number"!=typeof t){const e={instancePath:s+"/headers/networkLatencyMs",schemaPath:"#/properties/headers/properties/networkLatencyMs/type",keyword:"type",params:{type:"number"},message:"must be number",schema:I.properties.headers.properties.networkLatencyMs.type,parentSchema:I.properties.headers.properties.networkLatencyMs,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.timestamp){let t=e.timestamp;if("string"==typeof t){if(!F(t)){const e={instancePath:s+"/headers/timestamp",schemaPath:"#/properties/headers/properties/timestamp/format",keyword:"format",params:{format:"date-time"},message:'must match format "date-time"',schema:"date-time",parentSchema:I.properties.headers.properties.timestamp,data:t};null===i?i=[e]:i.push(e),o++}}else{const e={instancePath:s+"/headers/timestamp",schemaPath:"#/properties/headers/properties/timestamp/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.timestamp.type,parentSchema:I.properties.headers.properties.timestamp,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.issuedAt){let t=e.issuedAt;if("string"==typeof t){if(!F(t)){const e={instancePath:s+"/headers/issuedAt",schemaPath:"#/properties/headers/properties/issuedAt/format",keyword:"format",params:{format:"date-time"},message:'must match format "date-time"',schema:"date-time",parentSchema:I.properties.headers.properties.issuedAt,data:t};null===i?i=[e]:i.push(e),o++}}else{const e={instancePath:s+"/headers/issuedAt",schemaPath:"#/properties/headers/properties/issuedAt/type",keyword:"type",params:{type:"string"},message:"must be string",schema:I.properties.headers.properties.issuedAt.type,parentSchema:I.properties.headers.properties.issuedAt,data:t};null===i?i=[e]:i.push(e),o++}}}else{const t={instancePath:s+"/headers",schemaPath:"#/properties/headers/type",keyword:"type",params:{type:"object"},message:"must be object",schema:I.properties.headers.type,parentSchema:I.properties.headers,data:e};null===i?i=[t]:i.push(t),o++}}void 0!==t.payload&&(K(t.payload,{instancePath:s+"/payload",parentData:t,parentDataProperty:"payload",rootData:p})||(i=null===i?K.errors:i.concat(K.errors),o=i.length))}else{const e={instancePath:s,schemaPath:"#/type",keyword:"type",params:{type:"object"},message:"must be object",schema:I.type,parentSchema:I,data:t};null===i?i=[e]:i.push(e),o++}return e.errors=i,0===o};const Y={type:"object",required:["session","request"],properties:{session:{$ref:"Session"},request:{type:"object",required:["requestId"],properties:{requestId:{type:"string",description:"Unique request identifier"},attributes:{$ref:"RequestAttributes"},connections:{$ref:"Connections"},context:{$ref:"Context"},reference:{type:"object",properties:{ids:{type:"array",items:{$ref:"ReferenceId"}},labels:{type:"array",description:"Reference labels"},tags:{type:"array",description:"Reference tags"}}},resources:{type:"object",properties:{codes:{type:"array",items:{$ref:"CodesItem"}},links:{type:"array",items:{$ref:"LinkItem"}},offers:{type:"array",description:"Offering details (previously offering_details in v2)"}}},scope:{type:"object",properties:{accounts:{type:"array"},appointments:{type:"array"},assets:{type:"array"},bookings:{type:"array"},cases:{type:"array"},conversations:{type:"array",items:{$ref:"Conversation"}},documents:{type:"array"},events:{type:"array"},interactions:{type:"array",items:{$ref:"Interaction"}},items:{type:"array"},locations:{type:"array"},offers:{type:"array"},operators:{type:"array"},orders:{type:"array"},organizations:{type:"array"},persons:{type:"array"},policies:{type:"array"},products:{type:"array",items:{$ref:"Product"}},properties:{type:"array"},services:{type:"array"},subscriptions:{type:"array"},tickets:{type:"array"},transactions:{type:"array"},users:{type:"array"}}},settings:{type:"object",properties:{disableBrowsing:{type:"boolean",default:!1},disableSearch:{type:"boolean",default:!1},disableSources:{type:"boolean",default:!1},disableStream:{type:"boolean",default:!0},disableTools:{type:"boolean",default:!1},maxResponseLength:{type:"number",default:0},overrideInterfaceLanguage:{type:"string",description:"Override interface language"},overrideOutputLanguage:{type:"string",description:"Override output language (replaces channel language)"}}},a2a:{type:"array",items:{$ref:"A2AConfiguration"},description:"Advanced mode agent-to-agent configuration"},cursor:{$ref:"Cursor"}}}}},Z={type:"object",properties:{content:{type:"string",description:"Content to be processed"},instruction:{type:"string",description:"Specific instruction for the action"},variant:{type:"string",description:'Variant identifier (e.g., "A", "B")'}}},J={type:"object",properties:{journeyId:{type:"string",description:"Journey identifier"},parentId:{type:"string",description:"Parent request ID (previously trace_parent_ID in v2)"},threadId:{type:"string",description:"Thread ID that remains unique across all requests related to same ticket/case/conversation"}}},Q={type:"object",properties:{caseId:{type:"string",description:"Case identifier (advanced mode)"},departmentId:{type:"string",description:"Department identifier (advanced mode)"},operatorId:{type:"string",description:"Operator identifier (advanced mode)"},organizationId:{type:"string",description:"Organization identifier"},userId:{type:"string",description:"User identifier (advanced mode)"}}},X={type:"object",properties:{name:{type:"string"},value:{type:"string"}}},ee={type:"object",properties:{id:{type:"string",description:"Optional for tracking/mapping"},label:{type:"string",description:'Optional, helps for display/templating (e.g., "Order Number")'},type:{type:"string",description:'Code type (e.g., "order_number", "booking_reference", "ticket_code")'},value:{type:"string",description:'Code value (e.g., "ORD-56789")'}}},te={type:"object",properties:{expires_at:{type:"string",description:"Optional expiration timestamp"},html:{type:"boolean",description:"Optional HTML flag"},id:{type:"string",description:"Optional link identifier"},label:{type:"string",description:'Optional label (e.g., "Click here to pay")'},type:{type:"string",description:'Link type (e.g., "payment_link")'},url:{type:"string",description:'URL (e.g., "https://checkout.stripe.com/pay/cs_test...")'}}},se={type:"object",properties:{content:{type:"string"},id:{type:"string"},name:{type:"string"},role:{type:"string"},timestamp:{type:"string"}}},re={type:"object",properties:{id:{type:"string"}}},ae={type:"object",properties:{id:{type:"string"},name:{type:"string"},type:{type:"string"}},description:"Advanced mode agent-to-agent configuration"},pe={type:"object",properties:{since:{type:"string",description:'Start timestamp (e.g., "2024-01-15T10:30:00.000Z")'},until:{type:"string",description:'End timestamp (e.g., "2024-01-15T11:00:00.000Z")'}}},ie={type:"object",properties:{sessionId:{type:"string",description:"Unique session identifier lasting for duration of chat session or call"},channel:{$ref:"Channel"},interface:{$ref:"Interface"}}},oe={type:"object",properties:{browser:{type:"string",description:"Browser information"},deviceInfo:{type:"string",description:'Device information (e.g., "iOS/18.2, iPhone15,3")'},deviceType:{type:"string",description:"Type of device"},language:{type:"string",description:"Interface language"},location:{type:"string",description:'Geographic location (e.g., "45.42,-75.69")'},medium:{type:"string",enum:["chat","voice","email"],description:"Communication medium (allowed: chat, voice, email; default is chat if omitted)"},metadata:{type:"array",description:"Custom metadata array"},section:{type:"string",description:'Section of the application (e.g., "cart", "product_page")'}}},ne={type:"object",properties:{appVersion:{type:"string",description:"Custom application version"},category:{type:"string",description:'Interface category (e.g., "crm", "app", "auto", "widget")'},language:{type:"string",description:"Language from the CRM agent"},name:{type:"string",description:'Interface name (e.g., "salesforce", "zendesk")'},type:{type:"string",description:'Interface type (e.g., "custom_components", "marketplace", "channel")'}}};function ce(e,{instancePath:t="",parentData:s,parentDataProperty:r,rootData:a=e}={}){let p=null,i=0;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.sessionId){let s=e.sessionId;if("string"!=typeof s){const e={instancePath:t+"/sessionId",schemaPath:"#/properties/sessionId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ie.properties.sessionId.type,parentSchema:ie.properties.sessionId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.channel){let s=e.channel;if(s&&"object"==typeof s&&!Array.isArray(s)){if(void 0!==s.browser){let e=s.browser;if("string"!=typeof e){const s={instancePath:t+"/channel/browser",schemaPath:"Channel/properties/browser/type",keyword:"type",params:{type:"string"},message:"must be string",schema:oe.properties.browser.type,parentSchema:oe.properties.browser,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.deviceInfo){let e=s.deviceInfo;if("string"!=typeof e){const s={instancePath:t+"/channel/deviceInfo",schemaPath:"Channel/properties/deviceInfo/type",keyword:"type",params:{type:"string"},message:"must be string",schema:oe.properties.deviceInfo.type,parentSchema:oe.properties.deviceInfo,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.deviceType){let e=s.deviceType;if("string"!=typeof e){const s={instancePath:t+"/channel/deviceType",schemaPath:"Channel/properties/deviceType/type",keyword:"type",params:{type:"string"},message:"must be string",schema:oe.properties.deviceType.type,parentSchema:oe.properties.deviceType,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.language){let e=s.language;if("string"!=typeof e){const s={instancePath:t+"/channel/language",schemaPath:"Channel/properties/language/type",keyword:"type",params:{type:"string"},message:"must be string",schema:oe.properties.language.type,parentSchema:oe.properties.language,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.location){let e=s.location;if("string"!=typeof e){const s={instancePath:t+"/channel/location",schemaPath:"Channel/properties/location/type",keyword:"type",params:{type:"string"},message:"must be string",schema:oe.properties.location.type,parentSchema:oe.properties.location,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.medium){let e=s.medium;if("string"!=typeof e){const s={instancePath:t+"/channel/medium",schemaPath:"Channel/properties/medium/type",keyword:"type",params:{type:"string"},message:"must be string",schema:oe.properties.medium.type,parentSchema:oe.properties.medium,data:e};null===p?p=[s]:p.push(s),i++}if("chat"!==e&&"voice"!==e&&"email"!==e){const s={instancePath:t+"/channel/medium",schemaPath:"Channel/properties/medium/enum",keyword:"enum",params:{allowedValues:oe.properties.medium.enum},message:"must be equal to one of the allowed values",schema:oe.properties.medium.enum,parentSchema:oe.properties.medium,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.metadata){let e=s.metadata;if(!Array.isArray(e)){const s={instancePath:t+"/channel/metadata",schemaPath:"Channel/properties/metadata/type",keyword:"type",params:{type:"array"},message:"must be array",schema:oe.properties.metadata.type,parentSchema:oe.properties.metadata,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.section){let e=s.section;if("string"!=typeof e){const s={instancePath:t+"/channel/section",schemaPath:"Channel/properties/section/type",keyword:"type",params:{type:"string"},message:"must be string",schema:oe.properties.section.type,parentSchema:oe.properties.section,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/channel",schemaPath:"Channel/type",keyword:"type",params:{type:"object"},message:"must be object",schema:oe.type,parentSchema:oe,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.interface){let s=e.interface;if(s&&"object"==typeof s&&!Array.isArray(s)){if(void 0!==s.appVersion){let e=s.appVersion;if("string"!=typeof e){const s={instancePath:t+"/interface/appVersion",schemaPath:"Interface/properties/appVersion/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ne.properties.appVersion.type,parentSchema:ne.properties.appVersion,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.category){let e=s.category;if("string"!=typeof e){const s={instancePath:t+"/interface/category",schemaPath:"Interface/properties/category/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ne.properties.category.type,parentSchema:ne.properties.category,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.language){let e=s.language;if("string"!=typeof e){const s={instancePath:t+"/interface/language",schemaPath:"Interface/properties/language/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ne.properties.language.type,parentSchema:ne.properties.language,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.name){let e=s.name;if("string"!=typeof e){const s={instancePath:t+"/interface/name",schemaPath:"Interface/properties/name/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ne.properties.name.type,parentSchema:ne.properties.name,data:e};null===p?p=[s]:p.push(s),i++}}if(void 0!==s.type){let e=s.type;if("string"!=typeof e){const s={instancePath:t+"/interface/type",schemaPath:"Interface/properties/type/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ne.properties.type.type,parentSchema:ne.properties.type,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/interface",schemaPath:"Interface/type",keyword:"type",params:{type:"object"},message:"must be object",schema:ne.type,parentSchema:ne,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t,schemaPath:"#/type",keyword:"type",params:{type:"object"},message:"must be object",schema:ie.type,parentSchema:ie,data:e};null===p?p=[s]:p.push(s),i++}return ce.errors=p,0===i}const ue={type:"object",properties:{conversationId:{type:"string"},participants:{type:"array",items:{$ref:"Participant"}},messages:{type:"array",items:{$ref:"Message"}},metadata:{type:"object"}}},de={type:"object",properties:{participantId:{type:"string"},displayName:{type:"string"},role:{type:"string",enum:["operator","user","bot"]}}},me={type:"object",properties:{content:{type:"string"},participantId:{type:"string"},timestamp:{type:"string"}}};function ye(e,{instancePath:t="",parentData:s,parentDataProperty:r,rootData:a=e}={}){let p=null,i=0;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.conversationId){let s=e.conversationId;if("string"!=typeof s){const e={instancePath:t+"/conversationId",schemaPath:"#/properties/conversationId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ue.properties.conversationId.type,parentSchema:ue.properties.conversationId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.participants){let s=e.participants;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.participantId){let s=e.participantId;if("string"!=typeof s){const e={instancePath:t+"/participants/"+r+"/participantId",schemaPath:"Participant/properties/participantId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:de.properties.participantId.type,parentSchema:de.properties.participantId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.displayName){let s=e.displayName;if("string"!=typeof s){const e={instancePath:t+"/participants/"+r+"/displayName",schemaPath:"Participant/properties/displayName/type",keyword:"type",params:{type:"string"},message:"must be string",schema:de.properties.displayName.type,parentSchema:de.properties.displayName,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.role){let s=e.role;if("string"!=typeof s){const e={instancePath:t+"/participants/"+r+"/role",schemaPath:"Participant/properties/role/type",keyword:"type",params:{type:"string"},message:"must be string",schema:de.properties.role.type,parentSchema:de.properties.role,data:s};null===p?p=[e]:p.push(e),i++}if("operator"!==s&&"user"!==s&&"bot"!==s){const e={instancePath:t+"/participants/"+r+"/role",schemaPath:"Participant/properties/role/enum",keyword:"enum",params:{allowedValues:de.properties.role.enum},message:"must be equal to one of the allowed values",schema:de.properties.role.enum,parentSchema:de.properties.role,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/participants/"+r,schemaPath:"Participant/type",keyword:"type",params:{type:"object"},message:"must be object",schema:de.type,parentSchema:de,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/participants",schemaPath:"#/properties/participants/type",keyword:"type",params:{type:"array"},message:"must be array",schema:ue.properties.participants.type,parentSchema:ue.properties.participants,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.messages){let s=e.messages;if(Array.isArray(s)){const e=s.length;for(let r=0;r<e;r++){let e=s[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.content){let s=e.content;if("string"!=typeof s){const e={instancePath:t+"/messages/"+r+"/content",schemaPath:"Message/properties/content/type",keyword:"type",params:{type:"string"},message:"must be string",schema:me.properties.content.type,parentSchema:me.properties.content,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.participantId){let s=e.participantId;if("string"!=typeof s){const e={instancePath:t+"/messages/"+r+"/participantId",schemaPath:"Message/properties/participantId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:me.properties.participantId.type,parentSchema:me.properties.participantId,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.timestamp){let s=e.timestamp;if("string"!=typeof s){const e={instancePath:t+"/messages/"+r+"/timestamp",schemaPath:"Message/properties/timestamp/type",keyword:"type",params:{type:"string"},message:"must be string",schema:me.properties.timestamp.type,parentSchema:me.properties.timestamp,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t+"/messages/"+r,schemaPath:"Message/type",keyword:"type",params:{type:"object"},message:"must be object",schema:me.type,parentSchema:me,data:e};null===p?p=[s]:p.push(s),i++}}}else{const e={instancePath:t+"/messages",schemaPath:"#/properties/messages/type",keyword:"type",params:{type:"array"},message:"must be array",schema:ue.properties.messages.type,parentSchema:ue.properties.messages,data:s};null===p?p=[e]:p.push(e),i++}}if(void 0!==e.metadata){let s=e.metadata;if(!s||"object"!=typeof s||Array.isArray(s)){const e={instancePath:t+"/metadata",schemaPath:"#/properties/metadata/type",keyword:"type",params:{type:"object"},message:"must be object",schema:ue.properties.metadata.type,parentSchema:ue.properties.metadata,data:s};null===p?p=[e]:p.push(e),i++}}}else{const s={instancePath:t,schemaPath:"#/type",keyword:"type",params:{type:"object"},message:"must be object",schema:ue.type,parentSchema:ue,data:e};null===p?p=[s]:p.push(s),i++}return ye.errors=p,0===i}const he=function e(t,{instancePath:s="",parentData:r,parentDataProperty:a,rootData:p=t}={}){let i=null,o=0;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0===t.session){const e={instancePath:s,schemaPath:"#/required",keyword:"required",params:{missingProperty:"session"},message:"must have required property 'session'",schema:Y.required,parentSchema:Y,data:t};null===i?i=[e]:i.push(e),o++}if(void 0===t.request){const e={instancePath:s,schemaPath:"#/required",keyword:"required",params:{missingProperty:"request"},message:"must have required property 'request'",schema:Y.required,parentSchema:Y,data:t};null===i?i=[e]:i.push(e),o++}if(void 0!==t.session&&(ce(t.session,{instancePath:s+"/session",parentData:t,parentDataProperty:"session",rootData:p})||(i=null===i?ce.errors:i.concat(ce.errors),o=i.length)),void 0!==t.request){let e=t.request;if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0===e.requestId){const t={instancePath:s+"/request",schemaPath:"#/properties/request/required",keyword:"required",params:{missingProperty:"requestId"},message:"must have required property 'requestId'",schema:Y.properties.request.required,parentSchema:Y.properties.request,data:e};null===i?i=[t]:i.push(t),o++}if(void 0!==e.requestId){let t=e.requestId;if("string"!=typeof t){const e={instancePath:s+"/request/requestId",schemaPath:"#/properties/request/properties/requestId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Y.properties.request.properties.requestId.type,parentSchema:Y.properties.request.properties.requestId,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.attributes){let t=e.attributes;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.content){let e=t.content;if("string"!=typeof e){const t={instancePath:s+"/request/attributes/content",schemaPath:"RequestAttributes/properties/content/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Z.properties.content.type,parentSchema:Z.properties.content,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.instruction){let e=t.instruction;if("string"!=typeof e){const t={instancePath:s+"/request/attributes/instruction",schemaPath:"RequestAttributes/properties/instruction/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Z.properties.instruction.type,parentSchema:Z.properties.instruction,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.variant){let e=t.variant;if("string"!=typeof e){const t={instancePath:s+"/request/attributes/variant",schemaPath:"RequestAttributes/properties/variant/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Z.properties.variant.type,parentSchema:Z.properties.variant,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/attributes",schemaPath:"RequestAttributes/type",keyword:"type",params:{type:"object"},message:"must be object",schema:Z.type,parentSchema:Z,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.connections){let t=e.connections;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.journeyId){let e=t.journeyId;if("string"!=typeof e){const t={instancePath:s+"/request/connections/journeyId",schemaPath:"Connections/properties/journeyId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:J.properties.journeyId.type,parentSchema:J.properties.journeyId,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.parentId){let e=t.parentId;if("string"!=typeof e){const t={instancePath:s+"/request/connections/parentId",schemaPath:"Connections/properties/parentId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:J.properties.parentId.type,parentSchema:J.properties.parentId,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.threadId){let e=t.threadId;if("string"!=typeof e){const t={instancePath:s+"/request/connections/threadId",schemaPath:"Connections/properties/threadId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:J.properties.threadId.type,parentSchema:J.properties.threadId,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/connections",schemaPath:"Connections/type",keyword:"type",params:{type:"object"},message:"must be object",schema:J.type,parentSchema:J,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.context){let t=e.context;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.caseId){let e=t.caseId;if("string"!=typeof e){const t={instancePath:s+"/request/context/caseId",schemaPath:"Context/properties/caseId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Q.properties.caseId.type,parentSchema:Q.properties.caseId,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.departmentId){let e=t.departmentId;if("string"!=typeof e){const t={instancePath:s+"/request/context/departmentId",schemaPath:"Context/properties/departmentId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Q.properties.departmentId.type,parentSchema:Q.properties.departmentId,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.operatorId){let e=t.operatorId;if("string"!=typeof e){const t={instancePath:s+"/request/context/operatorId",schemaPath:"Context/properties/operatorId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Q.properties.operatorId.type,parentSchema:Q.properties.operatorId,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.organizationId){let e=t.organizationId;if("string"!=typeof e){const t={instancePath:s+"/request/context/organizationId",schemaPath:"Context/properties/organizationId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Q.properties.organizationId.type,parentSchema:Q.properties.organizationId,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.userId){let e=t.userId;if("string"!=typeof e){const t={instancePath:s+"/request/context/userId",schemaPath:"Context/properties/userId/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Q.properties.userId.type,parentSchema:Q.properties.userId,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/context",schemaPath:"Context/type",keyword:"type",params:{type:"object"},message:"must be object",schema:Q.type,parentSchema:Q,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.reference){let t=e.reference;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.ids){let e=t.ids;if(Array.isArray(e)){const t=e.length;for(let r=0;r<t;r++){let t=e[r];if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.name){let e=t.name;if("string"!=typeof e){const t={instancePath:s+"/request/reference/ids/"+r+"/name",schemaPath:"ReferenceId/properties/name/type",keyword:"type",params:{type:"string"},message:"must be string",schema:X.properties.name.type,parentSchema:X.properties.name,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.value){let e=t.value;if("string"!=typeof e){const t={instancePath:s+"/request/reference/ids/"+r+"/value",schemaPath:"ReferenceId/properties/value/type",keyword:"type",params:{type:"string"},message:"must be string",schema:X.properties.value.type,parentSchema:X.properties.value,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/reference/ids/"+r,schemaPath:"ReferenceId/type",keyword:"type",params:{type:"object"},message:"must be object",schema:X.type,parentSchema:X,data:t};null===i?i=[e]:i.push(e),o++}}}else{const t={instancePath:s+"/request/reference/ids",schemaPath:"#/properties/request/properties/reference/properties/ids/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.reference.properties.ids.type,parentSchema:Y.properties.request.properties.reference.properties.ids,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.labels){let e=t.labels;if(!Array.isArray(e)){const t={instancePath:s+"/request/reference/labels",schemaPath:"#/properties/request/properties/reference/properties/labels/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.reference.properties.labels.type,parentSchema:Y.properties.request.properties.reference.properties.labels,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.tags){let e=t.tags;if(!Array.isArray(e)){const t={instancePath:s+"/request/reference/tags",schemaPath:"#/properties/request/properties/reference/properties/tags/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.reference.properties.tags.type,parentSchema:Y.properties.request.properties.reference.properties.tags,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/reference",schemaPath:"#/properties/request/properties/reference/type",keyword:"type",params:{type:"object"},message:"must be object",schema:Y.properties.request.properties.reference.type,parentSchema:Y.properties.request.properties.reference,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.resources){let t=e.resources;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.codes){let e=t.codes;if(Array.isArray(e)){const t=e.length;for(let r=0;r<t;r++){let t=e[r];if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.id){let e=t.id;if("string"!=typeof e){const t={instancePath:s+"/request/resources/codes/"+r+"/id",schemaPath:"CodesItem/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ee.properties.id.type,parentSchema:ee.properties.id,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.label){let e=t.label;if("string"!=typeof e){const t={instancePath:s+"/request/resources/codes/"+r+"/label",schemaPath:"CodesItem/properties/label/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ee.properties.label.type,parentSchema:ee.properties.label,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.type){let e=t.type;if("string"!=typeof e){const t={instancePath:s+"/request/resources/codes/"+r+"/type",schemaPath:"CodesItem/properties/type/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ee.properties.type.type,parentSchema:ee.properties.type,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.value){let e=t.value;if("string"!=typeof e){const t={instancePath:s+"/request/resources/codes/"+r+"/value",schemaPath:"CodesItem/properties/value/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ee.properties.value.type,parentSchema:ee.properties.value,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/resources/codes/"+r,schemaPath:"CodesItem/type",keyword:"type",params:{type:"object"},message:"must be object",schema:ee.type,parentSchema:ee,data:t};null===i?i=[e]:i.push(e),o++}}}else{const t={instancePath:s+"/request/resources/codes",schemaPath:"#/properties/request/properties/resources/properties/codes/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.resources.properties.codes.type,parentSchema:Y.properties.request.properties.resources.properties.codes,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.links){let e=t.links;if(Array.isArray(e)){const t=e.length;for(let r=0;r<t;r++){let t=e[r];if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.expires_at){let e=t.expires_at;if("string"!=typeof e){const t={instancePath:s+"/request/resources/links/"+r+"/expires_at",schemaPath:"LinkItem/properties/expires_at/type",keyword:"type",params:{type:"string"},message:"must be string",schema:te.properties.expires_at.type,parentSchema:te.properties.expires_at,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.html){let e=t.html;if("boolean"!=typeof e){const t={instancePath:s+"/request/resources/links/"+r+"/html",schemaPath:"LinkItem/properties/html/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:te.properties.html.type,parentSchema:te.properties.html,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.id){let e=t.id;if("string"!=typeof e){const t={instancePath:s+"/request/resources/links/"+r+"/id",schemaPath:"LinkItem/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:te.properties.id.type,parentSchema:te.properties.id,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.label){let e=t.label;if("string"!=typeof e){const t={instancePath:s+"/request/resources/links/"+r+"/label",schemaPath:"LinkItem/properties/label/type",keyword:"type",params:{type:"string"},message:"must be string",schema:te.properties.label.type,parentSchema:te.properties.label,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.type){let e=t.type;if("string"!=typeof e){const t={instancePath:s+"/request/resources/links/"+r+"/type",schemaPath:"LinkItem/properties/type/type",keyword:"type",params:{type:"string"},message:"must be string",schema:te.properties.type.type,parentSchema:te.properties.type,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.url){let e=t.url;if("string"!=typeof e){const t={instancePath:s+"/request/resources/links/"+r+"/url",schemaPath:"LinkItem/properties/url/type",keyword:"type",params:{type:"string"},message:"must be string",schema:te.properties.url.type,parentSchema:te.properties.url,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/resources/links/"+r,schemaPath:"LinkItem/type",keyword:"type",params:{type:"object"},message:"must be object",schema:te.type,parentSchema:te,data:t};null===i?i=[e]:i.push(e),o++}}}else{const t={instancePath:s+"/request/resources/links",schemaPath:"#/properties/request/properties/resources/properties/links/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.resources.properties.links.type,parentSchema:Y.properties.request.properties.resources.properties.links,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.offers){let e=t.offers;if(!Array.isArray(e)){const t={instancePath:s+"/request/resources/offers",schemaPath:"#/properties/request/properties/resources/properties/offers/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.resources.properties.offers.type,parentSchema:Y.properties.request.properties.resources.properties.offers,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/resources",schemaPath:"#/properties/request/properties/resources/type",keyword:"type",params:{type:"object"},message:"must be object",schema:Y.properties.request.properties.resources.type,parentSchema:Y.properties.request.properties.resources,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.scope){let t=e.scope;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.accounts){let e=t.accounts;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/accounts",schemaPath:"#/properties/request/properties/scope/properties/accounts/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.accounts.type,parentSchema:Y.properties.request.properties.scope.properties.accounts,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.appointments){let e=t.appointments;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/appointments",schemaPath:"#/properties/request/properties/scope/properties/appointments/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.appointments.type,parentSchema:Y.properties.request.properties.scope.properties.appointments,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.assets){let e=t.assets;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/assets",schemaPath:"#/properties/request/properties/scope/properties/assets/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.assets.type,parentSchema:Y.properties.request.properties.scope.properties.assets,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.bookings){let e=t.bookings;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/bookings",schemaPath:"#/properties/request/properties/scope/properties/bookings/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.bookings.type,parentSchema:Y.properties.request.properties.scope.properties.bookings,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.cases){let e=t.cases;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/cases",schemaPath:"#/properties/request/properties/scope/properties/cases/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.cases.type,parentSchema:Y.properties.request.properties.scope.properties.cases,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.conversations){let e=t.conversations;if(Array.isArray(e)){const t=e.length;for(let r=0;r<t;r++)ye(e[r],{instancePath:s+"/request/scope/conversations/"+r,parentData:e,parentDataProperty:r,rootData:p})||(i=null===i?ye.errors:i.concat(ye.errors),o=i.length)}else{const t={instancePath:s+"/request/scope/conversations",schemaPath:"#/properties/request/properties/scope/properties/conversations/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.conversations.type,parentSchema:Y.properties.request.properties.scope.properties.conversations,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.documents){let e=t.documents;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/documents",schemaPath:"#/properties/request/properties/scope/properties/documents/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.documents.type,parentSchema:Y.properties.request.properties.scope.properties.documents,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.events){let e=t.events;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/events",schemaPath:"#/properties/request/properties/scope/properties/events/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.events.type,parentSchema:Y.properties.request.properties.scope.properties.events,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.interactions){let e=t.interactions;if(Array.isArray(e)){const t=e.length;for(let r=0;r<t;r++){let t=e[r];if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.content){let e=t.content;if("string"!=typeof e){const t={instancePath:s+"/request/scope/interactions/"+r+"/content",schemaPath:"Interaction/properties/content/type",keyword:"type",params:{type:"string"},message:"must be string",schema:se.properties.content.type,parentSchema:se.properties.content,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.id){let e=t.id;if("string"!=typeof e){const t={instancePath:s+"/request/scope/interactions/"+r+"/id",schemaPath:"Interaction/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:se.properties.id.type,parentSchema:se.properties.id,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.name){let e=t.name;if("string"!=typeof e){const t={instancePath:s+"/request/scope/interactions/"+r+"/name",schemaPath:"Interaction/properties/name/type",keyword:"type",params:{type:"string"},message:"must be string",schema:se.properties.name.type,parentSchema:se.properties.name,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.role){let e=t.role;if("string"!=typeof e){const t={instancePath:s+"/request/scope/interactions/"+r+"/role",schemaPath:"Interaction/properties/role/type",keyword:"type",params:{type:"string"},message:"must be string",schema:se.properties.role.type,parentSchema:se.properties.role,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.timestamp){let e=t.timestamp;if("string"!=typeof e){const t={instancePath:s+"/request/scope/interactions/"+r+"/timestamp",schemaPath:"Interaction/properties/timestamp/type",keyword:"type",params:{type:"string"},message:"must be string",schema:se.properties.timestamp.type,parentSchema:se.properties.timestamp,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/scope/interactions/"+r,schemaPath:"Interaction/type",keyword:"type",params:{type:"object"},message:"must be object",schema:se.type,parentSchema:se,data:t};null===i?i=[e]:i.push(e),o++}}}else{const t={instancePath:s+"/request/scope/interactions",schemaPath:"#/properties/request/properties/scope/properties/interactions/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.interactions.type,parentSchema:Y.properties.request.properties.scope.properties.interactions,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.items){let e=t.items;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/items",schemaPath:"#/properties/request/properties/scope/properties/items/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.items.type,parentSchema:Y.properties.request.properties.scope.properties.items,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.locations){let e=t.locations;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/locations",schemaPath:"#/properties/request/properties/scope/properties/locations/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.locations.type,parentSchema:Y.properties.request.properties.scope.properties.locations,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.offers){let e=t.offers;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/offers",schemaPath:"#/properties/request/properties/scope/properties/offers/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.offers.type,parentSchema:Y.properties.request.properties.scope.properties.offers,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.operators){let e=t.operators;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/operators",schemaPath:"#/properties/request/properties/scope/properties/operators/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.operators.type,parentSchema:Y.properties.request.properties.scope.properties.operators,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.orders){let e=t.orders;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/orders",schemaPath:"#/properties/request/properties/scope/properties/orders/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.orders.type,parentSchema:Y.properties.request.properties.scope.properties.orders,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.organizations){let e=t.organizations;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/organizations",schemaPath:"#/properties/request/properties/scope/properties/organizations/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.organizations.type,parentSchema:Y.properties.request.properties.scope.properties.organizations,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.persons){let e=t.persons;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/persons",schemaPath:"#/properties/request/properties/scope/properties/persons/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.persons.type,parentSchema:Y.properties.request.properties.scope.properties.persons,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.policies){let e=t.policies;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/policies",schemaPath:"#/properties/request/properties/scope/properties/policies/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.policies.type,parentSchema:Y.properties.request.properties.scope.properties.policies,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.products){let e=t.products;if(Array.isArray(e)){const t=e.length;for(let r=0;r<t;r++){let t=e[r];if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.id){let e=t.id;if("string"!=typeof e){const t={instancePath:s+"/request/scope/products/"+r+"/id",schemaPath:"Product/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:re.properties.id.type,parentSchema:re.properties.id,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/scope/products/"+r,schemaPath:"Product/type",keyword:"type",params:{type:"object"},message:"must be object",schema:re.type,parentSchema:re,data:t};null===i?i=[e]:i.push(e),o++}}}else{const t={instancePath:s+"/request/scope/products",schemaPath:"#/properties/request/properties/scope/properties/products/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.products.type,parentSchema:Y.properties.request.properties.scope.properties.products,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.properties){let e=t.properties;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/properties",schemaPath:"#/properties/request/properties/scope/properties/properties/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.properties.type,parentSchema:Y.properties.request.properties.scope.properties.properties,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.services){let e=t.services;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/services",schemaPath:"#/properties/request/properties/scope/properties/services/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.services.type,parentSchema:Y.properties.request.properties.scope.properties.services,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.subscriptions){let e=t.subscriptions;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/subscriptions",schemaPath:"#/properties/request/properties/scope/properties/subscriptions/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.subscriptions.type,parentSchema:Y.properties.request.properties.scope.properties.subscriptions,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.tickets){let e=t.tickets;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/tickets",schemaPath:"#/properties/request/properties/scope/properties/tickets/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.tickets.type,parentSchema:Y.properties.request.properties.scope.properties.tickets,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.transactions){let e=t.transactions;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/transactions",schemaPath:"#/properties/request/properties/scope/properties/transactions/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.transactions.type,parentSchema:Y.properties.request.properties.scope.properties.transactions,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.users){let e=t.users;if(!Array.isArray(e)){const t={instancePath:s+"/request/scope/users",schemaPath:"#/properties/request/properties/scope/properties/users/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.scope.properties.users.type,parentSchema:Y.properties.request.properties.scope.properties.users,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/scope",schemaPath:"#/properties/request/properties/scope/type",keyword:"type",params:{type:"object"},message:"must be object",schema:Y.properties.request.properties.scope.type,parentSchema:Y.properties.request.properties.scope,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.settings){let t=e.settings;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.disableBrowsing){let e=t.disableBrowsing;if("boolean"!=typeof e){const t={instancePath:s+"/request/settings/disableBrowsing",schemaPath:"#/properties/request/properties/settings/properties/disableBrowsing/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:Y.properties.request.properties.settings.properties.disableBrowsing.type,parentSchema:Y.properties.request.properties.settings.properties.disableBrowsing,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.disableSearch){let e=t.disableSearch;if("boolean"!=typeof e){const t={instancePath:s+"/request/settings/disableSearch",schemaPath:"#/properties/request/properties/settings/properties/disableSearch/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:Y.properties.request.properties.settings.properties.disableSearch.type,parentSchema:Y.properties.request.properties.settings.properties.disableSearch,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.disableSources){let e=t.disableSources;if("boolean"!=typeof e){const t={instancePath:s+"/request/settings/disableSources",schemaPath:"#/properties/request/properties/settings/properties/disableSources/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:Y.properties.request.properties.settings.properties.disableSources.type,parentSchema:Y.properties.request.properties.settings.properties.disableSources,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.disableStream){let e=t.disableStream;if("boolean"!=typeof e){const t={instancePath:s+"/request/settings/disableStream",schemaPath:"#/properties/request/properties/settings/properties/disableStream/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:Y.properties.request.properties.settings.properties.disableStream.type,parentSchema:Y.properties.request.properties.settings.properties.disableStream,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.disableTools){let e=t.disableTools;if("boolean"!=typeof e){const t={instancePath:s+"/request/settings/disableTools",schemaPath:"#/properties/request/properties/settings/properties/disableTools/type",keyword:"type",params:{type:"boolean"},message:"must be boolean",schema:Y.properties.request.properties.settings.properties.disableTools.type,parentSchema:Y.properties.request.properties.settings.properties.disableTools,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.maxResponseLength){let e=t.maxResponseLength;if("number"!=typeof e){const t={instancePath:s+"/request/settings/maxResponseLength",schemaPath:"#/properties/request/properties/settings/properties/maxResponseLength/type",keyword:"type",params:{type:"number"},message:"must be number",schema:Y.properties.request.properties.settings.properties.maxResponseLength.type,parentSchema:Y.properties.request.properties.settings.properties.maxResponseLength,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.overrideInterfaceLanguage){let e=t.overrideInterfaceLanguage;if("string"!=typeof e){const t={instancePath:s+"/request/settings/overrideInterfaceLanguage",schemaPath:"#/properties/request/properties/settings/properties/overrideInterfaceLanguage/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Y.properties.request.properties.settings.properties.overrideInterfaceLanguage.type,parentSchema:Y.properties.request.properties.settings.properties.overrideInterfaceLanguage,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.overrideOutputLanguage){let e=t.overrideOutputLanguage;if("string"!=typeof e){const t={instancePath:s+"/request/settings/overrideOutputLanguage",schemaPath:"#/properties/request/properties/settings/properties/overrideOutputLanguage/type",keyword:"type",params:{type:"string"},message:"must be string",schema:Y.properties.request.properties.settings.properties.overrideOutputLanguage.type,parentSchema:Y.properties.request.properties.settings.properties.overrideOutputLanguage,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/settings",schemaPath:"#/properties/request/properties/settings/type",keyword:"type",params:{type:"object"},message:"must be object",schema:Y.properties.request.properties.settings.type,parentSchema:Y.properties.request.properties.settings,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.a2a){let t=e.a2a;if(Array.isArray(t)){const e=t.length;for(let r=0;r<e;r++){let e=t[r];if(e&&"object"==typeof e&&!Array.isArray(e)){if(void 0!==e.id){let t=e.id;if("string"!=typeof t){const e={instancePath:s+"/request/a2a/"+r+"/id",schemaPath:"A2AConfiguration/properties/id/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ae.properties.id.type,parentSchema:ae.properties.id,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.name){let t=e.name;if("string"!=typeof t){const e={instancePath:s+"/request/a2a/"+r+"/name",schemaPath:"A2AConfiguration/properties/name/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ae.properties.name.type,parentSchema:ae.properties.name,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.type){let t=e.type;if("string"!=typeof t){const e={instancePath:s+"/request/a2a/"+r+"/type",schemaPath:"A2AConfiguration/properties/type/type",keyword:"type",params:{type:"string"},message:"must be string",schema:ae.properties.type.type,parentSchema:ae.properties.type,data:t};null===i?i=[e]:i.push(e),o++}}}else{const t={instancePath:s+"/request/a2a/"+r,schemaPath:"A2AConfiguration/type",keyword:"type",params:{type:"object"},message:"must be object",schema:ae.type,parentSchema:ae,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/a2a",schemaPath:"#/properties/request/properties/a2a/type",keyword:"type",params:{type:"array"},message:"must be array",schema:Y.properties.request.properties.a2a.type,parentSchema:Y.properties.request.properties.a2a,data:t};null===i?i=[e]:i.push(e),o++}}if(void 0!==e.cursor){let t=e.cursor;if(t&&"object"==typeof t&&!Array.isArray(t)){if(void 0!==t.since){let e=t.since;if("string"!=typeof e){const t={instancePath:s+"/request/cursor/since",schemaPath:"Cursor/properties/since/type",keyword:"type",params:{type:"string"},message:"must be string",schema:pe.properties.since.type,parentSchema:pe.properties.since,data:e};null===i?i=[t]:i.push(t),o++}}if(void 0!==t.until){let e=t.until;if("string"!=typeof e){const t={instancePath:s+"/request/cursor/until",schemaPath:"Cursor/properties/until/type",keyword:"type",params:{type:"string"},message:"must be string",schema:pe.properties.until.type,parentSchema:pe.properties.until,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s+"/request/cursor",schemaPath:"Cursor/type",keyword:"type",params:{type:"object"},message:"must be object",schema:pe.type,parentSchema:pe,data:t};null===i?i=[e]:i.push(e),o++}}}else{const t={instancePath:s+"/request",schemaPath:"#/properties/request/type",keyword:"type",params:{type:"object"},message:"must be object",schema:Y.properties.request.type,parentSchema:Y.properties.request,data:e};null===i?i=[t]:i.push(t),o++}}}else{const e={instancePath:s,schemaPath:"#/type",keyword:"type",params:{type:"object"},message:"must be object",schema:Y.type,parentSchema:Y,data:t};null===i?i=[e]:i.push(e),o++}return e.errors=i,0===o};const le=e=>({valid:G(e),errors:G.errors||null}),ge=e=>({valid:he(e),errors:he.errors||null});function fe(e,t,s="validation",r={}){return{instancePath:e,message:t,keyword:s,params:r}}function be(e){if(!e||"object"!=typeof e)return{valid:!1,errors:[fe("","must be object","type",{type:"object"})]};const t=[];return e.session?"object"!=typeof e.session?t.push(fe("/session","must be object","type",{type:"object"})):void 0!==e.session.sessionId&&"string"!=typeof e.session.sessionId&&t.push(fe("/session/sessionId","must be string","type",{type:"string"})):t.push(fe("/session","is required","required",{missingProperty:"session"})),e.request?"object"!=typeof e.request?t.push(fe("/request","must be object","type",{type:"object"})):(e.request.connections?"object"!=typeof e.request.connections?t.push(fe("/request/connections","must be object","type",{type:"object"})):(e.request.connections.threadId?"string"!=typeof e.request.connections.threadId&&t.push(fe("/request/connections/threadId","must be string","type",{type:"string"})):t.push(fe("/request/connections/threadId","is required","required",{missingProperty:"threadId"})),void 0!==e.request.connections.parentId&&"string"!=typeof e.request.connections.parentId&&t.push(fe("/request/connections/parentId","must be string","type",{type:"string"}))):t.push(fe("/request/connections","is required","required",{missingProperty:"connections"})),void 0!==e.request.context&&"object"!=typeof e.request.context&&t.push(fe("/request/context","must be object","type",{type:"object"})),void 0!==e.request.attributes&&"object"!=typeof e.request.attributes&&t.push(fe("/request/attributes","must be object","type",{type:"object"})),void 0!==e.request.scope&&("object"!=typeof e.request.scope?t.push(fe("/request/scope","must be object","type",{type:"object"})):void 0!==e.request.scope.conversations&&(Array.isArray(e.request.scope.conversations)||t.push(fe("/request/scope/conversations","must be array","type",{type:"array"})))),void 0!==e.request.resources&&("object"!=typeof e.request.resources?t.push(fe("/request/resources","must be object","type",{type:"object"})):void 0!==e.request.resources.offers&&(Array.isArray(e.request.resources.offers)||t.push(fe("/request/resources/offers","must be array","type",{type:"array"}))))):t.push(fe("/request","is required","required",{missingProperty:"request"})),t.length>0?{valid:!1,errors:t}:{valid:!0,errors:null}}function ve(e){if(!e||"object"!=typeof e)return{valid:!1,errors:[fe("","must be object","type",{type:"object"})]};const t=[];if(e.headers)if("object"!=typeof e.headers)t.push(fe("/headers","must be object","type",{type:"object"}));else{if(e.headers.correlationId?"string"!=typeof e.headers.correlationId&&t.push(fe("/headers/correlationId","must be string","type",{type:"string"})):t.push(fe("/headers/correlationId","is required","required",{missingProperty:"correlationId"})),e.headers.action)if("string"!=typeof e.headers.action)t.push(fe("/headers/action","must be string","type",{type:"string"}));else{const s=["adjust","elevate","interaction","customerinteraction","reception","summarize","translate","recommend","insights"];s.includes(e.headers.action)||t.push(fe("/headers/action","must be equal to one of the allowed values","enum",{allowedValues:s}))}else t.push(fe("/headers/action","is required","required",{missingProperty:"action"}));void 0!==e.headers.identifier&&"string"!=typeof e.headers.identifier&&t.push(fe("/headers/identifier","must be string","type",{type:"string"})),void 0!==e.headers.schemaRef&&"string"!=typeof e.headers.schemaRef&&t.push(fe("/headers/schemaRef","must be string","type",{type:"string"})),void 0!==e.headers.timestamp&&"string"!=typeof e.headers.timestamp&&t.push(fe("/headers/timestamp","must be string","type",{type:"string"}))}else t.push(fe("/headers","is required","required",{missingProperty:"headers"}));if(e.payload){if("object"!=typeof e.payload)t.push(fe("/payload","must be object","type",{type:"object"}));else if(e.headers&&e.headers.action&&e.payload){const s=e.headers.action;["adjust","elevate","interaction","customerinteraction","customerInteraction","summarize","translate","insights","recommend"].includes(s)&&(e.payload.request?e.payload.request.scope?e.payload.request.scope.conversations?Array.isArray(e.payload.request.scope.conversations)?0===e.payload.request.scope.conversations.length&&t.push(fe("/payload/request/scope/conversations",`must be non-empty array for ${s}`,"minItems",{limit:1})):t.push(fe("/payload/request/scope/conversations","must be array","type",{type:"array"})):t.push(fe("/payload/request/scope/conversations",`is required for ${s}`,"required",{missingProperty:"conversations"})):t.push(fe("/payload/request/scope","is required","required",{missingProperty:"scope"})):t.push(fe("/payload/request","is required","required",{missingProperty:"request"})))}}else t.push(fe("/payload","is required","required",{missingProperty:"payload"}));return t.length>0?{valid:!1,errors:t}:{valid:!0,errors:null}}const qe="3.2.1",Pe=`optave.message.v${qe.split(".")[0]}`,Se={AUTHENTICATION:"AUTHENTICATION",ORCHESTRATOR:"ORCHESTRATOR",VALIDATION:"VALIDATION",WEBSOCKET:"WEBSOCKET"},Ie=Object.freeze({MESSAGE:"message",ERROR:"error"}),we=Object.freeze({CONNECTION_OPEN:"connection:open",CONNECTION_CLOSE:"connection:close",CONNECTION_ERROR:"connection:error",MESSAGE_RECEIVED:"message:received",MESSAGE_SENT:"message:sent",ERROR:"error",RESPONSE:"response",LEGACY_ERROR:"error",LEGACY_MESSAGE:"message"}),ke=Object.freeze({SUPERPOWER_RESPONSE:"superpower.response",SUPERPOWER_ERROR:"superpower.error"}),Ae=new Set(["adjust","elevate","interaction","reception","customerInteraction","summarize","translate","recommend","insights"]),Ee={SPEC_VERSION:qe,SCHEMA_REF:Pe,MAX_PAYLOAD_SIZE:131072,MAX_PAYLOAD_SIZE_KB:128,DEFAULT_REQUEST_TIMEOUT_MS:3e4,ErrorCategory:Se,LegacyEvents:Ie,EVENTS:we,InboundEvents:ke,ALLOWED_ACTIONS:Ae};function _e(e){const t=[];if((()=>{if("undefined"!=typeof process&&process.versions&&process.versions.node&&("true"===process.env.VITEST||void 0!==process.env.JEST_WORKER_ID||process.argv.some(e=>e.includes("vitest")||e.includes("jest")||e.includes("test"))))return!(!("undefined"!=typeof global&&"window"in global&&global.window&&"document"in global&&global.document)||process.env.OPTAVE_SDK_FORCE_SERVER_ENV);if("undefined"!=typeof global){if(!("window"in global)&&!("document"in global)&&"undefined"!=typeof process&&process.versions&&process.versions.node)return!1;if((!("window"in global)||!("document"in global))&&"undefined"!=typeof process&&process.versions&&process.versions.node)return!1;if("window"in global&&global.window)return!0;if("document"in global&&global.document)return!0}try{if("undefined"!=typeof window&&null!==window)return!("undefined"!=typeof global&&!("window"in global)||"undefined"!=typeof global&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!("window"in global));if("undefined"!=typeof document&&null!==document)return!("undefined"!=typeof global&&!("document"in global)||"undefined"!=typeof global&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!("document"in global))}catch(e){}return"undefined"!=typeof navigator&&"ReactNative"===navigator.product||!("undefined"==typeof global||!global.__expo)||"undefined"!=typeof location&&null!==location||("undefined"!=typeof process&&process.versions&&process.versions.node,!1)})()&&e.clientSecret){let e=!1,s=!1;try{e=!0===__SALESFORCE_BUILD__}catch(e){}try{s=!0}catch(e){}e||s||t.push({type:"error",code:"CLIENT_SECRET_IN_CLIENT_ENV",message:"clientSecret must not be supplied in a client environment (browser, mobile, Electron renderer). Use options.tokenProvider() to obtain a short-lived token.",field:"clientSecret"})}return t}const je={BROWSER_ESM:"browser-esm",SERVER_ESM:"server-esm",BROWSER_UMD:"browser-umd",SERVER_UMD:"server-umd"},Oe={browser:je.BROWSER_ESM,server:je.SERVER_ESM},Re={BROWSER:[je.BROWSER_ESM,je.BROWSER_UMD,je.SERVER_UMD],SERVER:[je.SERVER_ESM],UMD:[je.BROWSER_UMD,je.SERVER_UMD],ESM:[je.BROWSER_ESM,je.SERVER_ESM]},Te={isValid:e=>Object.values(je).includes(e)||Object.keys(Oe).includes(e),normalize:e=>Oe[e]?Oe[e]:Object.values(je).includes(e)?e:"unknown",isBrowser(e){const t=this.normalize(e);return Re.BROWSER.includes(t)},isServer(e){const t=this.normalize(e);return Re.SERVER.includes(t)},isUMD(e){const t=this.normalize(e);return Re.UMD.includes(t)},isESM(e){const t=this.normalize(e);return Re.ESM.includes(t)},getInfo(e){return{original:e,normalized:this.normalize(e),valid:this.isValid(e),isBrowser:this.isBrowser(e),isServer:this.isServer(e),isUMD:this.isUMD(e),isESM:this.isESM(e)}}};class Ce extends Error{constructor({category:e,code:t,message:s,details:r}){super(s),this.name="OptaveError",this.category=e||"UNKNOWN",this.code=t||"UNKNOWN",void 0!==r&&(this.details=r)}}!function(){if("undefined"!=typeof globalThis){globalThis.__OPTAVE_SECURITY_GUARDS_ACTIVE__=!0;if(!globalThis.__OPTAVE_SECURITY_GUARDS_ACTIVE__)throw new Error("Security guard initialization failed")}"undefined"!=typeof process&&process.env}(),"undefined"!=typeof window?window.__OPTAVE_SECURITY_GUARDS_BROWSER__=!0:"undefined"!=typeof global&&(global.__OPTAVE_SECURITY_GUARDS_NODE__=!0);const Le="3.2.1",De=()=>{const e="server-esm";return{isBrowser:Te.isBrowser(e),isServer:Te.isServer(e),buildTarget:e}};let Ne=!1,Ue=!1;class Me extends e{options={};wss=null;static defaultPayload={session:{sessionId:"",channel:{browser:"",deviceInfo:"",deviceType:"",language:"",location:"",medium:"chat",metadata:[],section:""},interface:{appVersion:"",category:"",language:"",name:"",type:""}},request:{requestId:"",attributes:{content:"",instruction:"",variant:"A"},connections:{journeyId:"",parentId:"",threadId:""},context:{caseId:"",departmentId:"",operatorId:"",organizationId:"",userId:""},reference:{ids:[{name:"",value:""}],labels:[],tags:[]},resources:{codes:[{id:"",label:"",type:"",value:""}],links:[{expires_at:"",html:!1,id:"",label:"",type:"",url:""}],offers:[]},scope:{accounts:[],appointments:[],assets:[],bookings:[],cases:[],conversations:[],documents:[],events:[],interactions:[],items:[],locations:[],operators:[],orders:[],organizations:[],persons:[],policies:[],products:[{id:""}],properties:[],services:[],subscriptions:[],tickets:[],transactions:[],users:[]},settings:{disableBrowsing:!1,disableSearch:!1,disableSources:!1,disableStream:!0,disableTools:!1,maxResponseLength:0,overrideInterfaceLanguage:"",overrideOutputLanguage:""},a2a:[{id:"",name:"",type:""}],cursor:{since:"",until:""}}};static cleanup(){Ne=!1,Ue=!1}constructor(e){if(super(),this.options={...e},function(e){if(void 0===e.strictValidation){const t="undefined"!=typeof process&&process.env?"production":"development";e.strictValidation="production"!==t}if("number"!=typeof e.requestTimeoutMs&&(e.requestTimeoutMs=3e4),"number"!=typeof e.connectionTimeoutMs&&(e.connectionTimeoutMs=1e4),e.logger||(e.logger={debug(){},info(){},warn(){},error(){}}),e.authTransport||(e.authTransport="subprotocol"),void 0===e.authRequired&&(e.authRequired=!0),!e.tokenProvider){let t=e.tokenUrl;if(!t&&"undefined"!=typeof document){const e=document.querySelector('meta[name="optave-token-url"]');e&&e.content&&(t=e.content)}t||(t="/api/optave/ws-ticket"),e.tokenProvider=async()=>{const s={};e.publishableKey&&(s["X-Optave-Publishable-Key"]=e.publishableKey);const r=await fetch(t,{method:"POST",credentials:"include",headers:s});if(!r.ok)throw new Error("Failed to obtain WS token");const a=await r.json();return a.token||a.access_token}}}(this.options),void 0===this.options.cspSafe){const e=De();"server-esm"===e.buildTarget||"server"===e.buildTarget?this.options.cspSafe=!1:("server-umd"===e.buildTarget||"browser-esm"===e.buildTarget||"browser-umd"===e.buildTarget||e.isBrowser||(()=>{const e=De();return"unknown"!==e.buildTarget?e.isBrowser:"undefined"!=typeof window&&void 0!==window.WebSocket})())&&(this.options.cspSafe=!0)}const t=function(e){const t={isValid:!0,errors:[],warnings:[]},s=function(e){const t=[];return e.websocketUrl&&"string"==typeof e.websocketUrl||t.push({type:"warning",code:"MISSING_WEBSOCKET_URL",message:"websocketUrl not provided; openConnection() will emit an error.",field:"websocketUrl"}),t}(e),r=function(e){const t=[];return!e.authenticationUrl||e.clientId&&e.clientSecret||t.push({type:"warning",code:"INCOMPLETE_AUTH_CONFIG",message:"authenticationUrl provided but clientId/clientSecret incomplete; authenticate() may fail.",field:"authentication"}),t}(e),a=[...s,...r,..._e(e)];for(const e of a)"error"===e.type?(t.errors.push(e),t.isValid=!1):"warning"===e.type&&t.warnings.push(e);return t}(this.options);if(!t.isValid){const e=t.errors.map(e=>e.message).join("; ");throw new Error(`[Optave SDK] Configuration errors: ${e}`)}t.warnings.forEach(e=>{(this.options?.logger?.warn||console.warn)(`[Optave SDK] ${e.message}`)});try{!function(e,t,s={}){if(!e||"string"!=typeof e)return;const r=Te.normalize(t),a=Te.isUMD(r),p=Te.isBrowser(r);if((a||p)&&e.startsWith("ws://"))throw new Error(`[Optave SDK] Insecure WebSocket protocol (ws://) is not allowed in UMD builds. Salesforce Lightning Locker Service blocks all ws:// connections for security reasons. Please use secure WebSocket protocol (wss://) instead. Current URL: ${e}`);if(a&&e.startsWith("wss://")){const t="function"==typeof s.tokenProvider,r=!1===s.authRequired;if(!t&&!r)throw new Error(`[Optave SDK] UMD builds require a tokenProvider function for secure WebSocket connections. In constrained environments like Salesforce Lightning, authentication tokens must be obtained from your backend server. Please provide options.tokenProvider() that returns a valid token, or set options.authRequired = false to disable authentication. Current URL: ${e}`)}}(this.options.websocketUrl,"server-esm",this.options)}catch(e){throw e}const s=De();this.WebSocketImpl=this.options.WebSocketImpl,!this.WebSocketImpl&&s.isBrowser?this.WebSocketImpl=("undefined"!=typeof WebSocket?WebSocket:void 0)||("undefined"!=typeof window&&window.WebSocket?window.WebSocket:void 0):!this.WebSocketImpl&&s.isServer&&(this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:void 0),this._pending=new Map,this._deprecatedKeys=new Set,this._silenceDeprecations="undefined"!=typeof process&&"1"===process?.env?.OPTAVE_SDK_SILENCE_DEPRECATIONS,this.options.cspSafe?(this._validatePayload=be,this._validateMessageEnvelope=ve):(this._validatePayload=ge,this._validateMessageEnvelope=le)}async _ensureWebSocketImpl(){if(this.WebSocketImpl)return this.WebSocketImpl;const e=De();return this.WebSocketImpl=this.options.WebSocketImpl,!this.WebSocketImpl&&e.isBrowser?this.WebSocketImpl=("undefined"!=typeof WebSocket?WebSocket:void 0)||("undefined"!=typeof window&&window.WebSocket?window.WebSocket:void 0):!this.WebSocketImpl&&e.isServer&&(this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:void 0),this.WebSocketImpl||(e.isBrowser?this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:null:e.isServer&&(this.WebSocketImpl=await this.loadNodeWebSocket())),this.WebSocketImpl}async loadNodeWebSocket(){const e=De();return e.isBrowser?null:("unknown"!==e.buildTarget||"undefined"==typeof window&&"undefined"==typeof document&&"undefined"==typeof navigator&&"undefined"==typeof location)&&"undefined"!=typeof process&&process.versions&&process.versions.node?await async function(){return"undefined"!=typeof window||"undefined"!=typeof document||"undefined"!=typeof navigator||"undefined"!=typeof location?null:"undefined"!=typeof process&&process.versions&&process.versions.node?a:null}():null}static getSdkVersion(){return Le}static getSpecVersion(){return qe}static getSchemaRef(){return Pe}static get CONSTANTS(){return Ee}static get LegacyEvents(){return Ie}static get InboundEvents(){return ke}setSessionId(e){return this.sessionId=e,this}getSessionId(){return this.sessionId||""}validate(e){return this._validatePayload(e).valid}validateEnvelope(e){return this._validateMessageEnvelope(e).valid}validateRequiredFields(e,t){const s=[];switch(e.request?.connections?.threadId||s.push("request.connections.threadId is required"),t){case"adjust":e.request?.attributes?.content||s.push("request.attributes.content is required for adjust"),e.request?.attributes?.instruction||s.push("request.attributes.instruction is required for adjust"),e.request?.connections?.parentId||s.push("request.connections.parentId is required for adjust"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for adjust and must be a non-empty array");break;case"elevate":e.request?.attributes?.content||s.push("request.attributes.content is required for elevate"),e.request?.connections?.parentId||s.push("request.connections.parentId is required for elevate"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for elevate and must be a non-empty array");break;case"translate":case"summarize":case"insights":case"customerinteraction":case"customerInteraction":case"interaction":e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push(`request.scope.conversations is required for ${t} and must be a non-empty array`);break;case"recommend":e.request?.resources?.offers&&Array.isArray(e.request.resources.offers)&&0!==e.request.resources.offers.length||s.push("request.resources.offers is required for recommend and must be a non-empty array"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for recommend and must be a non-empty array")}return{isValid:0===s.length,errors:s}}async authenticate(){if(Te.isBrowser("server-esm"))return this.handleError(Se.AUTHENTICATION,"UNSUPPORTED_IN_BROWSER","authenticate() is not available in browsers. Use options.tokenProvider() to obtain a short-lived WebSocket token from your backend."),null;let e={grant_type:"client_credentials"};if(!this.options.authenticationUrl)return this.handleError(Se.AUTHENTICATION,"INVALID_AUTHENTICATION_URL","Empty or invalid authentication URL"),null;if(!this.options.clientId)return this.handleError(Se.AUTHENTICATION,"INVALID_CLIENT_ID","Empty or invalid client ID"),null;e.client_id=this.options.clientId,e.client_secret=this.options.clientSecret;const t=new URLSearchParams(e).toString();let s=this.options.authenticationUrl;s.endsWith("/token")||(s=s.endsWith("/")?s+"token":s+"/token");const r=`${s}?${t}`,a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"}}),p=await a.json();return a.ok?p.access_token:(this.handleError(Se.AUTHENTICATION,"INVALID_AUTHENTICATION_RESPONSE",this.formatAuthenticationError(a,p.error,"token endpoint").message,p.error),null)}async openConnection(e){if(!this.options.websocketUrl)return(this.options?.logger?.error||console.error)("[Optave SDK] openConnection aborted: missing websocketUrl"),void this.handleError(Se.WEBSOCKET,"INVALID_WEBSOCKET_URL",this.formatWebSocketError(new Error("Invalid WebSocket URL configuration"),{url:this.options.websocketUrl}).message,this.options.websocketUrl);const t=await(async()=>{if("string"==typeof e&&e.length>0)return e;if("function"==typeof this.options.tokenProvider)try{return await this.options.tokenProvider()}catch(e){return this.handleError(Se.AUTHENTICATION,"TOKEN_PROVIDER_FAILED",this.formatTokenProviderError(e).message,e),null}return null})();if(await this._ensureWebSocketImpl(),!this.WebSocketImpl)return void this.handleError(Se.WEBSOCKET,"NO_WEBSOCKET_IMPL",this.formatWebSocketError(new Error("No WebSocket implementation available"),{environment:"undefined"!=typeof window?"browser":"node"}).message);if(!t&&!1!==this.options.authRequired)return void this.handleError(Se.AUTHENTICATION,"MISSING_TOKEN","No WebSocket token available. Provide options.tokenProvider() or set options.tokenUrl.");const s=new URLSearchParams;this.sessionId&&s.set("OptaveTraceChatSessionId",this.sessionId);try{if("subprotocol"===this.options.authTransport){const e=t?["optave-v1",t]:["optave-v1"];this.wss=new this.WebSocketImpl(s.toString()?`${this.options.websocketUrl}?${s.toString()}`:this.options.websocketUrl,e)}else{if(t){const e=t.replace(/^Bearer\s+/i,"");s.set("Authorization",e)}this.wss=new this.WebSocketImpl(s.toString()?`${this.options.websocketUrl}?${s.toString()}`:this.options.websocketUrl),t&&this._warnOnce("_warnedQueryToken",'[Optave SDK] Passing auth token in WebSocket URL query is discouraged. Prefer authTransport="subprotocol".')}}catch(e){return(this.options?.logger?.error||console.error)("[Optave SDK] WebSocket constructor threw",e),void this.handleError(Se.WEBSOCKET,"WEBSOCKET_ERROR",this.formatWebSocketError(e,{url:this.options.websocketUrl}).message,e)}return new Promise((e,t)=>{const s=setTimeout(()=>{const e=this.options.connectionTimeoutMs||3e4,s=this.formatWebSocketError(new Error("Connection timeout"),{timeout:e,url:this.options.websocketUrl}).message;this.handleError(Se.WEBSOCKET,"CONNECTION_TIMEOUT",s),t({category:Se.WEBSOCKET,code:"CONNECTION_TIMEOUT",message:s,details:null})},this.options.connectionTimeoutMs||3e4);this.wss.onopen=t=>{clearTimeout(s),this.emit("open",t),e(t)},this.wss.onmessage=e=>{this._handleInbound(e.data)},this.wss.onclose=e=>{clearTimeout(s),this.emit("close",e);for(const[t,s]of this._pending.entries())s.timer&&clearTimeout(s.timer),s._handled=!0,s.reject({category:Se.WEBSOCKET,code:"CONNECTION_CLOSED",message:`WebSocket connection closed: ${e.reason||"Connection lost"}`,details:{code:e.code,reason:e.reason,correlationId:t},correlationId:t});this._pending.clear(),this.wss=null},this.wss.onerror=e=>{clearTimeout(s);const r=e.message||(e instanceof Error?e.message:null)||"object"==typeof e&&e.error&&e.error.message||"WebSocket connection failed",a={category:Se.WEBSOCKET,code:"CONNECTION_ERROR",message:r,details:{originalError:e}};for(const[e,t]of this._pending.entries())t.timer&&clearTimeout(t.timer),t._handled=!0,t.reject({...a,details:{...a.details,correlationId:e},correlationId:e});this._pending.clear(),this.emit("error",a),t(a)}})}_warnOnce(e,t){this[e]||(this[e]=!0,(this.options?.logger?.warn||console.warn)(t))}deprecate(e,t){this._silenceDeprecations||this._deprecatedKeys.has(e)||(this._deprecatedKeys.add(e),(this.options?.logger?.warn||console.warn)(t))}_handleInbound(e){let t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){const t={category:Se.WEBSOCKET,code:"INVALID_JSON",message:"Invalid JSON received from server",details:e,timestamp:(new Date).toISOString()};return void this._emitError(t)}const s=t&&t.headers&&t.payload,r="error"===t?.state||"error"===t?.actionType||!!t?.error;if(this.options.strictValidation&&s){const e=this._validateMessageEnvelope(t);e.valid||this.handleError(Se.VALIDATION,"INBOUND_ENVELOPE_SCHEMA_MISMATCH",this.formatValidationErrorMessage(e.errors,"Inbound envelope validation failed"),e.errors)}if(r){const e=t?.headers&&t.headers.correlationId||t?.correlationId||null,s={category:Se.ORCHESTRATOR,code:t?.error?.code||"REMOTE_ERROR",message:t?.error?.message||t?.message||"Remote error",details:t?.error||t,correlationId:e};if(e&&this._pending.has(e)){const t=this._pending.get(e);t.timer&&clearTimeout(t.timer),t._handled=!0,this._pending.delete(e),t.reject(s)}return void this._emitError(s,t?.action)}const a=t?.headers?.correlationId||t?.correlationId;if(a&&this._pending.has(a)){const e=this._pending.get(a);e.timer&&clearTimeout(e.timer),e._handled=!0,this._pending.delete(a),e.resolve(t)}this.emit(Ie.MESSAGE,t),Ne||(Ne=!0,(this.options?.logger?.warn||console.warn)('[optave-sdk][deprecation] The "message" event will be deprecated. Please also listen to "superpower.response".')),this.emit(ke.SUPERPOWER_RESPONSE,t),this.emit(we.RESPONSE,t),t?.action&&this.emit(`message.${t.action}`.toLowerCase(),t),s&&t.headers.schemaRef&&this.emit(t.headers.schemaRef,t)}_emitError(e,t=null){e.timestamp||(e.timestamp=(new Date).toISOString()),this.emit(Ie.ERROR,e),Ue||(Ue=!0,(this.options?.logger?.warn||console.warn)('[optave-sdk][deprecation] The "error" (string payload) is deprecated. Please also listen to "superpower.error" for a structured error object.'));const s=(r=e)&&r.category&&r.code&&r.message?new Ce(r):"string"==typeof r?new Ce({category:"UNKNOWN",code:"STRING_ERROR",message:r}):r&&"AjvValidationError"===r.name?new Ce({category:"VALIDATION",code:"SCHEMA_VALIDATION",message:r.message,details:r.errors}):r&&r.isAuthError?new Ce({category:"AUTHENTICATION",code:r.code||"AUTH_ERROR",message:r.message||"Authentication error",details:r}):r&&r.isWsError?new Ce({category:"WEBSOCKET",code:r.code||"WS_ERROR",message:r.message||"WebSocket error",details:r}):new Ce({category:"UNKNOWN",code:"UNCLASSIFIED",message:r&&r.message||String(null!=r?r:"Unknown error"),details:r});var r;this.emit(ke.SUPERPOWER_ERROR,s),this.emit(we.ERROR,e)}closeConnection(){this.wss&&(this.wss.onopen=null,this.wss.onmessage=null,this.wss.onclose=null,this.wss.onerror=null,this.wss.close(),this.wss=null)}selectiveDeepMerge(e,t){if(Array.isArray(e)&&Array.isArray(t))return[...t];const s=e=>null!==e&&"object"==typeof e&&!Array.isArray(e);if(s(e)&&s(t)){const s={...e};for(let r in t)s[r]=r in e?this.selectiveDeepMerge(e[r],t[r]):t[r];return s}return void 0!==t?t:e}isPayloadSizeValid(e){return!!e&&e.length/1024<=Ee.MAX_PAYLOAD_SIZE_KB}openConnectionAsync(e){return new Promise((t,s)=>{const r=e=>{this.off("error",a),t(e)},a=e=>{this.off("open",r),s(e)};this.once("open",r),this.once("error",a),this.openConnection(e)})}buildPayload(e,t,s){let r=this.selectiveDeepMerge(Me.defaultPayload,s);return s?.request?.variation&&(this.deprecate("payload.request.variation","[Deprecation] 'request.variation' is deprecated; use 'request.attributes.variant'."),r.request.attributes.variant=s.request.variation),s?.request?.content&&!r.request?.attributes?.content&&(r.request.attributes.content=s.request.content,this.deprecate("payload.request.content","[Deprecation] 'request.content' is deprecated; use 'request.attributes.content'.")),r.request.attributes.variant&&(r.request.attributes.variant=r.request.attributes.variant.toUpperCase()),r}resolveMessageId(e,t){return`${t}.${e}.v3`.toLowerCase()}buildMessageEnvelope(e,t,s,r={}){const a=(new Date).toISOString(),p=r.correlationId||e?.request?.requestId||S(),i=r.traceId||S(),o=r.idempotencyKey||S(),n=r.timestamp,c={correlationId:p,action:s,schemaRef:Pe,sdkVersion:Le,identifier:t,traceId:i,idempotencyKey:o,timestamp:n,issuedAt:a};return this.options.tenantId&&(c.tenantId=this.options.tenantId),void 0!==r.networkLatencyMs&&(c.networkLatencyMs=r.networkLatencyMs),Object.freeze(c),{action:"message",headers:c,payload:e}}formatValidationErrorMessage(e,t="Validation failed"){if(!e||!Array.isArray(e)||0===e.length)return t;if(1===e.length){const s=e[0],r=s.instancePath||"/",a="/"===r?"root object":r.replace(/^\//,"").replace(/\//g,".");if("required"===s.keyword){const e=s.params?.missingProperty||"unknown field",r="root object"===a?e:a.endsWith(e)?a:a+"."+e;return`${t}: ${"root object"===a?"Required field":"Field"} '${r}' is missing`}if("type"===s.keyword){return`${t}: Field '${a}' must be of type '${s.params?.type||"unknown"}'`}if("additionalProperties"===s.keyword){return`${t}: Field '${a}.${s.params?.additionalProperty||"unknown"}' is not allowed`}if("enum"===s.keyword){const e=s.params?.allowedValues||[];return`${t}: Field '${a}' must be one of: ${Array.isArray(e)?e.join(", "):"unknown values"}`}return`${t}: ${s.message} at '${a}'`}const s=e.filter(e=>"required"===e.keyword),r=e.filter(e=>"type"===e.keyword),a=e.filter(e=>"required"!==e.keyword&&"type"!==e.keyword);let p=t+":";if(s.length>0){p+=` Missing required fields: ${s.map(e=>{const t=(e.instancePath||"/").replace(/^\//,"").replace(/\//g,"."),s=e.params?.missingProperty||"unknown";return""===t?s:`${t}.${s}`}).join(", ")}.`}if(r.length>0){p+=` Type errors in: ${r.slice(0,3).map(e=>`${(e.instancePath||"/").replace(/^\//,"").replace(/\//g,".")||"root"} (expected ${e.params?.type||"unknown"})`).join(", ")}.`,r.length>3&&(p+=` And ${r.length-3} more type errors.`)}return a.length>0&&(p+=` Additional validation errors: ${a.length}.`),p}formatAuthenticationError(e,t,s){let r="Authentication failed";const a=[];return e&&e.status&&(r+=` (HTTP ${e.status})`),t&&("string"==typeof t?r+=`: ${t}`:t.error_description?r+=`: ${t.error_description}`:t.message?r+=`: ${t.message}`:t.error&&(r+=`: ${t.error}`)),e&&401===e.status?(a.push("Verify clientId and clientSecret are correct"),a.push("Ensure credentials match the target environment (dev/staging/production)")):e&&403===e.status?(a.push("Check if your client has the necessary permissions"),a.push("Verify the authentication endpoint URL is correct")):e&&e.status>=500?(a.push("Authentication server error - try again later"),a.push("Contact support if the problem persists")):a.push("Check network connectivity and authentication endpoint configuration"),s&&s.authUrl&&(r+=` (endpoint: ${s.authUrl})`),{message:r,suggestions:a}}formatWebSocketError(e,t){let s="WebSocket connection failed";const r=[],a=e?.message||(e instanceof Error?e.message:null)||"object"==typeof e&&e.error&&e.error.message||null;return a&&(s+=`: ${a}`),t&&(t.url&&(s+=` (URL: ${t.url})`),t.timeout&&(s+=` (timeout: ${t.timeout}ms)`)),r.push("Check network connectivity and firewall settings"),r.push("Verify WebSocket URL is correct and accessible"),t&&t.url&&(t.url.startsWith("ws://")&&r.push("Consider using secure WebSocket (wss://) for production"),(t.url.includes("localhost")||t.url.includes("127.0.0.1"))&&r.push("Ensure local server is running if connecting to localhost")),t&&t.timeout&&r.push("Try increasing connection timeout if network is slow"),{message:s,suggestions:r}}formatPayloadSizeError(e,t,s){const r=Math.ceil(e/1024);let a=`Payload too large: ${r}KB exceeds maximum ${t}KB (${r-t}KB over limit)`;const p=[];if(s&&"object"==typeof s){JSON.stringify(s);if(s.request?.scope?.conversations&&Array.isArray(s.request.scope.conversations)){const e=JSON.stringify(s.request.scope.conversations).length,t=Math.ceil(e/1024);t>10&&(p.push(`Consider reducing conversation history - current size: ~${t}KB`),p.push("Remove older messages or summarize conversation context"))}if(s.request?.resources?.offers&&Array.isArray(s.request.resources.offers)){const e=JSON.stringify(s.request.resources.offers).length,t=Math.ceil(e/1024);t>5&&p.push(`Consider reducing product offers data - current size: ~${t}KB`)}if(s.session?.channel?.metadata&&Array.isArray(s.session.channel.metadata)){const e=JSON.stringify(s.session.channel.metadata).length,t=Math.ceil(e/1024);t>2&&p.push(`Consider reducing metadata array - current size: ~${t}KB`)}}return 0===p.length&&(p.push("Remove unused fields from request payload"),p.push("Consider paginating large datasets"),p.push("Use shorter field values where possible")),{message:a,suggestions:p}}formatTokenProviderError(e,t){let s="Failed to obtain WebSocket token from tokenProvider()";const r=[];return e&&(e.message?s+=`: ${e.message}`:"string"==typeof e&&(s+=`: ${e}`),"TypeError"===e.name&&e.message?.includes("fetch")?(r.push("Check if tokenProvider endpoint is accessible"),r.push("Verify CORS settings allow requests to token endpoint")):e.message?.includes("404")||e.message?.includes("Not Found")?(r.push("Verify tokenProvider endpoint URL is correct"),r.push("Ensure backend token endpoint is implemented")):e.message?.includes("401")||e.message?.includes("403")?(r.push("Check authentication/authorization for token endpoint"),r.push("Verify user session or credentials are valid")):e.message?.includes("timeout")&&r.push("Token provider request timed out - check network or server response time")),t&&t.tokenUrl&&(s+=` (endpoint: ${t.tokenUrl})`),0===r.length&&(r.push("Verify tokenProvider function implementation"),r.push("Check backend token endpoint is running and accessible"),r.push("Review browser console for network errors")),{message:s,suggestions:r}}handleError(e,t,s,r=null,a=[],p=null){const i=new Ce({category:e,code:t,message:s,details:r});a&&(i.suggestions=a),p&&(i.correlationId=p),0===this.listenerCount(Ie.ERROR)&&0===this.listenerCount(we.ERROR)&&(this.options?.logger?.error||console.error)(`[Optave SDK] ${t}: ${s}`),this._emitError(i)}send(e,t,s){const r=null!=(this.WebSocketImpl&&this.WebSocketImpl.OPEN)?this.WebSocketImpl.OPEN:1;if(!this.wss||this.wss.readyState!==r){const e=this.wss?this.wss.readyState:"no connection";return void this.handleError(Se.WEBSOCKET,"WEBSOCKET_NOT_IN_OPEN_STATE",this.formatWebSocketError(new Error("WebSocket not ready for sending"),{readyState:e,action:t}).message)}if(!Ae.has(t))return void this.handleError(Se.VALIDATION,"INVALID_ACTION",`Unsupported action '${t}'. Allowed: ${[...Ae].join(", ")}`);const a=new Set(["session","request","headers"]);for(const e of Object.keys(s||{}))if(!a.has(e)){const t=[{instancePath:"",keyword:"additionalProperties",params:{additionalProperty:e},message:`must NOT have additional property '${e}'`}];return void this.handleError(Se.VALIDATION,"PAYLOAD_SCHEMA_MISMATCH",this.formatValidationErrorMessage(t),t)}const p=this.buildPayload(e,t,s||{}),i=this.validateRequiredFields(p||{},t);if(!i.isValid)return void this.handleError(Se.VALIDATION,"REQUIRED_FIELDS_MISSING",`Missing required fields for action '${t}': ${i.errors.join(", ")}`,i.errors);if(this.options.strictValidation){const e=this._validatePayload(p);if(!e.valid)return void this.handleError(Se.VALIDATION,"PAYLOAD_SCHEMA_MISMATCH",this.formatValidationErrorMessage(e.errors,"Schema validation failed"),e.errors)}const o=this.buildMessageEnvelope(p,e,t,s?.headers||{}),n=JSON.stringify(o);if(!this.isPayloadSizeValid(n)){const e=n.length;return void this.handleError(Se.VALIDATION,"PAYLOAD_TOO_LARGE",this.formatPayloadSizeError(e,Ee.MAX_PAYLOAD_SIZE_KB,o).message,Ee.MAX_PAYLOAD_SIZE_KB)}this.wss.send(n)}adjust(e){return this.send("message","adjust",e)}elevate(e){return this.send("message","elevate",e)}interaction(e){return this.send("message","interaction",e)}reception(e){return this.send("message","reception",e)}customerInteraction(e){return this.deprecate("method.customerInteraction","[Deprecation] 'customerInteraction' is deprecated; use 'interaction' instead."),this.send("message","customerInteraction",e)}summarize(e){return this.send("message","summarize",e)}translate(e){return this.send("message","translate",e)}recommend(e){return this.send("message","recommend",e)}insights(e){return this.send("message","insights",e)}_registerPending(e,t,s,r,a){let p=null;s>0&&(p=setTimeout(()=>{if(this._pending.has(e)){const r=this._pending.get(e);r&&!r._handled&&(this._pending.delete(e),r._handled=!0,a({category:Se.WEBSOCKET,code:"REQUEST_TIMEOUT",message:`Request timed out after ${s}ms`,details:{correlationId:e,action:t},correlationId:e}))}},s)),this._pending.set(e,{resolve:r,reject:a,timer:p,action:t,_handled:!1})}_promiseSend(e,t,s={},r={}){let a,p,i;const o=new Promise((o,n)=>{p=o,i=n;const c="number"==typeof r.timeoutMs?r.timeoutMs:"number"==typeof r.timeout?r.timeout:this.options.requestTimeoutMs;if(!this.wss||this.wss.readyState!==WebSocket.OPEN){if(c<=0)return void n({category:Se.WEBSOCKET,code:"WEBSOCKET_NOT_IN_OPEN_STATE",message:"WebSocket not open",details:null});const r=this.buildPayload(e,t,s),p=this.buildMessageEnvelope(r,e,t,s?.headers||{});return a=p.headers.correlationId,void this._registerPending(a,t,c,o,n)}if(!Ae.has(t))return void n({category:Se.VALIDATION,code:"INVALID_ACTION",message:`Unsupported action '${t}'.`,details:{allowed:[...Ae]}});const u=new Set(["session","request","headers"]);for(const e of Object.keys(s||{}))if(!u.has(e)){const t=[{instancePath:"",keyword:"additionalProperties",params:{additionalProperty:e},message:`must NOT have additional property '${e}'`}];return void n({category:Se.VALIDATION,code:"PAYLOAD_SCHEMA_MISMATCH",message:this.formatValidationErrorMessage(t),details:t})}const d=this.buildPayload(e,t,s),m=this.validateRequiredFields(d,t);if(!m.isValid)return void n({category:Se.VALIDATION,code:"REQUIRED_FIELDS_MISSING",message:`Missing required fields for action '${t}'`,details:m.errors});if(this.options.strictValidation){const e=ge(d);if(!e.valid)return void n({category:Se.VALIDATION,code:"PAYLOAD_SCHEMA_MISMATCH",message:this.formatValidationErrorMessage(e.errors,"Schema validation failed"),details:e.errors})}const y=this.buildMessageEnvelope(d,e,t,s?.headers||{});a=y.headers.correlationId,this._registerPending(a,t,c,o,n);const h=JSON.stringify(y);if(!this.isPayloadSizeValid(h)){const e=h.length,t=this.formatPayloadSizeError(e,Ee.MAX_PAYLOAD_SIZE_KB,y).message;return void n({category:Se.VALIDATION,code:"PAYLOAD_TOO_LARGE",message:t,details:{maxKb:Ee.MAX_PAYLOAD_SIZE_KB}})}try{this.wss.send(h)}catch(e){if(this._pending.has(a)){const e=this._pending.get(a);e.timer&&clearTimeout(e.timer),e._handled=!0,this._pending.delete(a)}n({category:Se.WEBSOCKET,code:"SEND_FAILED",message:"Failed to send over WebSocket",details:e,correlationId:a})}});return o.correlationId=a,o}adjustAsync(e,t){return this._promiseSend("message","adjust",e,t)}elevateAsync(e,t){return this._promiseSend("message","elevate",e,t)}interactionAsync(e,t){return this._promiseSend("message","interaction",e,t)}receptionAsync(e,t){return this._promiseSend("message","reception",e,t)}customerInteractionAsync(e,t){return this.deprecate("method.customerInteractionAsync","[Deprecation] 'customerInteractionAsync' is deprecated; use 'interactionAsync' instead."),this._promiseSend("message","customerInteraction",e,t)}summarizeAsync(e,t){return this._promiseSend("message","summarize",e,t)}translateAsync(e,t){return this._promiseSend("message","translate",e,t)}recommendAsync(e,t){return this._promiseSend("message","recommend",e,t)}insightsAsync(e,t){return this._promiseSend("message","insights",e,t)}cancelRequest(e){if(this._pending.has(e)){const t=this._pending.get(e);return t.timer&&clearTimeout(t.timer),t._handled=!0,this._pending.delete(e),setTimeout(()=>{t.reject({category:Se.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled",details:{correlationId:e},correlationId:e})},0),!0}return!1}cancelPendingRequests(e=!1){if(!this._pending)return 0;const t=this._pending.size,s=[...this._pending.entries()];for(const[t,r]of s)r.timer&&clearTimeout(r.timer),r._handled=!0,e?r.reject({category:Se.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled during cleanup",details:{correlationId:t},correlationId:t}):queueMicrotask(()=>{r.reject({category:Se.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled",details:{correlationId:t},correlationId:t})});return this._pending.clear(),t}cleanup(){if(this.closeConnection(),this.cancelPendingRequests(!0),this._deprecatedKeys&&this._deprecatedKeys.clear(),void 0!==this._warnedQueryToken&&delete this._warnedQueryToken,this._events)for(const e in this._events)delete this._events[e];this.removeAllListeners(),this._events=null,this._eventsCount=null,this._maxListeners=null;this._validatePayload=null,this._validateMessageEnvelope=null,this._emitError=null,this._ensureWebSocketImpl=null,this._handleInbound=null,this._promiseSend=null,this._registerPending=null,this._warnOnce=null,this.options=null,this.WebSocketImpl=null,this.wss=null,this.sessionId=null,this._pending=null,this._deprecatedKeys=null,this._silenceDeprecations=null,this._events=null,this._eventsCount=null,this._maxListeners=null}removeAllListeners(t){try{e.prototype.removeAllListeners.call(this,t)}catch(e){t?this._events&&this._events[t]&&(delete this._events[t],this._eventsCount=Math.max(0,this._eventsCount-1)):(this._events=Object.create(null),this._eventsCount=0)}return this}static get buildFlags(){const e="server-esm";return{SALESFORCE_BUILD:"undefined"!=typeof __SALESFORCE_BUILD__&&__SALESFORCE_BUILD__,INCLUDE_WS_REQUIRE:!0,SDK_VERSION:"3.2.1",WEBPACK_BUILD_TARGET:e,WEBPACK_BUILD_TARGET_NORMALIZED:Te.normalize(e),BUILD_TARGET_INFO:Te.getInfo(e)}}}const We=Me;export{We as default};