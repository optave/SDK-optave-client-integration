class e extends EventTarget{constructor(){super(),this._events={},this._eventsCount=0}on(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push(t),this._eventsCount++;const s=e=>{e.detail&&Array.isArray(e.detail)?t(...e.detail):t(e.detail||e)};return t._wrapped=s,this.addEventListener(e,s),this}off(e,t){if(this._events[e]){const s=this._events[e].indexOf(t);s>-1&&(this._events[e].splice(s,1),this._eventsCount--,0===this._events[e].length&&delete this._events[e])}return t._wrapped&&(this.removeEventListener(e,t._wrapped),delete t._wrapped),this}removeListener(e,t){return this.off(e,t)}emit(e,...t){const s=new CustomEvent(e,{detail:t});return this.dispatchEvent(s),this}once(e,t){const s=(...r)=>{this.off(e,s),t(...r)};return this.on(e,s)}listenerCount(e){return this._events[e]?this._events[e].length:0}removeAllListeners(e){if(e){if(this._events[e]){const t=this._events[e].length;this._events[e].forEach(t=>{t._wrapped&&(this.removeEventListener(e,t._wrapped),delete t._wrapped)}),delete this._events[e],this._eventsCount=Math.max(0,this._eventsCount-t)}}else{Object.values(this._events).reduce((e,t)=>e+t.length,0);Object.keys(this._events).forEach(e=>this.removeAllListeners(e)),this._eventsCount=0}return this}}const t=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;const s=function(e){return"string"==typeof e&&t.test(e)};const r=function(e){if(!s(e))throw TypeError("Invalid UUID");let t;return Uint8Array.of((t=parseInt(e.slice(0,8),16))>>>24,t>>>16&255,t>>>8&255,255&t,(t=parseInt(e.slice(9,13),16))>>>8,255&t,(t=parseInt(e.slice(14,18),16))>>>8,255&t,(t=parseInt(e.slice(19,23),16))>>>8,255&t,(t=parseInt(e.slice(24,36),16))/1099511627776&255,t/4294967296&255,t>>>24&255,t>>>16&255,t>>>8&255,255&t)},n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));function o(e,t=0){return(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase()}let i;const a=new Uint8Array(16);function c(){if(!i){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");i=crypto.getRandomValues.bind(crypto)}return i(a)}function d(e){return 14+(e+64>>>9<<4)+1}function u(e,t){const s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function l(e,t,s,r,n,o){return u((i=u(u(t,e),u(r,o)))<<(a=n)|i>>>32-a,s);var i,a}function p(e,t,s,r,n,o,i){return l(t&s|~t&r,e,t,n,o,i)}function h(e,t,s,r,n,o,i){return l(t&r|s&~r,e,t,n,o,i)}function m(e,t,s,r,n,o,i){return l(t^s^r,e,t,n,o,i)}function f(e,t,s,r,n,o,i){return l(s^(t|~r),e,t,n,o,i)}const g=function(e){return function(e){const t=new Uint8Array(4*e.length);for(let s=0;s<4*e.length;s++)t[s]=e[s>>2]>>>s%4*8&255;return t}(function(e,t){const s=new Uint32Array(d(t)).fill(0);s.set(e),s[t>>5]|=128<<t%32,s[s.length-1]=t,e=s;let r=1732584193,n=-271733879,o=-1732584194,i=271733878;for(let t=0;t<e.length;t+=16){const s=r,a=n,c=o,d=i;r=p(r,n,o,i,e[t],7,-680876936),i=p(i,r,n,o,e[t+1],12,-389564586),o=p(o,i,r,n,e[t+2],17,606105819),n=p(n,o,i,r,e[t+3],22,-1044525330),r=p(r,n,o,i,e[t+4],7,-176418897),i=p(i,r,n,o,e[t+5],12,1200080426),o=p(o,i,r,n,e[t+6],17,-1473231341),n=p(n,o,i,r,e[t+7],22,-45705983),r=p(r,n,o,i,e[t+8],7,1770035416),i=p(i,r,n,o,e[t+9],12,-1958414417),o=p(o,i,r,n,e[t+10],17,-42063),n=p(n,o,i,r,e[t+11],22,-1990404162),r=p(r,n,o,i,e[t+12],7,1804603682),i=p(i,r,n,o,e[t+13],12,-40341101),o=p(o,i,r,n,e[t+14],17,-1502002290),n=p(n,o,i,r,e[t+15],22,1236535329),r=h(r,n,o,i,e[t+1],5,-165796510),i=h(i,r,n,o,e[t+6],9,-1069501632),o=h(o,i,r,n,e[t+11],14,643717713),n=h(n,o,i,r,e[t],20,-373897302),r=h(r,n,o,i,e[t+5],5,-701558691),i=h(i,r,n,o,e[t+10],9,38016083),o=h(o,i,r,n,e[t+15],14,-660478335),n=h(n,o,i,r,e[t+4],20,-405537848),r=h(r,n,o,i,e[t+9],5,568446438),i=h(i,r,n,o,e[t+14],9,-1019803690),o=h(o,i,r,n,e[t+3],14,-187363961),n=h(n,o,i,r,e[t+8],20,1163531501),r=h(r,n,o,i,e[t+13],5,-1444681467),i=h(i,r,n,o,e[t+2],9,-51403784),o=h(o,i,r,n,e[t+7],14,1735328473),n=h(n,o,i,r,e[t+12],20,-1926607734),r=m(r,n,o,i,e[t+5],4,-378558),i=m(i,r,n,o,e[t+8],11,-2022574463),o=m(o,i,r,n,e[t+11],16,1839030562),n=m(n,o,i,r,e[t+14],23,-35309556),r=m(r,n,o,i,e[t+1],4,-1530992060),i=m(i,r,n,o,e[t+4],11,1272893353),o=m(o,i,r,n,e[t+7],16,-155497632),n=m(n,o,i,r,e[t+10],23,-1094730640),r=m(r,n,o,i,e[t+13],4,681279174),i=m(i,r,n,o,e[t],11,-358537222),o=m(o,i,r,n,e[t+3],16,-722521979),n=m(n,o,i,r,e[t+6],23,76029189),r=m(r,n,o,i,e[t+9],4,-640364487),i=m(i,r,n,o,e[t+12],11,-421815835),o=m(o,i,r,n,e[t+15],16,530742520),n=m(n,o,i,r,e[t+2],23,-995338651),r=f(r,n,o,i,e[t],6,-198630844),i=f(i,r,n,o,e[t+7],10,1126891415),o=f(o,i,r,n,e[t+14],15,-1416354905),n=f(n,o,i,r,e[t+5],21,-57434055),r=f(r,n,o,i,e[t+12],6,1700485571),i=f(i,r,n,o,e[t+3],10,-1894986606),o=f(o,i,r,n,e[t+10],15,-1051523),n=f(n,o,i,r,e[t+1],21,-2054922799),r=f(r,n,o,i,e[t+8],6,1873313359),i=f(i,r,n,o,e[t+15],10,-30611744),o=f(o,i,r,n,e[t+6],15,-1560198380),n=f(n,o,i,r,e[t+13],21,1309151649),r=f(r,n,o,i,e[t+4],6,-145523070),i=f(i,r,n,o,e[t+11],10,-1120210379),o=f(o,i,r,n,e[t+2],15,718787259),n=f(n,o,i,r,e[t+9],21,-343485551),r=u(r,s),n=u(n,a),o=u(o,c),i=u(i,d)}return Uint32Array.of(r,n,o,i)}(function(e){if(0===e.length)return new Uint32Array;const t=new Uint32Array(d(8*e.length)).fill(0);for(let s=0;s<e.length;s++)t[s>>2]|=(255&e[s])<<s%4*8;return t}(e),8*e.length))};const y="6ba7b810-9dad-11d1-80b4-00c04fd430c8",E="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function S(e,t,s,n,i,a){const c="string"==typeof s?function(e){e=unescape(encodeURIComponent(e));const t=new Uint8Array(e.length);for(let s=0;s<e.length;++s)t[s]=e.charCodeAt(s);return t}(s):s,d="string"==typeof n?r(n):n;if("string"==typeof n&&(n=r(n)),16!==n?.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let u=new Uint8Array(16+c.length);if(u.set(d),u.set(c,d.length),u=t(u),u[6]=15&u[6]|e,u[8]=63&u[8]|128,i){a=a||0;for(let e=0;e<16;++e)i[a+e]=u[e];return i}return o(u)}function v(e,t,s,r){return S(48,g,e,t,s,r)}v.DNS=y,v.URL=E;"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);function _(e,t,s,r){switch(e){case 0:return t&s^~t&r;case 1:case 3:return t^s^r;case 2:return t&s^t&r^s&r}}function b(e,t){return e<<t|e>>>32-t}const I=function(e){const t=[1518500249,1859775393,2400959708,3395469782],s=[1732584193,4023233417,2562383102,271733878,3285377520],r=new Uint8Array(e.length+1);r.set(e),r[e.length]=128;const n=(e=r).length/4+2,o=Math.ceil(n/16),i=new Array(o);for(let t=0;t<o;++t){const s=new Uint32Array(16);for(let r=0;r<16;++r)s[r]=e[64*t+4*r]<<24|e[64*t+4*r+1]<<16|e[64*t+4*r+2]<<8|e[64*t+4*r+3];i[t]=s}i[o-1][14]=8*(e.length-1)/Math.pow(2,32),i[o-1][14]=Math.floor(i[o-1][14]),i[o-1][15]=8*(e.length-1)&4294967295;for(let e=0;e<o;++e){const r=new Uint32Array(80);for(let t=0;t<16;++t)r[t]=i[e][t];for(let e=16;e<80;++e)r[e]=b(r[e-3]^r[e-8]^r[e-14]^r[e-16],1);let n=s[0],o=s[1],a=s[2],c=s[3],d=s[4];for(let e=0;e<80;++e){const s=Math.floor(e/20),i=b(n,5)+_(s,o,a,c)+d+t[s]+r[e]>>>0;d=c,c=a,a=b(o,30)>>>0,o=n,n=i}s[0]=s[0]+n>>>0,s[1]=s[1]+o>>>0,s[2]=s[2]+a>>>0,s[3]=s[3]+c>>>0,s[4]=s[4]+d>>>0}return Uint8Array.of(s[0]>>24,s[0]>>16,s[0]>>8,s[0],s[1]>>24,s[1]>>16,s[1]>>8,s[1],s[2]>>24,s[2]>>16,s[2]>>8,s[2],s[3]>>24,s[3]>>16,s[3]>>8,s[3],s[4]>>24,s[4]>>16,s[4]>>8,s[4])};function w(e,t,s,r){return S(80,I,e,t,s,r)}w.DNS=y,w.URL=E;const A={};function O(e,t,s,r,n=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(r){if(n<0||n+16>r.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`)}else r=new Uint8Array(16),n=0;return t??=Date.now(),s??=127*e[6]<<24|e[7]<<16|e[8]<<8|e[9],r[n++]=t/1099511627776&255,r[n++]=t/4294967296&255,r[n++]=t/16777216&255,r[n++]=t/65536&255,r[n++]=t/256&255,r[n++]=255&t,r[n++]=112|s>>>28&15,r[n++]=s>>>20&255,r[n++]=128|s>>>14&63,r[n++]=s>>>6&255,r[n++]=s<<2&255|3&e[10],r[n++]=e[11],r[n++]=e[12],r[n++]=e[13],r[n++]=e[14],r[n++]=e[15],r}const T=function(e,t,s){let r;if(e)r=O(e.random??e.rng?.()??c(),e.msecs,e.seq,t,s);else{const e=Date.now(),n=c();!function(e,t,s){e.msecs??=-1/0,e.seq??=0,t>e.msecs?(e.seq=s[6]<<23|s[7]<<16|s[8]<<8|s[9],e.msecs=t):(e.seq=e.seq+1|0,0===e.seq&&e.msecs++)}(A,e,n),r=O(n,A.msecs,A.seq,t,s)}return t??o(r)};function R(e,t,s="validation",r={}){return{instancePath:e,message:t,keyword:s,params:r}}function k(e){if(!e||"object"!=typeof e)return{valid:!1,errors:[R("","must be object","type",{type:"object"})]};const t=[];return e.session?"object"!=typeof e.session?t.push(R("/session","must be object","type",{type:"object"})):void 0!==e.session.sessionId&&"string"!=typeof e.session.sessionId&&t.push(R("/session/sessionId","must be string","type",{type:"string"})):t.push(R("/session","is required","required",{missingProperty:"session"})),e.request?"object"!=typeof e.request?t.push(R("/request","must be object","type",{type:"object"})):(e.request.connections?"object"!=typeof e.request.connections?t.push(R("/request/connections","must be object","type",{type:"object"})):(e.request.connections.threadId?"string"!=typeof e.request.connections.threadId&&t.push(R("/request/connections/threadId","must be string","type",{type:"string"})):t.push(R("/request/connections/threadId","is required","required",{missingProperty:"threadId"})),void 0!==e.request.connections.parentId&&"string"!=typeof e.request.connections.parentId&&t.push(R("/request/connections/parentId","must be string","type",{type:"string"}))):t.push(R("/request/connections","is required","required",{missingProperty:"connections"})),void 0!==e.request.context&&"object"!=typeof e.request.context&&t.push(R("/request/context","must be object","type",{type:"object"})),void 0!==e.request.attributes&&"object"!=typeof e.request.attributes&&t.push(R("/request/attributes","must be object","type",{type:"object"})),void 0!==e.request.scope&&("object"!=typeof e.request.scope?t.push(R("/request/scope","must be object","type",{type:"object"})):void 0!==e.request.scope.conversations&&(Array.isArray(e.request.scope.conversations)||t.push(R("/request/scope/conversations","must be array","type",{type:"array"})))),void 0!==e.request.resources&&("object"!=typeof e.request.resources?t.push(R("/request/resources","must be object","type",{type:"object"})):void 0!==e.request.resources.offers&&(Array.isArray(e.request.resources.offers)||t.push(R("/request/resources/offers","must be array","type",{type:"array"}))))):t.push(R("/request","is required","required",{missingProperty:"request"})),t.length>0?{valid:!1,errors:t}:{valid:!0,errors:null}}function q(e){if(!e||"object"!=typeof e)return{valid:!1,errors:[R("","must be object","type",{type:"object"})]};const t=[];if(e.headers)if("object"!=typeof e.headers)t.push(R("/headers","must be object","type",{type:"object"}));else{if(e.headers.correlationId?"string"!=typeof e.headers.correlationId&&t.push(R("/headers/correlationId","must be string","type",{type:"string"})):t.push(R("/headers/correlationId","is required","required",{missingProperty:"correlationId"})),e.headers.action)if("string"!=typeof e.headers.action)t.push(R("/headers/action","must be string","type",{type:"string"}));else{const s=["adjust","elevate","interaction","customerinteraction","reception","summarize","translate","recommend","insights"];s.includes(e.headers.action)||t.push(R("/headers/action","must be equal to one of the allowed values","enum",{allowedValues:s}))}else t.push(R("/headers/action","is required","required",{missingProperty:"action"}));void 0!==e.headers.identifier&&"string"!=typeof e.headers.identifier&&t.push(R("/headers/identifier","must be string","type",{type:"string"})),void 0!==e.headers.schemaRef&&"string"!=typeof e.headers.schemaRef&&t.push(R("/headers/schemaRef","must be string","type",{type:"string"})),void 0!==e.headers.timestamp&&"string"!=typeof e.headers.timestamp&&t.push(R("/headers/timestamp","must be string","type",{type:"string"}))}else t.push(R("/headers","is required","required",{missingProperty:"headers"}));if(e.payload){if("object"!=typeof e.payload)t.push(R("/payload","must be object","type",{type:"object"}));else if(e.headers&&e.headers.action&&e.payload){const s=e.headers.action;["adjust","elevate","interaction","customerinteraction","customerInteraction","summarize","translate","insights","recommend"].includes(s)&&(e.payload.request?e.payload.request.scope?e.payload.request.scope.conversations?Array.isArray(e.payload.request.scope.conversations)?0===e.payload.request.scope.conversations.length&&t.push(R("/payload/request/scope/conversations",`must be non-empty array for ${s}`,"minItems",{limit:1})):t.push(R("/payload/request/scope/conversations","must be array","type",{type:"array"})):t.push(R("/payload/request/scope/conversations",`is required for ${s}`,"required",{missingProperty:"conversations"})):t.push(R("/payload/request/scope","is required","required",{missingProperty:"scope"})):t.push(R("/payload/request","is required","required",{missingProperty:"request"})))}}else t.push(R("/payload","is required","required",{missingProperty:"payload"}));return t.length>0?{valid:!1,errors:t}:{valid:!0,errors:null}}const C="3.2.1",N=`optave.message.v${C.split(".")[0]}`,U={AUTHENTICATION:"AUTHENTICATION",ORCHESTRATOR:"ORCHESTRATOR",VALIDATION:"VALIDATION",WEBSOCKET:"WEBSOCKET"},P=Object.freeze({MESSAGE:"message",ERROR:"error"}),W=Object.freeze({CONNECTION_OPEN:"connection:open",CONNECTION_CLOSE:"connection:close",CONNECTION_ERROR:"connection:error",MESSAGE_RECEIVED:"message:received",MESSAGE_SENT:"message:sent",ERROR:"error",RESPONSE:"response",LEGACY_ERROR:"error",LEGACY_MESSAGE:"message"}),D=Object.freeze({SUPERPOWER_RESPONSE:"superpower.response",SUPERPOWER_ERROR:"superpower.error"}),M=new Set(["adjust","elevate","interaction","reception","customerInteraction","summarize","translate","recommend","insights"]),L={SPEC_VERSION:C,SCHEMA_REF:N,MAX_PAYLOAD_SIZE:131072,MAX_PAYLOAD_SIZE_KB:128,DEFAULT_REQUEST_TIMEOUT_MS:3e4,ErrorCategory:U,LegacyEvents:P,EVENTS:W,InboundEvents:D,ALLOWED_ACTIONS:M};function j(e){const t=[];if((()=>{if("undefined"!=typeof process&&process.versions,"undefined"!=typeof global){if("window"in global||"document"in global||"undefined"!=typeof process&&process.versions,(!("window"in global)||!("document"in global))&&"undefined"!=typeof process&&process.versions,"window"in global&&global.window)return!0;if("document"in global&&global.document)return!0}try{if("undefined"!=typeof window&&null!==window)return("undefined"==typeof global||"window"in global)&&("undefined"!=typeof global&&"undefined"!=typeof process&&process.versions,!0);if("undefined"!=typeof document&&null!==document)return("undefined"==typeof global||"document"in global)&&("undefined"!=typeof global&&"undefined"!=typeof process&&process.versions,!0)}catch(e){}return"undefined"!=typeof navigator&&"ReactNative"===navigator.product||!("undefined"==typeof global||!global.__expo)||"undefined"!=typeof location&&null!==location||("undefined"!=typeof process&&process.versions,!1)})()&&e.clientSecret){let e=!1,s=!1;try{e=!0===__SALESFORCE_BUILD__}catch(e){}try{s=!1}catch(e){}e||s||t.push({type:"error",code:"CLIENT_SECRET_IN_CLIENT_ENV",message:"clientSecret must not be supplied in a client environment (browser, mobile, Electron renderer). Use options.tokenProvider() to obtain a short-lived token.",field:"clientSecret"})}return t}const V={BROWSER_ESM:"browser-esm",SERVER_ESM:"server-esm",BROWSER_UMD:"browser-umd",SERVER_UMD:"server-umd"},$={browser:V.BROWSER_ESM,server:V.SERVER_ESM},B={BROWSER:[V.BROWSER_ESM,V.BROWSER_UMD,V.SERVER_UMD],SERVER:[V.SERVER_ESM],UMD:[V.BROWSER_UMD,V.SERVER_UMD],ESM:[V.BROWSER_ESM,V.SERVER_ESM]},K={isValid:e=>Object.values(V).includes(e)||Object.keys($).includes(e),normalize:e=>$[e]?$[e]:Object.values(V).includes(e)?e:"unknown",isBrowser(e){const t=this.normalize(e);return B.BROWSER.includes(t)},isServer(e){const t=this.normalize(e);return B.SERVER.includes(t)},isUMD(e){const t=this.normalize(e);return B.UMD.includes(t)},isESM(e){const t=this.normalize(e);return B.ESM.includes(t)},getInfo(e){return{original:e,normalized:this.normalize(e),valid:this.isValid(e),isBrowser:this.isBrowser(e),isServer:this.isServer(e),isUMD:this.isUMD(e),isESM:this.isESM(e)}}};class z extends Error{constructor({category:e,code:t,message:s,details:r}){super(s),this.name="OptaveError",this.category=e||"UNKNOWN",this.code=t||"UNKNOWN",void 0!==r&&(this.details=r)}}!function(){if("undefined"!=typeof globalThis){globalThis.__OPTAVE_SECURITY_GUARDS_ACTIVE__=!0;if(!globalThis.__OPTAVE_SECURITY_GUARDS_ACTIVE__)throw new Error("Security guard initialization failed")}"undefined"!=typeof process&&process.env}(),"undefined"!=typeof window?window.__OPTAVE_SECURITY_GUARDS_BROWSER__=!0:"undefined"!=typeof global&&(global.__OPTAVE_SECURITY_GUARDS_NODE__=!0);const H="3.2.1",F=()=>{const e="browser-esm";return{isBrowser:K.isBrowser(e),isServer:K.isServer(e),buildTarget:e}};let x=!1,G=!1;class Y extends e{options={};wss=null;static defaultPayload={session:{sessionId:"",channel:{browser:"",deviceInfo:"",deviceType:"",language:"",location:"",medium:"chat",metadata:[],section:""},interface:{appVersion:"",category:"",language:"",name:"",type:""}},request:{requestId:"",attributes:{content:"",instruction:"",variant:"A"},connections:{journeyId:"",parentId:"",threadId:""},context:{caseId:"",departmentId:"",operatorId:"",organizationId:"",userId:""},reference:{ids:[{name:"",value:""}],labels:[],tags:[]},resources:{codes:[{id:"",label:"",type:"",value:""}],links:[{expires_at:"",html:!1,id:"",label:"",type:"",url:""}],offers:[]},scope:{accounts:[],appointments:[],assets:[],bookings:[],cases:[],conversations:[],documents:[],events:[],interactions:[],items:[],locations:[],operators:[],orders:[],organizations:[],persons:[],policies:[],products:[{id:""}],properties:[],services:[],subscriptions:[],tickets:[],transactions:[],users:[]},settings:{disableBrowsing:!1,disableSearch:!1,disableSources:!1,disableStream:!0,disableTools:!1,maxResponseLength:0,overrideInterfaceLanguage:"",overrideOutputLanguage:""},a2a:[{id:"",name:"",type:""}],cursor:{since:"",until:""}}};static cleanup(){x=!1,G=!1}constructor(e){if(super(),this.options={...e},function(e){if(void 0===e.strictValidation){const t="undefined"!=typeof process&&process.env?"production":"development";e.strictValidation="production"!==t}if("number"!=typeof e.requestTimeoutMs&&(e.requestTimeoutMs=3e4),"number"!=typeof e.connectionTimeoutMs&&(e.connectionTimeoutMs=1e4),e.logger||(e.logger={debug(){},info(){},warn(){},error(){}}),e.authTransport||(e.authTransport="subprotocol"),void 0===e.authRequired&&(e.authRequired=!0),!e.tokenProvider){let t=e.tokenUrl;if(!t&&"undefined"!=typeof document){const e=document.querySelector('meta[name="optave-token-url"]');e&&e.content&&(t=e.content)}t||(t="/api/optave/ws-ticket"),e.tokenProvider=async()=>{const s={};e.publishableKey&&(s["X-Optave-Publishable-Key"]=e.publishableKey);const r=await fetch(t,{method:"POST",credentials:"include",headers:s});if(!r.ok)throw new Error("Failed to obtain WS token");const n=await r.json();return n.token||n.access_token}}}(this.options),void 0===this.options.cspSafe){const e=F();"server-esm"===e.buildTarget||"server"===e.buildTarget?this.options.cspSafe=!1:("server-umd"===e.buildTarget||"browser-esm"===e.buildTarget||"browser-umd"===e.buildTarget||e.isBrowser||(()=>{const e=F();return"unknown"!==e.buildTarget?e.isBrowser:"undefined"!=typeof window&&void 0!==window.WebSocket})())&&(this.options.cspSafe=!0)}const t=function(e){const t={isValid:!0,errors:[],warnings:[]},s=function(e){const t=[];return e.websocketUrl&&"string"==typeof e.websocketUrl||t.push({type:"warning",code:"MISSING_WEBSOCKET_URL",message:"websocketUrl not provided; openConnection() will emit an error.",field:"websocketUrl"}),t}(e),r=function(e){const t=[];return!e.authenticationUrl||e.clientId&&e.clientSecret||t.push({type:"warning",code:"INCOMPLETE_AUTH_CONFIG",message:"authenticationUrl provided but clientId/clientSecret incomplete; authenticate() may fail.",field:"authentication"}),t}(e),n=[...s,...r,...j(e)];for(const e of n)"error"===e.type?(t.errors.push(e),t.isValid=!1):"warning"===e.type&&t.warnings.push(e);return t}(this.options);if(!t.isValid){const e=t.errors.map(e=>e.message).join("; ");throw new Error(`[Optave SDK] Configuration errors: ${e}`)}t.warnings.forEach(e=>{(this.options?.logger?.warn||console.warn)(`[Optave SDK] ${e.message}`)});try{!function(e,t,s={}){if(!e||"string"!=typeof e)return;const r=K.normalize(t),n=K.isUMD(r),o=K.isBrowser(r);if((n||o)&&e.startsWith("ws://"))throw new Error(`[Optave SDK] Insecure WebSocket protocol (ws://) is not allowed in UMD builds. Salesforce Lightning Locker Service blocks all ws:// connections for security reasons. Please use secure WebSocket protocol (wss://) instead. Current URL: ${e}`);if(n&&e.startsWith("wss://")){const t="function"==typeof s.tokenProvider,r=!1===s.authRequired;if(!t&&!r)throw new Error(`[Optave SDK] UMD builds require a tokenProvider function for secure WebSocket connections. In constrained environments like Salesforce Lightning, authentication tokens must be obtained from your backend server. Please provide options.tokenProvider() that returns a valid token, or set options.authRequired = false to disable authentication. Current URL: ${e}`)}}(this.options.websocketUrl,"browser-esm",this.options)}catch(e){throw e}const s=F();this.WebSocketImpl=this.options.WebSocketImpl,!this.WebSocketImpl&&s.isBrowser?this.WebSocketImpl=("undefined"!=typeof WebSocket?WebSocket:void 0)||("undefined"!=typeof window&&window.WebSocket?window.WebSocket:void 0):!this.WebSocketImpl&&s.isServer&&(this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:void 0),this._pending=new Map,this._deprecatedKeys=new Set,this._silenceDeprecations="undefined"!=typeof process&&"1"===process?.env?.OPTAVE_SDK_SILENCE_DEPRECATIONS,this.options.cspSafe,this._validatePayload=k,this._validateMessageEnvelope=q}async _ensureWebSocketImpl(){if(this.WebSocketImpl)return this.WebSocketImpl;const e=F();return this.WebSocketImpl=this.options.WebSocketImpl,!this.WebSocketImpl&&e.isBrowser?this.WebSocketImpl=("undefined"!=typeof WebSocket?WebSocket:void 0)||("undefined"!=typeof window&&window.WebSocket?window.WebSocket:void 0):!this.WebSocketImpl&&e.isServer&&(this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:void 0),this.WebSocketImpl||(e.isBrowser?this.WebSocketImpl="undefined"!=typeof WebSocket?WebSocket:null:e.isServer&&(this.WebSocketImpl=await this.loadNodeWebSocket())),this.WebSocketImpl}async loadNodeWebSocket(){const e=F();return e.isBrowser?null:"unknown"!==e.buildTarget||"undefined"==typeof window&&"undefined"==typeof document&&"undefined"==typeof navigator&&"undefined"==typeof location?("undefined"==typeof process||process.versions,null):null}static getSdkVersion(){return H}static getSpecVersion(){return C}static getSchemaRef(){return N}static get CONSTANTS(){return L}static get LegacyEvents(){return P}static get InboundEvents(){return D}setSessionId(e){return this.sessionId=e,this}getSessionId(){return this.sessionId||""}validate(e){return this._validatePayload(e).valid}validateEnvelope(e){return this._validateMessageEnvelope(e).valid}validateRequiredFields(e,t){const s=[];switch(e.request?.connections?.threadId||s.push("request.connections.threadId is required"),t){case"adjust":e.request?.attributes?.content||s.push("request.attributes.content is required for adjust"),e.request?.attributes?.instruction||s.push("request.attributes.instruction is required for adjust"),e.request?.connections?.parentId||s.push("request.connections.parentId is required for adjust"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for adjust and must be a non-empty array");break;case"elevate":e.request?.attributes?.content||s.push("request.attributes.content is required for elevate"),e.request?.connections?.parentId||s.push("request.connections.parentId is required for elevate"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for elevate and must be a non-empty array");break;case"translate":case"summarize":case"insights":case"customerinteraction":case"customerInteraction":case"interaction":e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push(`request.scope.conversations is required for ${t} and must be a non-empty array`);break;case"recommend":e.request?.resources?.offers&&Array.isArray(e.request.resources.offers)&&0!==e.request.resources.offers.length||s.push("request.resources.offers is required for recommend and must be a non-empty array"),e.request?.scope?.conversations&&Array.isArray(e.request.scope.conversations)&&0!==e.request.scope.conversations.length||s.push("request.scope.conversations is required for recommend and must be a non-empty array")}return{isValid:0===s.length,errors:s}}async authenticate(){if(K.isBrowser("browser-esm"))return this.handleError(U.AUTHENTICATION,"UNSUPPORTED_IN_BROWSER","authenticate() is not available in browsers. Use options.tokenProvider() to obtain a short-lived WebSocket token from your backend."),null;let e={grant_type:"client_credentials"};if(!this.options.authenticationUrl)return this.handleError(U.AUTHENTICATION,"INVALID_AUTHENTICATION_URL","Empty or invalid authentication URL"),null;if(!this.options.clientId)return this.handleError(U.AUTHENTICATION,"INVALID_CLIENT_ID","Empty or invalid client ID"),null;e.client_id=this.options.clientId,e.client_secret=this.options.clientSecret;const t=new URLSearchParams(e).toString();let s=this.options.authenticationUrl;s.endsWith("/token")||(s=s.endsWith("/")?s+"token":s+"/token");const r=`${s}?${t}`,n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"}}),o=await n.json();return n.ok?o.access_token:(this.handleError(U.AUTHENTICATION,"INVALID_AUTHENTICATION_RESPONSE",this.formatAuthenticationError(n,o.error,"token endpoint").message,o.error),null)}async openConnection(e){if(!this.options.websocketUrl)return(this.options?.logger?.error||console.error)("[Optave SDK] openConnection aborted: missing websocketUrl"),void this.handleError(U.WEBSOCKET,"INVALID_WEBSOCKET_URL",this.formatWebSocketError(new Error("Invalid WebSocket URL configuration"),{url:this.options.websocketUrl}).message,this.options.websocketUrl);const t=await(async()=>{if("string"==typeof e&&e.length>0)return e;if("function"==typeof this.options.tokenProvider)try{return await this.options.tokenProvider()}catch(e){return this.handleError(U.AUTHENTICATION,"TOKEN_PROVIDER_FAILED",this.formatTokenProviderError(e).message,e),null}return null})();if(await this._ensureWebSocketImpl(),!this.WebSocketImpl)return void this.handleError(U.WEBSOCKET,"NO_WEBSOCKET_IMPL",this.formatWebSocketError(new Error("No WebSocket implementation available"),{environment:"undefined"!=typeof window?"browser":"node"}).message);if(!t&&!1!==this.options.authRequired)return void this.handleError(U.AUTHENTICATION,"MISSING_TOKEN","No WebSocket token available. Provide options.tokenProvider() or set options.tokenUrl.");const s=new URLSearchParams;this.sessionId&&s.set("OptaveTraceChatSessionId",this.sessionId);try{if("subprotocol"===this.options.authTransport){const e=t?["optave-v1",t]:["optave-v1"];this.wss=new this.WebSocketImpl(s.toString()?`${this.options.websocketUrl}?${s.toString()}`:this.options.websocketUrl,e)}else{if(t){const e=t.replace(/^Bearer\s+/i,"");s.set("Authorization",e)}this.wss=new this.WebSocketImpl(s.toString()?`${this.options.websocketUrl}?${s.toString()}`:this.options.websocketUrl),t&&this._warnOnce("_warnedQueryToken",'[Optave SDK] Passing auth token in WebSocket URL query is discouraged. Prefer authTransport="subprotocol".')}}catch(e){return(this.options?.logger?.error||console.error)("[Optave SDK] WebSocket constructor threw",e),void this.handleError(U.WEBSOCKET,"WEBSOCKET_ERROR",this.formatWebSocketError(e,{url:this.options.websocketUrl}).message,e)}return new Promise((e,t)=>{const s=setTimeout(()=>{const e=this.options.connectionTimeoutMs||3e4,s=this.formatWebSocketError(new Error("Connection timeout"),{timeout:e,url:this.options.websocketUrl}).message;this.handleError(U.WEBSOCKET,"CONNECTION_TIMEOUT",s),t({category:U.WEBSOCKET,code:"CONNECTION_TIMEOUT",message:s,details:null})},this.options.connectionTimeoutMs||3e4);this.wss.onopen=t=>{clearTimeout(s),this.emit("open",t),e(t)},this.wss.onmessage=e=>{this._handleInbound(e.data)},this.wss.onclose=e=>{clearTimeout(s),this.emit("close",e);for(const[t,s]of this._pending.entries())s.timer&&clearTimeout(s.timer),s._handled=!0,s.reject({category:U.WEBSOCKET,code:"CONNECTION_CLOSED",message:`WebSocket connection closed: ${e.reason||"Connection lost"}`,details:{code:e.code,reason:e.reason,correlationId:t},correlationId:t});this._pending.clear(),this.wss=null},this.wss.onerror=e=>{clearTimeout(s);const r=e.message||(e instanceof Error?e.message:null)||"object"==typeof e&&e.error&&e.error.message||"WebSocket connection failed",n={category:U.WEBSOCKET,code:"CONNECTION_ERROR",message:r,details:{originalError:e}};for(const[e,t]of this._pending.entries())t.timer&&clearTimeout(t.timer),t._handled=!0,t.reject({...n,details:{...n.details,correlationId:e},correlationId:e});this._pending.clear(),this.emit("error",n),t(n)}})}_warnOnce(e,t){this[e]||(this[e]=!0,(this.options?.logger?.warn||console.warn)(t))}deprecate(e,t){this._silenceDeprecations||this._deprecatedKeys.has(e)||(this._deprecatedKeys.add(e),(this.options?.logger?.warn||console.warn)(t))}_handleInbound(e){let t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){const t={category:U.WEBSOCKET,code:"INVALID_JSON",message:"Invalid JSON received from server",details:e,timestamp:(new Date).toISOString()};return void this._emitError(t)}const s=t&&t.headers&&t.payload,r="error"===t?.state||"error"===t?.actionType||!!t?.error;if(this.options.strictValidation&&s){const e=this._validateMessageEnvelope(t);e.valid||this.handleError(U.VALIDATION,"INBOUND_ENVELOPE_SCHEMA_MISMATCH",this.formatValidationErrorMessage(e.errors,"Inbound envelope validation failed"),e.errors)}if(r){const e=t?.headers&&t.headers.correlationId||t?.correlationId||null,s={category:U.ORCHESTRATOR,code:t?.error?.code||"REMOTE_ERROR",message:t?.error?.message||t?.message||"Remote error",details:t?.error||t,correlationId:e};if(e&&this._pending.has(e)){const t=this._pending.get(e);t.timer&&clearTimeout(t.timer),t._handled=!0,this._pending.delete(e),t.reject(s)}return void this._emitError(s,t?.action)}const n=t?.headers?.correlationId||t?.correlationId;if(n&&this._pending.has(n)){const e=this._pending.get(n);e.timer&&clearTimeout(e.timer),e._handled=!0,this._pending.delete(n),e.resolve(t)}this.emit(P.MESSAGE,t),x||(x=!0,(this.options?.logger?.warn||console.warn)('[optave-sdk][deprecation] The "message" event will be deprecated. Please also listen to "superpower.response".')),this.emit(D.SUPERPOWER_RESPONSE,t),this.emit(W.RESPONSE,t),t?.action&&this.emit(`message.${t.action}`.toLowerCase(),t),s&&t.headers.schemaRef&&this.emit(t.headers.schemaRef,t)}_emitError(e,t=null){e.timestamp||(e.timestamp=(new Date).toISOString()),this.emit(P.ERROR,e),G||(G=!0,(this.options?.logger?.warn||console.warn)('[optave-sdk][deprecation] The "error" (string payload) is deprecated. Please also listen to "superpower.error" for a structured error object.'));const s=(r=e)&&r.category&&r.code&&r.message?new z(r):"string"==typeof r?new z({category:"UNKNOWN",code:"STRING_ERROR",message:r}):r&&r.isAuthError?new z({category:"AUTHENTICATION",code:r.code||"AUTH_ERROR",message:r.message||"Authentication error",details:r}):r&&r.isWsError?new z({category:"WEBSOCKET",code:r.code||"WS_ERROR",message:r.message||"WebSocket error",details:r}):new z({category:"UNKNOWN",code:"UNCLASSIFIED",message:r&&r.message||String(null!=r?r:"Unknown error"),details:r});var r;this.emit(D.SUPERPOWER_ERROR,s),this.emit(W.ERROR,e)}closeConnection(){this.wss&&(this.wss.onopen=null,this.wss.onmessage=null,this.wss.onclose=null,this.wss.onerror=null,this.wss.close(),this.wss=null)}selectiveDeepMerge(e,t){if(Array.isArray(e)&&Array.isArray(t))return[...t];const s=e=>null!==e&&"object"==typeof e&&!Array.isArray(e);if(s(e)&&s(t)){const s={...e};for(let r in t)s[r]=r in e?this.selectiveDeepMerge(e[r],t[r]):t[r];return s}return void 0!==t?t:e}isPayloadSizeValid(e){return!!e&&e.length/1024<=L.MAX_PAYLOAD_SIZE_KB}openConnectionAsync(e){return new Promise((t,s)=>{const r=e=>{this.off("error",n),t(e)},n=e=>{this.off("open",r),s(e)};this.once("open",r),this.once("error",n),this.openConnection(e)})}buildPayload(e,t,s){let r=this.selectiveDeepMerge(Y.defaultPayload,s);return s?.request?.variation&&(this.deprecate("payload.request.variation","[Deprecation] 'request.variation' is deprecated; use 'request.attributes.variant'."),r.request.attributes.variant=s.request.variation),s?.request?.content&&!r.request?.attributes?.content&&(r.request.attributes.content=s.request.content,this.deprecate("payload.request.content","[Deprecation] 'request.content' is deprecated; use 'request.attributes.content'.")),r.request.attributes.variant&&(r.request.attributes.variant=r.request.attributes.variant.toUpperCase()),r}resolveMessageId(e,t){return`${t}.${e}.v3`.toLowerCase()}buildMessageEnvelope(e,t,s,r={}){const n=(new Date).toISOString(),o=r.correlationId||e?.request?.requestId||T(),i=r.traceId||T(),a=r.idempotencyKey||T(),c=r.timestamp,d={correlationId:o,action:s,schemaRef:N,sdkVersion:H,identifier:t,traceId:i,idempotencyKey:a,timestamp:c,issuedAt:n};return this.options.tenantId&&(d.tenantId=this.options.tenantId),void 0!==r.networkLatencyMs&&(d.networkLatencyMs=r.networkLatencyMs),Object.freeze(d),{action:"message",headers:d,payload:e}}formatValidationErrorMessage(e,t="Validation failed"){if(!e||!Array.isArray(e)||0===e.length)return t;if(1===e.length){const s=e[0],r=s.instancePath||"/",n="/"===r?"root object":r.replace(/^\//,"").replace(/\//g,".");if("required"===s.keyword){const e=s.params?.missingProperty||"unknown field",r="root object"===n?e:n.endsWith(e)?n:n+"."+e;return`${t}: ${"root object"===n?"Required field":"Field"} '${r}' is missing`}if("type"===s.keyword){return`${t}: Field '${n}' must be of type '${s.params?.type||"unknown"}'`}if("additionalProperties"===s.keyword){return`${t}: Field '${n}.${s.params?.additionalProperty||"unknown"}' is not allowed`}if("enum"===s.keyword){const e=s.params?.allowedValues||[];return`${t}: Field '${n}' must be one of: ${Array.isArray(e)?e.join(", "):"unknown values"}`}return`${t}: ${s.message} at '${n}'`}const s=e.filter(e=>"required"===e.keyword),r=e.filter(e=>"type"===e.keyword),n=e.filter(e=>"required"!==e.keyword&&"type"!==e.keyword);let o=t+":";if(s.length>0){o+=` Missing required fields: ${s.map(e=>{const t=(e.instancePath||"/").replace(/^\//,"").replace(/\//g,"."),s=e.params?.missingProperty||"unknown";return""===t?s:`${t}.${s}`}).join(", ")}.`}if(r.length>0){o+=` Type errors in: ${r.slice(0,3).map(e=>`${(e.instancePath||"/").replace(/^\//,"").replace(/\//g,".")||"root"} (expected ${e.params?.type||"unknown"})`).join(", ")}.`,r.length>3&&(o+=` And ${r.length-3} more type errors.`)}return n.length>0&&(o+=` Additional validation errors: ${n.length}.`),o}formatAuthenticationError(e,t,s){let r="Authentication failed";const n=[];return e&&e.status&&(r+=` (HTTP ${e.status})`),t&&("string"==typeof t?r+=`: ${t}`:t.error_description?r+=`: ${t.error_description}`:t.message?r+=`: ${t.message}`:t.error&&(r+=`: ${t.error}`)),e&&401===e.status?(n.push("Verify clientId and clientSecret are correct"),n.push("Ensure credentials match the target environment (dev/staging/production)")):e&&403===e.status?(n.push("Check if your client has the necessary permissions"),n.push("Verify the authentication endpoint URL is correct")):e&&e.status>=500?(n.push("Authentication server error - try again later"),n.push("Contact support if the problem persists")):n.push("Check network connectivity and authentication endpoint configuration"),s&&s.authUrl&&(r+=` (endpoint: ${s.authUrl})`),{message:r,suggestions:n}}formatWebSocketError(e,t){let s="WebSocket connection failed";const r=[],n=e?.message||(e instanceof Error?e.message:null)||"object"==typeof e&&e.error&&e.error.message||null;return n&&(s+=`: ${n}`),t&&(t.url&&(s+=` (URL: ${t.url})`),t.timeout&&(s+=` (timeout: ${t.timeout}ms)`)),r.push("Check network connectivity and firewall settings"),r.push("Verify WebSocket URL is correct and accessible"),t&&t.url&&(t.url.startsWith("ws://")&&r.push("Consider using secure WebSocket (wss://) for production"),(t.url.includes("localhost")||t.url.includes("127.0.0.1"))&&r.push("Ensure local server is running if connecting to localhost")),t&&t.timeout&&r.push("Try increasing connection timeout if network is slow"),{message:s,suggestions:r}}formatPayloadSizeError(e,t,s){const r=Math.ceil(e/1024);let n=`Payload too large: ${r}KB exceeds maximum ${t}KB (${r-t}KB over limit)`;const o=[];if(s&&"object"==typeof s){JSON.stringify(s);if(s.request?.scope?.conversations&&Array.isArray(s.request.scope.conversations)){const e=JSON.stringify(s.request.scope.conversations).length,t=Math.ceil(e/1024);t>10&&(o.push(`Consider reducing conversation history - current size: ~${t}KB`),o.push("Remove older messages or summarize conversation context"))}if(s.request?.resources?.offers&&Array.isArray(s.request.resources.offers)){const e=JSON.stringify(s.request.resources.offers).length,t=Math.ceil(e/1024);t>5&&o.push(`Consider reducing product offers data - current size: ~${t}KB`)}if(s.session?.channel?.metadata&&Array.isArray(s.session.channel.metadata)){const e=JSON.stringify(s.session.channel.metadata).length,t=Math.ceil(e/1024);t>2&&o.push(`Consider reducing metadata array - current size: ~${t}KB`)}}return 0===o.length&&(o.push("Remove unused fields from request payload"),o.push("Consider paginating large datasets"),o.push("Use shorter field values where possible")),{message:n,suggestions:o}}formatTokenProviderError(e,t){let s="Failed to obtain WebSocket token from tokenProvider()";const r=[];return e&&(e.message?s+=`: ${e.message}`:"string"==typeof e&&(s+=`: ${e}`),"TypeError"===e.name&&e.message?.includes("fetch")?(r.push("Check if tokenProvider endpoint is accessible"),r.push("Verify CORS settings allow requests to token endpoint")):e.message?.includes("404")||e.message?.includes("Not Found")?(r.push("Verify tokenProvider endpoint URL is correct"),r.push("Ensure backend token endpoint is implemented")):e.message?.includes("401")||e.message?.includes("403")?(r.push("Check authentication/authorization for token endpoint"),r.push("Verify user session or credentials are valid")):e.message?.includes("timeout")&&r.push("Token provider request timed out - check network or server response time")),t&&t.tokenUrl&&(s+=` (endpoint: ${t.tokenUrl})`),0===r.length&&(r.push("Verify tokenProvider function implementation"),r.push("Check backend token endpoint is running and accessible"),r.push("Review browser console for network errors")),{message:s,suggestions:r}}handleError(e,t,s,r=null,n=[],o=null){const i=new z({category:e,code:t,message:s,details:r});n&&(i.suggestions=n),o&&(i.correlationId=o),0===this.listenerCount(P.ERROR)&&0===this.listenerCount(W.ERROR)&&(this.options?.logger?.error||console.error)(`[Optave SDK] ${t}: ${s}`),this._emitError(i)}send(e,t,s){const r=null!=(this.WebSocketImpl&&this.WebSocketImpl.OPEN)?this.WebSocketImpl.OPEN:1;if(!this.wss||this.wss.readyState!==r){const e=this.wss?this.wss.readyState:"no connection";return void this.handleError(U.WEBSOCKET,"WEBSOCKET_NOT_IN_OPEN_STATE",this.formatWebSocketError(new Error("WebSocket not ready for sending"),{readyState:e,action:t}).message)}if(!M.has(t))return void this.handleError(U.VALIDATION,"INVALID_ACTION",`Unsupported action '${t}'. Allowed: ${[...M].join(", ")}`);const n=new Set(["session","request","headers"]);for(const e of Object.keys(s||{}))if(!n.has(e)){const t=[{instancePath:"",keyword:"additionalProperties",params:{additionalProperty:e},message:`must NOT have additional property '${e}'`}];return void this.handleError(U.VALIDATION,"PAYLOAD_SCHEMA_MISMATCH",this.formatValidationErrorMessage(t),t)}const o=this.buildPayload(e,t,s||{}),i=this.validateRequiredFields(o||{},t);if(!i.isValid)return void this.handleError(U.VALIDATION,"REQUIRED_FIELDS_MISSING",`Missing required fields for action '${t}': ${i.errors.join(", ")}`,i.errors);if(this.options.strictValidation){const e=this._validatePayload(o);if(!e.valid)return void this.handleError(U.VALIDATION,"PAYLOAD_SCHEMA_MISMATCH",this.formatValidationErrorMessage(e.errors,"Schema validation failed"),e.errors)}const a=this.buildMessageEnvelope(o,e,t,s?.headers||{}),c=JSON.stringify(a);if(!this.isPayloadSizeValid(c)){const e=c.length;return void this.handleError(U.VALIDATION,"PAYLOAD_TOO_LARGE",this.formatPayloadSizeError(e,L.MAX_PAYLOAD_SIZE_KB,a).message,L.MAX_PAYLOAD_SIZE_KB)}this.wss.send(c)}adjust(e){return this.send("message","adjust",e)}elevate(e){return this.send("message","elevate",e)}interaction(e){return this.send("message","interaction",e)}reception(e){return this.send("message","reception",e)}customerInteraction(e){return this.deprecate("method.customerInteraction","[Deprecation] 'customerInteraction' is deprecated; use 'interaction' instead."),this.send("message","customerInteraction",e)}summarize(e){return this.send("message","summarize",e)}translate(e){return this.send("message","translate",e)}recommend(e){return this.send("message","recommend",e)}insights(e){return this.send("message","insights",e)}_registerPending(e,t,s,r,n){let o=null;s>0&&(o=setTimeout(()=>{if(this._pending.has(e)){const r=this._pending.get(e);r&&!r._handled&&(this._pending.delete(e),r._handled=!0,n({category:U.WEBSOCKET,code:"REQUEST_TIMEOUT",message:`Request timed out after ${s}ms`,details:{correlationId:e,action:t},correlationId:e}))}},s)),this._pending.set(e,{resolve:r,reject:n,timer:o,action:t,_handled:!1})}_promiseSend(e,t,s={},r={}){let n,o,i;const a=new Promise((a,c)=>{o=a,i=c;const d="number"==typeof r.timeoutMs?r.timeoutMs:"number"==typeof r.timeout?r.timeout:this.options.requestTimeoutMs;if(!this.wss||this.wss.readyState!==WebSocket.OPEN){if(d<=0)return void c({category:U.WEBSOCKET,code:"WEBSOCKET_NOT_IN_OPEN_STATE",message:"WebSocket not open",details:null});const r=this.buildPayload(e,t,s),o=this.buildMessageEnvelope(r,e,t,s?.headers||{});return n=o.headers.correlationId,void this._registerPending(n,t,d,a,c)}if(!M.has(t))return void c({category:U.VALIDATION,code:"INVALID_ACTION",message:`Unsupported action '${t}'.`,details:{allowed:[...M]}});const u=new Set(["session","request","headers"]);for(const e of Object.keys(s||{}))if(!u.has(e)){const t=[{instancePath:"",keyword:"additionalProperties",params:{additionalProperty:e},message:`must NOT have additional property '${e}'`}];return void c({category:U.VALIDATION,code:"PAYLOAD_SCHEMA_MISMATCH",message:this.formatValidationErrorMessage(t),details:t})}const l=this.buildPayload(e,t,s),p=this.validateRequiredFields(l,t);if(!p.isValid)return void c({category:U.VALIDATION,code:"REQUIRED_FIELDS_MISSING",message:`Missing required fields for action '${t}'`,details:p.errors});if(this.options.strictValidation){const e=k(l);if(!e.valid)return void c({category:U.VALIDATION,code:"PAYLOAD_SCHEMA_MISMATCH",message:this.formatValidationErrorMessage(e.errors,"Schema validation failed"),details:e.errors})}const h=this.buildMessageEnvelope(l,e,t,s?.headers||{});n=h.headers.correlationId,this._registerPending(n,t,d,a,c);const m=JSON.stringify(h);if(!this.isPayloadSizeValid(m)){const e=m.length,t=this.formatPayloadSizeError(e,L.MAX_PAYLOAD_SIZE_KB,h).message;return void c({category:U.VALIDATION,code:"PAYLOAD_TOO_LARGE",message:t,details:{maxKb:L.MAX_PAYLOAD_SIZE_KB}})}try{this.wss.send(m)}catch(e){if(this._pending.has(n)){const e=this._pending.get(n);e.timer&&clearTimeout(e.timer),e._handled=!0,this._pending.delete(n)}c({category:U.WEBSOCKET,code:"SEND_FAILED",message:"Failed to send over WebSocket",details:e,correlationId:n})}});return a.correlationId=n,a}adjustAsync(e,t){return this._promiseSend("message","adjust",e,t)}elevateAsync(e,t){return this._promiseSend("message","elevate",e,t)}interactionAsync(e,t){return this._promiseSend("message","interaction",e,t)}receptionAsync(e,t){return this._promiseSend("message","reception",e,t)}customerInteractionAsync(e,t){return this.deprecate("method.customerInteractionAsync","[Deprecation] 'customerInteractionAsync' is deprecated; use 'interactionAsync' instead."),this._promiseSend("message","customerInteraction",e,t)}summarizeAsync(e,t){return this._promiseSend("message","summarize",e,t)}translateAsync(e,t){return this._promiseSend("message","translate",e,t)}recommendAsync(e,t){return this._promiseSend("message","recommend",e,t)}insightsAsync(e,t){return this._promiseSend("message","insights",e,t)}cancelRequest(e){if(this._pending.has(e)){const t=this._pending.get(e);return t.timer&&clearTimeout(t.timer),t._handled=!0,this._pending.delete(e),setTimeout(()=>{t.reject({category:U.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled",details:{correlationId:e},correlationId:e})},0),!0}return!1}cancelPendingRequests(e=!1){if(!this._pending)return 0;const t=this._pending.size,s=[...this._pending.entries()];for(const[t,r]of s)r.timer&&clearTimeout(r.timer),r._handled=!0,e?r.reject({category:U.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled during cleanup",details:{correlationId:t},correlationId:t}):queueMicrotask(()=>{r.reject({category:U.WEBSOCKET,code:"REQUEST_CANCELLED",message:"Request was cancelled",details:{correlationId:t},correlationId:t})});return this._pending.clear(),t}cleanup(){if(this.closeConnection(),this.cancelPendingRequests(!0),this._deprecatedKeys&&this._deprecatedKeys.clear(),void 0!==this._warnedQueryToken&&delete this._warnedQueryToken,this._events)for(const e in this._events)delete this._events[e];this.removeAllListeners(),this._events=null,this._eventsCount=null,this._maxListeners=null;if(this.constructor._preservedJSDOM&&this.constructor._preservedJSDOM.dom)try{const e=this.constructor._preservedJSDOM.dom.window;e&&"function"==typeof e.close&&e.close(),delete this.constructor._preservedJSDOM}catch(e){}this._validatePayload=null,this._validateMessageEnvelope=null,this._emitError=null,this._ensureWebSocketImpl=null,this._handleInbound=null,this._promiseSend=null,this._registerPending=null,this._warnOnce=null,this.options=null,this.WebSocketImpl=null,this.wss=null,this.sessionId=null,this._pending=null,this._deprecatedKeys=null,this._silenceDeprecations=null,this._events=null,this._eventsCount=null,this._maxListeners=null}removeAllListeners(t){try{e.prototype.removeAllListeners.call(this,t)}catch(e){t?this._events&&this._events[t]&&(delete this._events[t],this._eventsCount=Math.max(0,this._eventsCount-1)):(this._events=Object.create(null),this._eventsCount=0)}return this}static get buildFlags(){const e="browser-esm";return{SALESFORCE_BUILD:"undefined"!=typeof __SALESFORCE_BUILD__&&__SALESFORCE_BUILD__,INCLUDE_WS_REQUIRE:!1,SDK_VERSION:"3.2.1",WEBPACK_BUILD_TARGET:e,WEBPACK_BUILD_TARGET_NORMALIZED:K.normalize(e),BUILD_TARGET_INFO:K.getInfo(e)}}}const J=Y;export{J as default};